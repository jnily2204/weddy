
import React, { useState, useEffect, useRef, useMemo } from 'react';
import { APP_ID, utils, db } from '../../core/firebase';
import { doc, setDoc, updateDoc, onSnapshot, getDoc } from "firebase/firestore";
import { Icons, Modal } from '../../components/UI';
import type { User } from 'firebase/auth';

// --- HELPER FUNCTIONS ---
const getDaysLeft = (d: string | undefined) => { // Cho phÃ©p nháº­n undefined Ä‘á»ƒ trÃ¡nh lá»—i Type
    if (!d || d === "ChÆ°a Ä‘áº·t") return "---";
    const diff = Math.ceil((new Date(d).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
    return diff > 0 ? `${diff} NGÃ€Y Ná»®A` : (diff === 0 ? "HÃ”M NAY" : "ÄÃƒ QUA");
};

// --- DEFINING TYPES ---
interface Task { id: number; title: string; status: 'done' | 'pending'; cost: number; paid: number; tag: string; paidBy?: string; }
interface Guest { id: number; name: string; relationship: string; phone: string; }
interface Activity { text: string; time: string; }
interface WeddingData { tasks: Task[]; guests: Guest[]; budgetLimit: number; weddingId: string; activities: Activity[]; }
interface UserProfile { name?: string; email?: string; weddingId?: string; isSetupComplete?: boolean; role?: string; budget?: number; location?: string; partnerName?: string; weddingDate?: string; venue?: string; preWedding?: string; vibes?: string[]; engagementDate?: string; }
interface WizardStep { title: string; subtitle: string; content: React.ReactNode; }

// --- COMPONENTS ---

// 1. GettingStartedWizard
const GettingStartedWizard = ({ onComplete, onSkip }: { onComplete: (d: any) => void, onSkip: () => void }) => {
    const [step, setStep] = useState(0);
    const [data, setData] = useState<any>({ role: "", partnerName: "", engagementDate: "", weddingDate: "", location: "", venue: "", preWedding: "", budget: "", vibes: [] });
    const [isSubmitting, setIsSubmitting] = useState(false);
    const handleNext = () => setStep(prev => prev + 1);
    
    const weddingVibes = [
        { id: 'traditional', label: 'Truyá»n thá»‘ng', icon: 'ğŸ®' }, { id: 'modern', label: 'Hiá»‡n Ä‘áº¡i', icon: 'âœ¨' }, { id: 'luxury', label: 'Sang trá»ng', icon: 'ğŸ’' }, { id: 'rustic', label: 'Má»™c máº¡c', icon: 'ğŸŒ¿' }, { id: 'vintage', label: 'Cá»• Ä‘iá»ƒn', icon: 'ğŸ“·' }, { id: 'minimalist', label: 'Tá»‘i giáº£n', icon: 'âšª' }
    ];
    const toggleVibe = (id: string) => setData((prev: any) => ({ ...prev, vibes: prev.vibes.includes(id) ? prev.vibes.filter((v: string) => v !== id) : [...prev.vibes, id] }));

    const steps: WizardStep[] = [
        { title: "ChÃ o báº¡n,", subtitle: "Báº¡n lÃ  CÃ´ DÃ¢u hay ChÃº Rá»ƒ, vÃ  tÃªn thÃ¢n máº­t cá»§a ngÆ°á»i áº¥y lÃ  gÃ¬?", content: (<div className="space-y-6 mt-6"><div className="grid grid-cols-2 gap-4 font-bold">{["CÃ´ dÃ¢u", "ChÃº rá»ƒ"].map(r => (<button key={r} onClick={() => setData({ ...data, role: r })} className={`p-6 rounded-[2rem] border transition-all shadow-sm ${data.role === r ? 'border-stone-800 bg-stone-800 text-white shadow-xl scale-105' : 'border-white bg-white hover:border-stone-300'}`}>{r}</button>))}</div><input type="text" value={data.partnerName} onChange={e => setData({ ...data, partnerName: e.target.value })} placeholder="TÃªn thÃ¢n máº­t cá»§a ngÆ°á»i áº¥y..." className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-5 text-lg font-bold text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm placeholder:text-stone-300 text-center"/></div>) },
        { title: "Gu cá»§a hai báº¡n?", subtitle: "HÃ£y chá»n nhá»¯ng phong cÃ¡ch Ä‘Ã¡m cÆ°á»›i mÃ  báº¡n yÃªu thÃ­ch", content: (<div className="grid grid-cols-2 gap-4 mt-6 animate-in">{weddingVibes.map(v => (<button key={v.id} onClick={() => toggleVibe(v.id)} className={`p-4 rounded-[1.5rem] border transition-all flex flex-col items-center gap-2 ${data.vibes.includes(v.id) ? 'border-stone-800 bg-stone-100 text-stone-800 shadow-md ring-1 ring-stone-200' : 'border-white bg-white hover:bg-stone-50 text-stone-400'}`}><span className="text-3xl mb-1">{v.icon}</span><span className="text-xs font-black uppercase tracking-widest">{v.label}</span></button>))}</div>) },
        { title: "NgÃ y lÃ nh thÃ¡ng tá»‘t", subtitle: "Hai báº¡n Ä‘Ã£ chá»n Ä‘Æ°á»£c ngÃ y Ä‘áº¹p cho Lá»… Ä‚n Há»i vÃ  Lá»… CÆ°á»›i chÆ°a?", content: (<div className="space-y-6 mt-6"><div><label className="block text-xs font-black uppercase tracking-widest text-stone-400 mb-2">Lá»… Ä‚n Há»i (ÄÃ­nh hÃ´n)</label><input type="date" value={data.engagementDate} onChange={e => setData({ ...data, engagementDate: e.target.value })} className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-4 text-lg font-bold text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm text-center uppercase tracking-widest"/></div><div><label className="block text-xs font-black uppercase tracking-widest text-stone-400 mb-2">Lá»… CÆ°á»›i (ThÃ nh hÃ´n)</label><input type="date" value={data.weddingDate} onChange={e => setData({ ...data, weddingDate: e.target.value })} className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-4 text-lg font-bold text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm text-center uppercase tracking-widest"/></div></div>) },
        { title: "NÆ¡i diá»…n ra", subtitle: "ÄÃ¡m cÆ°á»›i sáº½ diá»…n ra táº¡i Tá»‰nh/ThÃ nh phá»‘ nÃ o?", content: (<div className="mt-8"><input type="text" value={data.location} onChange={e => setData({ ...data, location: e.target.value })} placeholder="Vd: TP. Há»“ ChÃ­ Minh, HÃ  Ná»™i..." className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-5 text-xl font-bold text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm placeholder:text-stone-300 text-center"/></div>) },
        { title: "Äá»‹a Ä‘iá»ƒm tiá»‡c", subtitle: "Báº¡n Ä‘Ã£ nháº¯m Ä‘Æ°á»£c NhÃ  hÃ ng/KhÃ¡ch sáº¡n cá»¥ thá»ƒ nÃ o chÆ°a?", content: (<div className="mt-8"><input type="text" value={data.venue} onChange={e => setData({ ...data, venue: e.target.value })} placeholder="Nháº­p tÃªn nhÃ  hÃ ng (náº¿u cÃ³)..." className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-5 text-xl font-bold text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm placeholder:text-stone-300 text-center"/></div>) },
        { title: "LÆ°u giá»¯ khoáº£nh kháº¯c", subtitle: "Hai báº¡n dá»± Ä‘á»‹nh chá»¥p áº£nh Pre-wedding á»Ÿ Ä‘Ã¢u?", content: (<div className="mt-8"><input type="text" value={data.preWedding} onChange={e => setData({ ...data, preWedding: e.target.value })} placeholder="Vd: Studio, ÄÃ  Láº¡t, HÃ n Quá»‘c..." className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-5 text-xl font-bold text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm placeholder:text-stone-300 text-center"/></div>) },
        { title: "NgÃ¢n sÃ¡ch dá»± kiáº¿n?", subtitle: "Con sá»‘ tá»‘i Ä‘a mÃ  hai báº¡n muá»‘n chi cho Ä‘Ã¡m cÆ°á»›i nÃ y lÃ  bao nhiÃªu?", content: (<div className="mt-8"><div className="relative"><input type="text" value={data.budget} onChange={e => setData({ ...data, budget: utils.formatInput(e.target.value) })} placeholder="300.000.000" className="w-full bg-white border-0 ring-1 ring-stone-200 rounded-[1.5rem] px-6 py-5 pl-8 pr-20 text-3xl font-black text-stone-700 focus:ring-2 focus:ring-stone-500 outline-none shadow-sm placeholder:text-stone-200 text-center"/><div className="absolute right-8 top-1/2 -translate-y-1/2 text-stone-400 font-bold text-sm uppercase tracking-widest">VNÄ</div></div></div>) }
    ];
    const current = steps[step];
    const handleFinish = async () => { if (isSubmitting) return; setIsSubmitting(true); try { await onComplete({...data, budget: utils.parseInput(data.budget)}); } catch (e) { setIsSubmitting(false); alert("CÃ³ lá»—i xáº£y ra, vui lÃ²ng thá»­ láº¡i."); } };
    return (
        <div className="fixed inset-0 z-[200] bg-[#F0EBE5]/95 backdrop-blur-xl flex flex-col animate-in overflow-y-auto">
            <div className="absolute top-6 right-6 z-50"><button onClick={onSkip} className="text-stone-400 font-bold text-xs uppercase tracking-widest hover:text-stone-600 transition-colors px-4 py-2 bg-white/50 rounded-full hover:bg-white">Bá» qua táº¥t cáº£</button></div>
            <div className="flex-1 flex flex-col justify-center px-6 max-w-lg mx-auto w-full text-center py-10">
                <div className="mb-8"><div className="flex justify-center gap-1.5 mb-8">{steps.map((_, i) => (<div key={i} className={`h-1.5 rounded-full transition-all duration-700 ${i <= step ? 'bg-stone-800 w-8' : 'bg-stone-300/50 w-2'}`}></div>))}</div><h2 className="text-3xl md:text-4xl font-title font-bold tracking-tighter text-stone-800 mb-3">{current.title}</h2><p className="text-stone-500 text-base font-medium leading-relaxed">{current.subtitle}</p></div>
                <div className="min-h-[160px] flex flex-col justify-center mb-8">{current.content}</div>
                <div className="space-y-4">{step < steps.length - 1 ? (<><button onClick={handleNext} disabled={step === 0 && !data.role} className="w-full py-5 bg-stone-800 text-white rounded-full text-sm font-black uppercase tracking-[0.2em] shadow-xl hover:bg-stone-700 disabled:opacity-30 disabled:cursor-not-allowed transition-all active:scale-95">Tiáº¿p tá»¥c</button><button onClick={handleNext} className="text-stone-400 text-xs font-bold uppercase tracking-widest hover:text-stone-600 transition-colors p-2">Bá» qua cÃ¢u nÃ y</button></>) : (<><button onClick={handleFinish} disabled={isSubmitting} className="w-full py-5 bg-emerald-700 text-white rounded-full text-sm font-black uppercase tracking-[0.2em] shadow-xl hover:bg-emerald-800 disabled:opacity-70 transition-all active:scale-95 flex items-center justify-center gap-3">{isSubmitting ? <span className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></span> : null} {isSubmitting ? 'Äang xá»­ lÃ½...' : 'HoÃ n táº¥t thiáº¿t láº­p'}</button><button onClick={handleFinish} className="text-stone-400 text-xs font-bold uppercase tracking-widest hover:text-stone-600 transition-colors p-2">Bá» qua cÃ¢u nÃ y</button></>)}</div>
            </div>
        </div>
    );
};

// 2. AccountView
export const AccountView = ({ user }: { user: User }) => {
    const [data, setData] = useState({ name: "", role: "CÃ´ dÃ¢u", partnerName: "", date: "", location: "", budget: "" });
    const [loading, setLoading] = useState(true);
    const [msg, setMsg] = useState("");
    useEffect(() => {
        const init = async () => {
            if (!user) return;
            try {
                const profileRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'main');
                const pSnap = await getDoc(profileRef);
                if (pSnap.exists()) {
                    const p = pSnap.data();
                    let b = "";
                    if (p.weddingId) {
                        const wSnap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'weddings', p.weddingId));
                        if (wSnap.exists()) { const limit = wSnap.data().budgetLimit; b = limit ? utils.formatInput(limit) : ""; }
                    }
                    setData({ name: p.name || user.displayName || "", role: p.role || "CÃ´ dÃ¢u", partnerName: p.partnerName || "", date: p.weddingDate || "", location: p.location || "", budget: b });
                }
            } catch (e) { console.error(e); }
            setLoading(false);
        };
        init();
    }, [user]);

    const handleSave = async () => {
        setMsg("Äang lÆ°u...");
        try {
            const profileRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'main');
            await updateDoc(profileRef, { name: data.name, role: data.role, partnerName: data.partnerName, weddingDate: data.date, location: data.location });
            const pSnap = await getDoc(profileRef);
            const wid = pSnap.data()?.weddingId;
            if(wid) { await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'weddings', wid), { budgetLimit: utils.parseInput(data.budget) }); }
            setMsg("ÄÃ£ cáº­p nháº­t thÃ nh cÃ´ng!"); setTimeout(() => setMsg(""), 3000);
        } catch (e) { setMsg("Lá»—i khi lÆ°u."); }
    };
    if (loading) return <div className="pt-40 text-center"><div className="w-8 h-8 border-4 border-stone-200 border-t-stone-800 rounded-full animate-spin mx-auto"></div></div>;
    return (
        <div className="pt-32 pb-32 px-4 max-w-2xl mx-auto animate-in">
            <div className="text-center mb-12"><div className="w-24 h-24 bg-stone-200 rounded-full flex items-center justify-center mx-auto mb-6 text-4xl font-title font-bold text-stone-500 uppercase shadow-inner border-4 border-white">{data.name ? data.name.charAt(0) : (user.email ? user.email.charAt(0).toUpperCase() : '?')}</div><h2 className="text-3xl font-title font-bold text-stone-800 uppercase tracking-wide mb-2">{data.name}</h2><p className="text-stone-400 text-sm font-medium tracking-wide">{user.email}</p></div>
            <div className="bg-white p-8 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-xl shadow-stone-200/50 space-y-8">
                <div className="flex items-center gap-3 border-b border-stone-100 pb-4"><div className="w-8 h-8 rounded-full bg-stone-100 flex items-center justify-center text-stone-500"><Icons.Edit size={14}/></div><h3 className="text-lg font-bold text-stone-700 uppercase tracking-widest">ThÃ´ng tin Ä‘Ã¡m cÆ°á»›i</h3></div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-3 ml-1">Vai trÃ²</label><div className="relative"><select value={data.role} onChange={e => setData({...data, role: e.target.value})} className="w-full p-4 bg-stone-50 rounded-2xl font-bold text-stone-700 outline-none appearance-none border border-transparent focus:border-stone-200 focus:bg-white transition-all uppercase text-sm"><option value="CÃ´ dÃ¢u">CÃ´ dÃ¢u</option><option value="ChÃº rá»ƒ">ChÃº rá»ƒ</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={14} className="rotate-90" /></div></div></div><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-3 ml-1">TÃªn ngÆ°á»i áº¥y</label><input type="text" value={data.partnerName} onChange={e => setData({...data, partnerName: e.target.value})} className="w-full p-4 bg-stone-50 rounded-2xl font-bold text-stone-700 outline-none border border-transparent focus:border-stone-200 focus:bg-white transition-all text-sm uppercase placeholder:text-stone-300" placeholder="ChÆ°a nháº­p" /></div></div>
                <div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-3 ml-1">NgÃ y cÆ°á»›i</label><input type="date" value={data.date} onChange={e => setData({...data, date: e.target.value})} className="w-full p-4 bg-stone-50 rounded-2xl font-bold text-stone-700 outline-none border border-transparent focus:border-stone-200 focus:bg-white transition-all text-sm uppercase" /></div>
                <div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-3 ml-1">Äá»‹a Ä‘iá»ƒm tá»• chá»©c</label><input type="text" value={data.location} onChange={e => setData({...data, location: e.target.value})} className="w-full p-4 bg-stone-50 rounded-2xl font-bold text-stone-700 outline-none border border-transparent focus:border-stone-200 focus:bg-white transition-all text-sm uppercase placeholder:text-stone-300" placeholder="ChÆ°a nháº­p" /></div>
                <div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-3 ml-1">NgÃ¢n sÃ¡ch dá»± kiáº¿n (VNÄ)</label><input type="text" value={data.budget} onChange={e => setData({...data, budget: utils.formatInput(e.target.value)})} className="w-full p-4 bg-stone-50 rounded-2xl font-bold text-stone-700 outline-none border border-transparent focus:border-stone-200 focus:bg-white transition-all text-sm uppercase placeholder:text-stone-300" placeholder="0" /></div>
                <div className="pt-4"><button onClick={handleSave} className="w-full py-5 bg-stone-800 text-white rounded-2xl font-black uppercase tracking-[0.2em] text-xs hover:bg-stone-700 active:scale-95 transition-all shadow-lg">{msg || "LÆ°u thay Ä‘á»•i"}</button></div>
            </div>
        </div>
    );
};

// 3. PlannerOverview
const PlannerOverview = ({ spentAmount, completedTasks, totalTasks, guestCount, budgetLimit, role, activities, onInvite, onEditBudget, onOpenGuests }: any) => {
    const percentage = Math.min((spentAmount / (budgetLimit || 300000000)) * 100, 100);
    return (
        <div className="max-w-6xl mx-auto space-y-8 animate-in text-stone-700 text-left px-2 md:px-0">
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8">
                <div className="lg:col-span-2 space-y-6 md:space-y-8">
                    <div className="bg-white/40 backdrop-blur-md p-6 rounded-[2.5rem] border border-stone-200/50 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm text-stone-800"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-rose-100/50 rounded-full flex items-center justify-center text-rose-500 shrink-0"><Icons.Heart size={24} fill="currentColor"/></div><div><h4 className="font-title font-bold text-lg">VÃ­ chung Ä‘Ã´i mÃ¬nh</h4><p className="text-sm text-stone-400">Káº¿t ná»‘i vÃ  Ä‘á»“ng bá»™ káº¿ hoáº¡ch vá»›i báº¡n Ä‘á»i.</p></div></div><button onClick={onInvite} className="w-full md:w-auto px-8 py-4 bg-stone-500 text-white rounded-full text-xs font-black uppercase tracking-widest shadow-sm hover:bg-stone-600 transition-all flex items-center justify-center gap-2"><Icons.Share size={16}/> Má»i báº¡n Ä‘á»i</button></div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="bg-white/80 p-6 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48 text-left"><div className="flex justify-between items-start text-left uppercase tracking-widest text-xs font-bold text-stone-400"><span>Tiáº¿n Ä‘á»™</span><div className="w-10 h-10 bg-stone-50/50 rounded-2xl flex items-center justify-center text-stone-300"><Icons.Check size={20}/></div></div><div><div className="flex items-baseline gap-2 mb-3 text-left font-title font-bold text-stone-600 text-4xl md:text-5xl"><span>{completedTasks}</span><span className="text-stone-300 uppercase text-xs">/ {totalTasks} viá»‡c</span></div><div className="w-full h-2 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-stone-500 transition-all duration-700" style={{width: `${totalTasks > 0 ? (completedTasks/totalTasks)*100 : 0}%`}}></div></div></div></div>
                        <div onClick={onOpenGuests} className="bg-white/80 p-6 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48 cursor-pointer hover:border-stone-300 transition-all active:scale-[0.98]"><div className="flex justify-between items-start text-left uppercase tracking-widest text-xs font-bold text-stone-400"><span>KhÃ¡ch má»i</span><div className="w-10 h-10 bg-stone-50/50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Users size={20}/></div></div><div className="flex items-baseline gap-2 text-stone-700 text-left font-title font-bold text-5xl md:text-6xl"><span>{guestCount}</span><span className="text-stone-300 font-bold uppercase text-xs">NgÆ°á»i</span></div></div>
                    </div>
                    <div className="bg-stone-500 p-6 md:p-12 rounded-[3rem] text-white relative overflow-hidden shadow-xl group"><div className="absolute top-0 right-0 w-80 h-80 bg-stone-400 rounded-full blur-[150px] opacity-20 -translate-y-1/2 translate-x-1/2 group-hover:opacity-40 transition-opacity duration-700"></div><div className="relative z-10 text-left"><h3 className="text-xs font-black uppercase tracking-[0.3em] text-white/70 mb-6 md:mb-8 text-left">TÃ i chÃ­nh tá»•ng quÃ¡t ({role || 'Báº¡n'})</h3><div className="flex flex-col md:flex-row justify-between gap-6 md:gap-8"><div className="flex-1 text-white text-left"><div className="text-xs uppercase font-black text-white/30 mb-2 text-left">ÄÃ£ chi tiÃªu</div><div className="text-5xl md:text-7xl font-title font-bold tracking-tighter text-left tabular-nums">{utils.formatMoney(spentAmount)}</div><div className="w-full h-2 bg-white/10 rounded-full overflow-hidden mt-6 mb-4"><div className="h-full bg-white transition-all duration-700" style={{width: `${percentage}%`}}></div></div><div className="flex items-center gap-2 group/budget inline-flex cursor-pointer text-white/80" onClick={onEditBudget}><p className="text-sm font-black uppercase tracking-widest font-bold">NgÃ¢n sÃ¡ch: {utils.formatMoney(budgetLimit)}</p><Icons.Edit size={16} className="text-white/20 group-hover/budget:text-white transition-colors" /></div></div><div className="md:w-48 flex flex-col gap-4 justify-center text-white"><div className="bg-white/10 backdrop-blur-sm p-6 rounded-3xl border border-white/5 text-center md:text-left shadow-sm shadow-inner"><p className="text-xs font-black text-white/40 uppercase mb-2 text-left">CÃ²n láº¡i</p><p className="text-2xl font-title font-bold text-left">{utils.formatMoney((budgetLimit || 300000000) - spentAmount)}</p></div></div></div></div></div>
                </div>
                <div className="bg-white/60 backdrop-blur-md p-6 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-sm h-full flex flex-col"><h3 className="text-sm font-black uppercase tracking-[0.2em] mb-8 text-stone-700 border-b border-stone-100 pb-6 font-bold text-left uppercase">Hoáº¡t Ä‘á»™ng gáº§n Ä‘Ã¢y</h3><div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar max-h-[400px] md:max-h-[500px]">{activities?.length > 0 ? activities.map((act: Activity, i: number) => (<div key={i} className="flex gap-4 items-start group animate-in text-left"><div className="w-10 h-10 bg-stone-50 rounded-2xl flex items-center justify-center shrink-0 group-hover:bg-stone-500 group-hover:text-white transition-colors shadow-sm"><Icons.ArrowUpRight size={18} className="text-stone-300 group-hover:text-white" /></div><div className="text-left text-stone-600"><p className="text-sm font-bold leading-snug text-left">{act.text}</p><p className="text-xs font-black text-stone-300 uppercase tracking-widest mt-1 text-left">{act.time}</p></div></div>)) : <p className="text-base text-stone-300 italic font-medium text-center">ChÆ°a cÃ³ thÃ´ng bÃ¡o má»›i.</p>}</div></div>
            </div>
        </div>
    );
};

// 4. PlannerTasks
const PlannerTasks = ({ tasks, onAddTask, onToggleTask, onDeleteTask }: any) => {
    const [isOpen, setIsOpen] = useState(false);
    const [title, setTitle] = useState(""); const [cat, setCat] = useState("Äáº·t tiá»‡c cÆ°á»›i"); const [cost, setCost] = useState("");
    const [pendingPage, setPendingPage] = useState(1); const [donePage, setDonePage] = useState(1);
    const pendingListRef = useRef<HTMLDivElement>(null);
    const doneListRef = useRef<HTMLDivElement>(null);

    const handleAdd = () => { if (title.trim()) { onAddTask({ title: title.trim(), tag: cat, status: "pending", cost: utils.parseInput(cost), paid: 0, id: Date.now() }); setTitle(""); setCost(""); setIsOpen(false); setPendingPage(1); } };
    const pending = tasks?.filter((t: Task) => t.status !== 'done') || [];
    const done = tasks?.filter((t: Task) => t.status === 'done') || [];
    const currentPending = pending.slice((pendingPage - 1) * 5, pendingPage * 5);
    const currentDone = done.slice((donePage - 1) * 3, donePage * 3);
    
    // Pagination effect
    useEffect(() => { if(pendingListRef.current && pendingPage > 1) pendingListRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, [pendingPage]);
    useEffect(() => { if(doneListRef.current && donePage > 1) doneListRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, [donePage]);

    return (
        <div className="max-w-6xl mx-auto space-y-8 animate-in text-stone-700 text-left px-2 md:px-0">
             <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4"><div className="text-left"><h3 className="text-3xl font-title font-bold text-stone-700 uppercase tracking-tighter">Danh sÃ¡ch cÃ´ng viá»‡c</h3><p className="text-xs font-bold text-stone-400 uppercase tracking-widest mt-1">{pending.length} viá»‡c cáº§n lÃ m</p></div><button onClick={() => setIsOpen(true)} className="group w-full md:w-auto flex items-center justify-center gap-3 px-8 py-4 bg-stone-800 text-white rounded-full text-xs font-black uppercase tracking-widest hover:bg-stone-700 transition-all active:scale-95 shadow-xl hover:shadow-2xl"><span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors"><Icons.Plus size={12} /></span> ThÃªm viá»‡c má»›i</button></div>
             <div className="space-y-4 animate-in" key={pendingPage} ref={pendingListRef}>{pending.length > 0 ? currentPending.map((t: Task) => (<div key={t.id} onClick={() => onToggleTask(t.id)} className="group p-6 bg-white rounded-[2rem] border border-stone-100 hover:border-stone-300 hover:shadow-lg transition-all cursor-pointer flex items-center gap-6 relative"><div className="w-8 h-8 rounded-xl border-2 border-stone-200 group-hover:border-stone-400 group-hover:bg-stone-50 transition-all shrink-0"></div><div className="flex-1"><h4 className="font-bold text-stone-800 text-lg leading-tight uppercase">{t.title}</h4><span className="inline-block mt-2 text-[10px] font-black uppercase tracking-wider text-stone-400">{t.tag}</span></div><button onClick={(e) => { e.stopPropagation(); onDeleteTask(t.id); }} className="w-10 h-10 flex items-center justify-center rounded-full text-stone-300 hover:bg-rose-50 hover:text-rose-500 transition-all absolute top-4 right-4 md:relative md:top-0 md:right-0"><Icons.Trash size={20} /></button></div>)) : <div className="py-24 text-center border-2 border-dashed border-stone-200 rounded-[2.5rem] bg-white/50"><p className="text-stone-400 font-bold uppercase text-sm tracking-widest">Má»i viá»‡c Ä‘Ã£ hoÃ n táº¥t! âœ¨</p></div>}</div>
             {done.length > 0 && (<div className="pt-10 opacity-60 hover:opacity-100 transition-opacity duration-300" ref={doneListRef}><h4 className="mb-6 text-xs font-black uppercase tracking-widest text-stone-400">ÄÃ£ hoÃ n thÃ nh ({done.length})</h4><div className="space-y-3 animate-in" key={donePage}>{currentDone.map((t: Task) => (<div key={t.id} className="p-5 bg-stone-50 rounded-[1.5rem] border border-stone-100 flex items-center justify-between gap-4 text-stone-400 transition-colors"><div className="flex items-center gap-5 cursor-pointer flex-1" onClick={() => onToggleTask(t.id)}><div className="w-8 h-8 rounded-xl bg-stone-300 flex items-center justify-center text-white shrink-0"><Icons.Check size={16} /></div><h4 className="text-base font-bold line-through uppercase">{t.title}</h4></div></div>))}</div>
                {/* --- ÄÃ£ thÃªm nÃºt phÃ¢n trang cho pháº§n ÄÃ£ hoÃ n thÃ nh (Fix lá»—i warning setDonePage) --- */}
                {Math.ceil(done.length/3) > 1 && (
                    <div className="flex justify-center items-center gap-4 pt-4">
                        <button onClick={() => setDonePage(prev => Math.max(prev - 1, 1))} disabled={donePage === 1} className="w-10 h-10 rounded-full flex items-center justify-center bg-white border border-stone-200 text-stone-500 hover:bg-stone-50 disabled:opacity-30 transition-all shadow-sm"><Icons.ChevronRight size={16} className="rotate-180" /></button>
                        <span className="text-xs font-black uppercase tracking-widest text-stone-400">Trang {donePage}</span>
                        <button onClick={() => setDonePage(prev => Math.min(prev + 1, Math.ceil(done.length/3)))} disabled={donePage === Math.ceil(done.length/3)} className="w-10 h-10 rounded-full flex items-center justify-center bg-white border border-stone-200 text-stone-500 hover:bg-stone-50 disabled:opacity-30 transition-all shadow-sm"><Icons.ChevronRight size={16} /></button>
                    </div>
                )}
             </div>)}
             <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="CÃ´ng viá»‡c má»›i"><div className="space-y-6 pt-2"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">TÃªn cÃ´ng viá»‡c</label><input type="text" value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-all text-base font-bold shadow-inner uppercase" placeholder="VD: Äáº¶T HOA CÆ¯á»šI" autoFocus /></div><div className="grid grid-cols-2 gap-6"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">PhÃ¢n loáº¡i</label><div className="relative"><select value={cat} onChange={e=>setCat(e.target.value)} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl text-base font-bold uppercase appearance-none focus:outline-none focus:border-stone-400 focus:bg-white transition-all shadow-inner"><option value="Äáº·t tiá»‡c cÆ°á»›i">Tiá»‡c cÆ°á»›i</option><option value="Chá»¥p áº£nh">Chá»¥p áº£nh</option><option value="Trang phá»¥c">Trang phá»¥c</option><option value="KhÃ¡c">KhÃ¡c</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={16} className="rotate-90" /></div></div></div><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">Dá»± chi (VNÄ)</label><input type="text" value={cost} onChange={e=>setCost(utils.formatInput(e.target.value))} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-all text-base font-bold shadow-inner" placeholder="0" /></div></div><div className="pt-8 border-t border-stone-50"><button onClick={handleAdd} className="w-full py-5 bg-stone-800 text-white rounded-full font-black uppercase text-sm tracking-[0.2em] shadow-xl hover:bg-stone-700 active:scale-95 transition-all flex items-center justify-center gap-3"><Icons.Plus size={16} strokeWidth={3}/> LÆ°u láº¡i</button></div></div></Modal>
        </div>
    );
};

// 5. PlannerGuests
const PlannerGuests = ({ guests, onAddGuest, onDeleteGuest }: any) => {
    const [isOpen, setIsOpen] = useState(false);
    const [name, setName] = useState(""); const [rel, setRel] = useState("Báº¡n bÃ¨"); const [phone, setPhone] = useState("");
    const [currentPage, setCurrentPage] = useState(1);
    const itemsPerPage = 10;
    const listRef = useRef<HTMLDivElement>(null);

    const currentGuests = guests?.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
    const handleAdd = () => { if (name.trim()) { onAddGuest({ name: name.trim(), relationship: rel, phone, id: Date.now() }); setName(""); setPhone(""); setIsOpen(false); setCurrentPage(1); } };
    const relationshipColors: any = { "Báº¡n bÃ¨": "bg-blue-50 text-blue-600", "Gia Ä‘Ã¬nh": "bg-rose-50 text-rose-600", "Äá»“ng nghiá»‡p": "bg-purple-50 text-purple-600", "KhÃ¡c": "bg-stone-50 text-stone-600" };
    
    // Pagination Effect
    useEffect(() => { if(listRef.current && currentPage > 1) listRef.current.scrollIntoView({ behavior: 'smooth', block: 'start' }); }, [currentPage]);

    return (
        <div className="max-w-6xl mx-auto space-y-8 animate-in px-2 md:px-0">
            <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4"><div className="text-left w-full md:w-auto"><h3 className="text-3xl font-title font-bold text-stone-700 uppercase tracking-tighter">Danh sÃ¡ch khÃ¡ch má»i</h3><p className="text-xs font-bold text-stone-400 uppercase tracking-widest mt-1">Tá»•ng cá»™ng: <span className="text-stone-700">{guests?.length || 0}</span> ngÆ°á»i</p></div><button onClick={() => setIsOpen(true)} className="group w-full md:w-auto flex items-center justify-center gap-3 px-8 py-4 bg-stone-800 text-white rounded-full text-xs font-black uppercase tracking-widest hover:bg-stone-700 transition-all active:scale-95 shadow-xl hover:shadow-2xl"><span className="w-5 h-5 rounded-full bg-white/20 flex items-center justify-center group-hover:bg-white/30 transition-colors"><Icons.Plus size={12} /></span> ThÃªm khÃ¡ch má»›i</button></div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 animate-in" key={currentPage} ref={listRef}>{guests?.length === 0 ? <div className="col-span-full py-24 text-center border-2 border-dashed border-stone-200 rounded-[2.5rem] bg-white/50"><div className="w-20 h-20 bg-stone-100 rounded-full flex items-center justify-center mx-auto mb-6 text-stone-400 shadow-inner"><Icons.Users size={32} /></div><p className="text-stone-400 font-bold uppercase text-xs tracking-widest">Danh sÃ¡ch trá»‘ng</p></div> : currentGuests?.map((g: Guest) => (<div key={g.id} className="group bg-white p-6 rounded-[2rem] border border-stone-100 hover:border-stone-300 hover:shadow-lg transition-all flex items-center justify-between cursor-default relative"><div className="flex items-center gap-5"><div className={`w-14 h-14 rounded-2xl flex items-center justify-center text-lg font-black uppercase shadow-inner shrink-0 ${relationshipColors[g.relationship] || 'bg-stone-100 text-stone-500'}`}>{g.name.charAt(0)}</div><div className="text-left"><h4 className="font-bold text-stone-700 text-lg leading-tight uppercase">{g.name}</h4><div className="flex items-center gap-2 mt-2 flex-wrap"><span className="text-[10px] font-black uppercase tracking-wider text-stone-400 border border-stone-100 px-3 py-1 rounded-lg bg-stone-50">{g.relationship}</span>{g.phone && <span className="text-[11px] font-bold text-stone-400 tabular-nums tracking-wide">{g.phone}</span>}</div></div></div><button onClick={() => onDeleteGuest(g.id)} className="w-10 h-10 flex items-center justify-center rounded-full text-stone-300 hover:bg-rose-50 hover:text-rose-500 transition-all absolute top-4 right-4 md:relative md:top-0 md:right-0"><Icons.Trash size={20} /></button></div>))}</div>
            <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="ThÃªm khÃ¡ch má»i"><div className="space-y-6 pt-2"><div className="space-y-5 text-left"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">Há» vÃ  tÃªn</label><input type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white focus:shadow-md transition-all text-base font-bold text-stone-700 placeholder:text-stone-300 uppercase" placeholder="NHáº¬P TÃŠN KHÃCH Má»œI..." autoFocus /></div><div className="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">Má»‘i quan há»‡</label><div className="relative"><select value={rel} onChange={e => setRel(e.target.value)} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl appearance-none font-bold text-base text-stone-700 focus:outline-none focus:border-stone-400 focus:bg-white focus:shadow-md transition-all uppercase"><option value="Báº¡n bÃ¨">Báº¡n bÃ¨</option><option value="Gia Ä‘Ã¬nh">Gia Ä‘Ã¬nh</option><option value="Äá»“ng nghiá»‡p">Äá»“ng nghiá»‡p</option><option value="KhÃ¡c">KhÃ¡c</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={16} className="rotate-90" /></div></div></div><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">Sá»‘ Ä‘iá»‡n thoáº¡i</label><input type="text" value={phone} onChange={e => setPhone(utils.formatInput(e.target.value))} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white focus:shadow-md transition-all text-base font-bold text-stone-700 placeholder:text-stone-300 tabular-nums tracking-wider" placeholder="09..." /></div></div></div><div className="pt-8 border-t border-stone-50"><button onClick={handleAdd} className="w-full py-5 bg-stone-800 text-white rounded-full font-black uppercase text-sm tracking-[0.2em] shadow-xl hover:bg-stone-700 active:scale-95 transition-all flex items-center justify-center gap-3"><Icons.Plus size={16} strokeWidth={3} /> LÆ°u khÃ¡ch má»i</button></div></div></Modal>
        </div>
    );
};

// 6. PlannerBudget
const PlannerBudget = ({ tasks, onAddExpense, onDeleteTask }: any) => {
    const [isOpen, setIsOpen] = useState(false); const [activeFilter, setActiveFilter] = useState('all');
    const [title, setTitle] = useState(""); const [cost, setCost] = useState(""); const [paid, setPaid] = useState(""); const [category, setCategory] = useState("Äáº·t tiá»‡c cÆ°á»›i");
    const [currentPage, setCurrentPage] = useState(1);
    const allBudgetTasks = (tasks || []).filter((t: Task) => t.cost > 0);
    const displayTasks = activeFilter === 'all' ? allBudgetTasks : allBudgetTasks.filter((t: Task) => t.paidBy === (activeFilter === 'groom' ? 'ChÃº rá»ƒ' : 'CÃ´ dÃ¢u'));
    const totalBudget = displayTasks.reduce((acc: number, curr: Task) => acc + curr.cost, 0);
    const totalPaid = displayTasks.reduce((acc: number, curr: Task) => acc + (curr.paid || (curr.status === 'done' ? curr.cost : 0)), 0);
    const currentTransactions = displayTasks.slice((currentPage - 1) * 5, currentPage * 5);
    const handleSave = () => { if (title.trim() && cost) { onAddExpense({ title: title.trim(), tag: category, status: utils.parseInput(paid) >= utils.parseInput(cost) ? 'done' : 'pending', cost: utils.parseInput(cost), paid: utils.parseInput(paid), id: Date.now() }); setTitle(""); setCost(""); setPaid(""); setIsOpen(false); setCurrentPage(1); } };
    return (
        <div className="max-w-6xl mx-auto space-y-8 animate-in text-stone-700 px-2 md:px-0">
             <div className="flex justify-center"><div className="bg-stone-100 p-1.5 rounded-full flex gap-1">{[{ id: 'all', label: 'VÃ­ chung' }, { id: 'groom', label: 'ChÃº rá»ƒ' }, { id: 'bride', label: 'CÃ´ dÃ¢u' }].map(f => (<button key={f.id} onClick={() => setActiveFilter(f.id)} className={`px-4 md:px-8 py-3 rounded-full text-xs font-black uppercase tracking-widest transition-all ${activeFilter === f.id ? 'bg-white shadow-md text-stone-800' : 'text-stone-400 hover:text-stone-600'}`}>{f.label}</button>))}</div></div>
             <div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div className="bg-white p-8 rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48"><div className="flex justify-between items-start"><p className="text-xs font-black uppercase tracking-[0.2em] text-stone-400">Dá»± kiáº¿n chi</p><div className="p-3 bg-stone-50 rounded-full text-stone-400"><Icons.DollarSign size={20}/></div></div><p className="text-3xl font-title font-bold text-stone-800 tracking-tighter">{utils.formatMoney(totalBudget)}</p></div><div className="bg-stone-800 p-8 rounded-[2.5rem] shadow-xl flex flex-col justify-between h-48 text-white"><div className="flex justify-between items-start"><p className="text-xs font-black uppercase tracking-[0.2em] text-white/50">ÄÃ£ thanh toÃ¡n</p><div className="p-3 bg-white/10 rounded-full text-white"><Icons.Check size={20}/></div></div><p className="text-3xl font-title font-bold tracking-tighter">{utils.formatMoney(totalPaid)}</p></div><div className="bg-white p-8 rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48"><div className="flex justify-between items-start"><p className="text-xs font-black uppercase tracking-[0.2em] text-stone-400">CÃ²n láº¡i</p><div className="p-3 bg-stone-50 rounded-full text-stone-400"><Icons.Layout size={20}/></div></div><p className={`text-3xl font-title font-bold tracking-tighter ${totalBudget - totalPaid < 0 ? 'text-rose-500' : 'text-stone-800'}`}>{utils.formatMoney(totalBudget - totalPaid)}</p></div></div>
             <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4"><div className="text-left"><h3 className="text-3xl font-title font-bold text-stone-700 uppercase tracking-tighter">Chi tiáº¿t khoáº£n chi</h3></div><button onClick={() => setIsOpen(true)} className="group w-full md:w-auto flex items-center justify-center gap-3 px-8 py-4 bg-stone-200 text-stone-600 hover:bg-stone-300 rounded-full text-xs font-black uppercase tracking-widest transition-all active:scale-95 shadow-sm"><Icons.Plus size={16}/> ThÃªm khoáº£n chi</button></div>
             <div className="space-y-4 animate-in" key={currentPage}>{currentTransactions.map((item: Task) => (<div key={item.id} className="group p-6 bg-white rounded-[2rem] border border-stone-100 hover:border-stone-300 transition-all flex flex-col md:flex-row md:items-center justify-between gap-4 relative"><div className="flex items-center gap-5"><div className={`w-14 h-14 rounded-2xl flex items-center justify-center shrink-0 shadow-inner ${(item.paid || 0) >= item.cost ? 'bg-emerald-50 text-emerald-600' : 'bg-stone-50 text-stone-400'}`}><Icons.DollarSign size={24} /></div><div className="text-left"><h4 className="font-bold text-lg text-stone-700 leading-tight uppercase">{item.title}</h4><div className="flex gap-2 mt-2"><span className="inline-block text-[10px] font-black uppercase tracking-wider text-stone-400 bg-stone-50 px-3 py-1 rounded-lg border border-stone-100">{item.tag}</span></div></div></div><div className="flex flex-col items-end gap-1"><p className="font-bold text-xl text-stone-800 tracking-tight">{utils.formatMoney(item.cost)}</p><div className="flex items-center gap-2">{(item.paid || 0) >= item.cost ? <span className="text-[10px] font-black uppercase tracking-widest text-emerald-600 bg-emerald-50 px-3 py-1.5 rounded-lg">ÄÃ£ xong</span> : <span className="text-[10px] font-black uppercase tracking-widest text-stone-400 bg-stone-50 px-3 py-1.5 rounded-lg">ÄÃ£ tráº£: {utils.formatMoney(item.paid || 0)}</span>}</div></div><button onClick={() => onDeleteTask(item.id)} className="w-10 h-10 flex items-center justify-center rounded-full text-stone-300 hover:bg-rose-50 hover:text-rose-500 transition-all absolute top-4 right-4 md:relative md:top-0 md:right-0"><Icons.Trash size={20} /></button></div>))}</div>
             <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="ThÃªm khoáº£n chi"><div className="space-y-6 pt-2"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">TÃªn khoáº£n chi</label><input type="text" value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-all text-base font-bold uppercase shadow-inner" placeholder="VD: CHá»¤P áº¢NH CÆ¯á»šI" autoFocus /></div><div className="grid grid-cols-1 sm:grid-cols-2 gap-6"><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">Háº¡ng má»¥c</label><div className="relative"><select value={category} onChange={e=>setCategory(e.target.value)} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl text-base font-bold uppercase appearance-none focus:outline-none focus:border-stone-400 focus:bg-white transition-all shadow-inner"><option value="Äáº·t tiá»‡c cÆ°á»›i">Tiá»‡c cÆ°á»›i</option><option value="Chá»¥p áº£nh">Chá»¥p áº£nh</option><option value="Trang phá»¥c">Trang phá»¥c</option><option value="KhÃ¡c">KhÃ¡c</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={16} className="rotate-90" /></div></div></div><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">Sá»‘ tiá»n (VNÄ)</label><input type="text" value={cost} onChange={e=>setCost(utils.formatInput(e.target.value))} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-all text-base font-bold shadow-inner" placeholder="0" /></div></div><div><label className="block text-xs font-black uppercase tracking-[0.2em] text-stone-400 mb-2.5 ml-1">ÄÃ£ tráº£ trÆ°á»›c (VNÄ)</label><input type="text" value={paid} onChange={e=>setPaid(utils.formatInput(e.target.value))} className="w-full p-5 bg-stone-50 border border-stone-100 rounded-2xl focus:outline-none focus:border-stone-400 focus:bg-white transition-all text-base font-bold shadow-inner" placeholder="0" /></div><div className="pt-8 border-t border-stone-50"><button onClick={handleSave} className="w-full py-5 bg-stone-800 text-white rounded-full font-black uppercase text-sm tracking-[0.2em] shadow-xl hover:bg-stone-700 active:scale-95 transition-all flex items-center justify-center gap-3"><Icons.Plus size={16} strokeWidth={3}/> LÆ°u láº¡i</button></div></div></Modal>
        </div>
    );
};

// --- MAIN MODULE EXPORT ---
export const WeddingPlannerModule = ({ currentUser }: { currentUser: User }) => {
    const [subTab, setSubTab] = useState('overview');
    const [userProfile, setUserProfile] = useState<UserProfile | null>(null);
    const [weddingData, setWeddingData] = useState<WeddingData | null>(null);
    const [isBudgetOpen, setIsBudgetOpen] = useState(false); const [isGuestOpen, setIsGuestOpen] = useState(false); const [isInviteOpen, setIsInviteOpen] = useState(false); const [isJoinOpen, setIsJoinOpen] = useState(false);
    const [inviteCode, setInviteCode] = useState(""); const [joinInput, setJoinInput] = useState(""); const [tempBudget, setTempBudget] = useState("");

    useEffect(() => {
        const pref = doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'profile', 'main');
        const unsub = onSnapshot(pref, async (s) => {
            if (!s.exists()) await setDoc(pref, { email: currentUser.email, name: currentUser.displayName, isSetupComplete: false, weddingId: currentUser.uid });
            else { setUserProfile(s.data() as UserProfile); if(!s.data()?.weddingId) await updateDoc(pref, { weddingId: currentUser.uid }); }
        });
        return () => unsub();
    }, [currentUser]);

    useEffect(() => {
        if(!userProfile?.weddingId) return;
        const wref = doc(db, 'artifacts', APP_ID, 'public', 'data', 'weddings', userProfile.weddingId);
        getDoc(wref).then(s => { if(!s.exists()) setDoc(wref, { tasks: [], guests: [], activities: [], budgetLimit: 300000000, owners: [currentUser.uid] }); });
        const unsub = onSnapshot(wref, s => { if(s.exists()) setWeddingData({...s.data(), weddingId: userProfile.weddingId} as WeddingData); });
        return () => unsub();
    }, [userProfile]);

    const userData = useMemo(() => (userProfile && weddingData) ? {...weddingData, profile: userProfile} : null, [userProfile, weddingData]);
    if (!userData) return <div className="h-screen flex items-center justify-center text-stone-300 animate-pulse">Äang táº£i...</div>;

    if (!userData.profile?.isSetupComplete) {
        return <GettingStartedWizard onComplete={async (w) => {
            await updateDoc(doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'profile', 'main'), { role: w.role, partnerName: w.partnerName, weddingDate: w.weddingDate, engagementDate: w.engagementDate, location: w.location, venue: w.venue, preWedding: w.preWedding, vibes: w.vibes || [], isSetupComplete: true, name: currentUser.displayName });
            if (userData.weddingId) await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'weddings', userData.weddingId), { budgetLimit: w.budget || 300000000 });
        }} onSkip={async () => await updateDoc(doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'profile', 'main'), { isSetupComplete: true })} />;
    }

    const updateDB = async (k: string, v: any) => { if(!userData.weddingId) return; await updateDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'weddings', userData.weddingId), { [k]: v }); };
    const addAct = async (t: string) => { const n = { text: t, time: new Date().toLocaleTimeString('vi-VN') }; await updateDB('activities', [n, ...(userData.activities || [])].slice(0, 15)); };
    const onAddTask = async (t: Task) => { const nt = [{ ...t, paidBy: userData.profile?.role, id: t.id || Date.now() }, ...(userData.tasks || [])]; await updateDB('tasks', nt); await addAct(`ThÃªm: ${t.title}`); };
    const onToggleTask = async (id: number) => { const nt = (userData.tasks||[]).map(t => t.id === id ? { ...t, status: t.status === 'done' ? 'pending' : 'done' } : t); const task = nt.find(t=>t.id===id); if(task) await addAct(`Cáº­p nháº­t: ${task.title}`); await updateDB('tasks', nt); };
    const onDeleteTask = async (id: number) => { await updateDB('tasks', (userData.tasks||[]).filter(t => t.id !== id)); await addAct(`XÃ³a 1 cÃ´ng viá»‡c`); };
    const onAddGuest = async (g: Guest) => { await updateDB('guests', [g, ...(userData.guests||[])]); await addAct(`KhÃ¡ch má»›i: ${g.name}`); };
    const onDeleteGuest = async (id: number) => { await updateDB('guests', (userData.guests||[]).filter(x => x.id !== id)); await addAct(`XÃ³a khÃ¡ch`); };
    const handleInvite = async () => { const code = Math.floor(100000 + Math.random() * 900000).toString(); await setDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'invites', code), { weddingId: userData.weddingId, createdAt: Date.now() }); setInviteCode(code); setIsInviteOpen(true); };
    const joinSync = async () => { const snap = await getDoc(doc(db, 'artifacts', APP_ID, 'public', 'data', 'invites', joinInput.toUpperCase())); if (snap.exists()) { await updateDoc(doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'profile', 'main'), { weddingId: snap.data().weddingId }); setIsJoinOpen(false); alert("Äá»“ng bá»™ thÃ nh cÃ´ng!"); } else alert("MÃ£ khÃ´ng há»£p lá»‡."); };
    const spentAmount = (userData.tasks || []).reduce((acc, t) => acc + (t.paid ?? (t.status === 'done' ? t.cost : 0)), 0);

    return (
        <div className="pb-24">
            {/* Header Pháº§n Planner - ÄÃ£ sá»­a giá»‘ng HTML Source */}
            <div className="pt-24 px-4 md:px-8 mb-12 flex flex-col md:flex-row justify-between items-center gap-6">
                <div>
                    <span className="text-[10px] tracking-[0.3em] text-[#B5A896] mb-2 block font-bold uppercase">Planner cá»§a {userData.profile?.name || 'báº¡n'}</span>
                    <h2 className="text-3xl md:text-5xl font-title font-bold tracking-tighter text-stone-800">Weddy Planner</h2>
                </div>
                <div className="flex gap-4">
                    <div className="bg-white/70 p-4 rounded-[2.5rem] border border-stone-100 shadow-sm flex items-center gap-4">
                        <div className="w-10 h-10 bg-rose-100/40 rounded-full flex items-center justify-center text-rose-300">
                            <Icons.Heart size={20} fill="currentColor"/>
                        </div>
                        <div className="text-xs font-bold uppercase">
                            <p className="text-[10px] text-stone-300">NgÃ y trá»ng Ä‘áº¡i</p>
                            <div className="flex items-center gap-2">
                                <p className="text-stone-600 text-base">{userData.profile?.weddingDate || 'ChÆ°a Ä‘áº·t'}</p>
                                <p className="text-[10px] text-rose-400">{getDaysLeft(userData.profile?.weddingDate)}</p>
                            </div>
                        </div>
                    </div>
                    <button onClick={()=>setIsJoinOpen(true)} className="bg-stone-500 text-white px-6 py-4 rounded-[2.5rem] shadow-xl hover:bg-stone-600 transition-colors flex items-center gap-2">
                        <Icons.Link size={20}/>
                        <span className="text-xs font-bold uppercase hidden md:inline">Nháº­p mÃ£ káº¿t ná»‘i</span>
                    </button>
                </div>
            </div>
            
            <div className="flex justify-center mb-12 px-4">
                <div className="bg-white/50 p-1.5 rounded-full flex gap-1 shadow-sm border border-white/50 overflow-x-auto hide-scrollbar">
                    {[{id:'overview',l:'Tá»•ng quan'},{id:'tasks',l:'CÃ´ng viá»‡c'},{id:'budget',l:'NgÃ¢n sÃ¡ch'},{id:'guests',l:'KhÃ¡ch má»i'}].map(t => (
                        <button 
                            key={t.id} 
                            onClick={()=>setSubTab(t.id)} 
                            className={`px-6 py-3 rounded-full text-xs md:text-sm font-black uppercase transition-all whitespace-nowrap ${subTab===t.id?'bg-stone-500 text-white shadow-xl':'text-stone-400 hover:text-stone-600'}`}
                        >
                            {t.l}
                        </button>
                    ))}
                </div>
            </div>

            <div className="px-1 md:px-0 animate-in">
                {subTab === 'overview' && <PlannerOverview spentAmount={spentAmount} completedTasks={userData.tasks.filter(t=>t.status==='done').length} totalTasks={userData.tasks.length} guestCount={userData.guests.length} budgetLimit={userData.budgetLimit} role={userData.profile?.role} activities={userData.activities} onInvite={handleInvite} onEditBudget={()=>{setTempBudget(utils.formatInput(userData.budgetLimit));setIsBudgetOpen(true)}} onOpenGuests={()=>setSubTab('guests')} />}
                {subTab === 'tasks' && <PlannerTasks tasks={userData.tasks} onAddTask={onAddTask} onToggleTask={onToggleTask} onDeleteTask={onDeleteTask} />}
                {subTab === 'budget' && <PlannerBudget tasks={userData.tasks} onAddExpense={onAddTask} onDeleteTask={onDeleteTask} />}
                {subTab === 'guests' && <PlannerGuests guests={userData.guests} onAddGuest={onAddGuest} onDeleteGuest={onDeleteGuest} />}
            </div>
            <Modal isOpen={isBudgetOpen} onClose={()=>setIsBudgetOpen(false)} title="NgÃ¢n sÃ¡ch"><input value={tempBudget} onChange={e=>setTempBudget(utils.formatInput(e.target.value))} className="w-full p-4 border rounded-xl mb-4 font-bold uppercase" /><button onClick={async ()=>{const nb=utils.parseInput(tempBudget); if(nb>0) await updateDB('budgetLimit', nb); setIsBudgetOpen(false);}} className="w-full py-4 bg-stone-500 text-white rounded-full font-bold uppercase text-xs">LÆ°u</button></Modal>
            <Modal isOpen={isGuestOpen} onClose={()=>setIsGuestOpen(false)} title="KhÃ¡ch má»i"><PlannerGuests guests={userData.guests} onAddGuest={onAddGuest} onDeleteGuest={onDeleteGuest} /></Modal>
            <Modal isOpen={isInviteOpen} onClose={()=>setIsInviteOpen(false)} title="MÃ£ káº¿t ná»‘i"><div className="text-center py-8"><h2 className="text-5xl font-black tracking-widest text-stone-700 mb-4">{inviteCode}</h2><p className="text-stone-400 text-xs uppercase font-bold">Chia sáº» mÃ£ nÃ y Ä‘á»ƒ Ä‘á»“ng bá»™ Planner.</p></div></Modal>
            <Modal isOpen={isJoinOpen} onClose={()=>setIsJoinOpen(false)} title="Äá»“ng bá»™ Planner"><div className="text-center py-8"><input value={joinInput} onChange={e=>setJoinInput(e.target.value.toUpperCase())} maxLength={6} className="w-full p-6 bg-stone-50 border-2 border-dashed border-stone-200 rounded-3xl text-4xl font-black tracking-[0.4em] text-center mb-4 uppercase" placeholder="000000" /><button onClick={joinSync} className="w-full py-4 bg-stone-500 text-white rounded-full font-bold uppercase text-xs">Äá»“ng bá»™ ngay</button></div></Modal>
        </div>
    );
};
