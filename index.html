<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weddy - K·∫ø ho·∫°ch ƒë√°m c∆∞·ªõi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@600;700&family=Raleway:wght@400;600;700;800&display=swap');
        body { font-family: 'Raleway', sans-serif; background-color: #F0EBE5; color: #44403C; }
        .font-title { font-family: 'Cormorant Garamond', serif; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD_F3OI5GexlAqgC8TZ1CN1JB5O3RacQqs",
            authDomain: "weddyvn.firebaseapp.com",
            projectId: "weddyvn",
            storageBucket: "weddyvn.firebasestorage.app",
            messagingSenderId: "504927899297",
            appId: "1:504927899297:web:1a3d3a1b6cfafe0716aae0",
            measurementId: "G-KK4B3RXVNV"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.firebaseServices = { 
                auth: getAuth(app), 
                db: getFirestore(app), 
                signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged,
                doc, setDoc, onSnapshot, updateDoc, getDoc
            };
            console.log("Firebase Connected");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- C√ÅC COMPONENT NH·ªé ---
        const Icon = ({ name }) => {
            const icons = {
                heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
                check: <polyline points="20 6 9 17 4 12" />,
                google: <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z" /> // Gi·∫£ l·∫≠p icon Google ƒë∆°n gi·∫£n
            };
            return <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">{icons[name] || icons.heart}</svg>;
        };

        const Logo = () => (
            <div className="flex items-center justify-center gap-2 mb-6">
                <span className="text-2xl font-title font-bold tracking-widest text-stone-800">WEDDY</span>
            </div>
        );

        // --- M√ÄN H√åNH WIZARD (Thi·∫øt l·∫≠p ban ƒë·∫ßu) ---
        const Wizard = ({ onComplete }) => {
            const [step, setStep] = useState(1);
            const [role, setRole] = useState("");
            const [budget, setBudget] = useState("");

            return (
                <div className="fixed inset-0 bg-[#F0EBE5] flex items-center justify-center p-4 z-50 animate-in">
                    <div className="max-w-md w-full bg-white/50 backdrop-blur-xl p-8 rounded-[2rem] shadow-xl border border-white">
                        <Logo />
                        <div className="h-1 w-full bg-stone-200 rounded-full mb-8 overflow-hidden">
                            <div className="h-full bg-stone-800 transition-all duration-500" style={{width: step === 1 ? '50%' : '100%'}}></div>
                        </div>

                        {step === 1 ? (
                            <div className="text-center space-y-6">
                                <h2 className="text-xl font-bold text-stone-700">B·∫°n l√† ai trong ng√†y vui n√†y?</h2>
                                <div className="grid grid-cols-2 gap-4">
                                    <button onClick={() => setRole('Ch√∫ r·ªÉ')} className={`p-6 rounded-2xl border-2 transition-all ${role === 'Ch√∫ r·ªÉ' ? 'border-stone-800 bg-stone-800 text-white' : 'border-white bg-white hover:border-stone-300'}`}>ü§µ Ch√∫ r·ªÉ</button>
                                    <button onClick={() => setRole('C√¥ d√¢u')} className={`p-6 rounded-2xl border-2 transition-all ${role === 'C√¥ d√¢u' ? 'border-stone-800 bg-stone-800 text-white' : 'border-white bg-white hover:border-stone-300'}`}>üë∞ C√¥ d√¢u</button>
                                </div>
                                <button onClick={() => role && setStep(2)} disabled={!role} className="w-full py-4 bg-stone-800 text-white rounded-full font-bold uppercase tracking-widest disabled:opacity-50 hover:scale-[1.02] transition-transform">Ti·∫øp t·ª•c</button>
                            </div>
                        ) : (
                            <div className="text-center space-y-6">
                                <h2 className="text-xl font-bold text-stone-700">Ng√¢n s√°ch d·ª± ki·∫øn c·ªßa b·∫°n?</h2>
                                <input 
                                    type="text" 
                                    value={budget}
                                    onChange={(e) => setBudget(e.target.value.replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, "."))}
                                    placeholder="VD: 300.000.000"
                                    className="w-full p-4 text-center text-2xl font-bold bg-white/80 rounded-2xl outline-none focus:ring-2 ring-stone-200"
                                    autoFocus
                                />
                                <div className="text-stone-400 text-sm font-bold uppercase">VNƒê</div>
                                <button onClick={() => onComplete({ role, budget: parseInt(budget.replace(/\./g, '')) || 0 })} className="w-full py-4 bg-emerald-600 text-white rounded-full font-bold uppercase tracking-widest hover:scale-[1.02] transition-transform shadow-lg shadow-emerald-200">Ho√†n t·∫•t thi·∫øt l·∫≠p</button>
                                <button onClick={() => setStep(1)} className="text-xs font-bold text-stone-400 uppercase tracking-widest hover:text-stone-600">Quay l·∫°i</button>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- COMPONENT CH√çNH ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [showWizard, setShowWizard] = useState(false);
            const [services, setServices] = useState(null);
            const [data, setData] = useState(null);

            // ƒê·ª£i Firebase load xong
            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.firebaseServices) {
                        setServices(window.firebaseServices);
                        clearInterval(interval);
                    }
                }, 100);
            }, []);

            // Theo d√µi tr·∫°ng th√°i ƒëƒÉng nh·∫≠p
            useEffect(() => {
                if (!services) return;
                const { auth, db, onAuthStateChanged, doc, onSnapshot, setDoc } = services;
                
                return onAuthStateChanged(auth, async (u) => {
                    setUser(u);
                    if (u) {
                        // L·∫Øng nghe d·ªØ li·ªáu
                        const unsub = onSnapshot(doc(db, "weddings", u.uid), (snap) => {
                            if (snap.exists()) {
                                setData(snap.data());
                                setShowWizard(false);
                            } else {
                                setShowWizard(true); // Ch∆∞a c√≥ d·ªØ li·ªáu -> Hi·ªán Wizard
                            }
                            setLoading(false);
                        });
                        return () => unsub();
                    } else {
                        setLoading(false);
                        setData(null);
                    }
                });
            }, [services]);

            // H√†m l∆∞u d·ªØ li·ªáu t·ª´ Wizard
            const handleWizardComplete = async (wizardData) => {
                if (!services || !user) return;
                const { db, setDoc, doc } = services;
                await setDoc(doc(db, "weddings", user.uid), {
                    ...wizardData,
                    tasks: [],
                    createdAt: new Date().toISOString()
                }, { merge: true });
            };

            const handleLogin = () => {
                if(services) services.signInWithPopup(services.auth, new services.GoogleAuthProvider());
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-stone-400 font-bold tracking-widest uppercase animate-pulse">ƒêang t·∫£i Weddy...</div>;

            if (!user) return (
                <div className="h-screen flex flex-col items-center justify-center p-6 animate-in text-center">
                    <Logo />
                    <h1 className="text-3xl font-title font-bold text-stone-800 mb-4">L√™n k·∫ø ho·∫°ch ƒë√°m c∆∞·ªõi<br/>trong m∆° c·ªßa b·∫°n</h1>
                    <p className="text-stone-500 mb-8 max-w-xs mx-auto leading-relaxed">Qu·∫£n l√Ω ng√¢n s√°ch, danh s√°ch vi·ªác c·∫ßn l√†m v√† kh√°ch m·ªùi t·∫•t c·∫£ trong m·ªôt.</p>
                    <button onClick={handleLogin} className="bg-white border border-stone-200 px-8 py-4 rounded-full font-bold shadow-xl hover:scale-105 transition-transform flex items-center gap-3 text-stone-700">
                        <span>ƒêƒÉng nh·∫≠p b·∫±ng Google</span>
                    </button>
                </div>
            );

            return (
                <div className="min-h-screen pb-10">
                    {showWizard && <Wizard onComplete={handleWizardComplete} />}
                    
                    <nav className="bg-white/80 backdrop-blur-md px-6 py-4 flex justify-between items-center sticky top-0 z-40 border-b border-stone-100">
                        <span className="font-title font-bold text-xl">WEDDY</span>
                        <div className="flex items-center gap-4">
                            <span className="text-xs font-bold uppercase hidden md:inline-block">Xin ch√†o, {user.displayName}</span>
                            <button onClick={() => services.signOut(services.auth)} className="text-stone-400 hover:text-rose-500 transition-colors">Tho√°t</button>
                        </div>
                    </nav>

                    <main className="max-w-4xl mx-auto p-6 space-y-8">
                        {/* Hi·ªÉn th·ªã Dashboard ƒë∆°n gi·∫£n ƒë·ªÉ test */}
                        <div className="bg-stone-800 text-white p-8 rounded-[2.5rem] shadow-xl animate-in">
                            <p className="text-xs font-bold uppercase tracking-widest opacity-50 mb-2">T·ªïng ng√¢n s√°ch</p>
                            <h2 className="text-5xl font-bold tracking-tighter">
                                {data?.budget ? (data.budget).toLocaleString('vi-VN') : 0} <span className="text-xl">VNƒê</span>
                            </h2>
                            <div className="mt-8 flex gap-4">
                                <div className="px-4 py-2 bg-white/10 rounded-xl text-xs font-bold uppercase tracking-widest border border-white/5">
                                    Vai tr√≤: {data?.role || "Ch∆∞a ch·ªçn"}
                                </div>
                            </div>
                        </div>

                        <div className="text-center p-12 border-2 border-dashed border-stone-200 rounded-[2.5rem]">
                            <p className="text-stone-400 font-bold mb-4">Giao di·ªán ch√≠nh ƒëang ƒë∆∞·ª£c t·∫£i...</p>
                            <p className="text-sm text-stone-400">N·∫øu b·∫°n th·∫•y m√†n h√¨nh n√†y, nghƒ©a l√† code ƒë√£ ch·∫°y th√†nh c√¥ng!</p>
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
