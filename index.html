<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weddy - Nền tảng quản lý đám cưới tinh tế</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.8s ease-out forwards; }
        
        /* Mobile Menu Animation */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .mobile-menu-in { animation: slideDown 0.3s ease-out forwards; }

        /* Wedding Title Animations - REFINED & UNIQUE */
        @keyframes reveal-up-blur {
            0% { opacity: 0; transform: translateY(100%) scale(1.1); filter: blur(20px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }
        
        @keyframes silk-shine {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .title-entrance {
            animation: reveal-up-blur 1.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .text-silk {
            background: linear-gradient(
                90deg, 
                #806233 0%, 
                #CC9C53 25%, 
                #FFECB3 50%, 
                #CC9C53 75%, 
                #806233 100%
            );
            background-size: 200% auto;
            color: #000;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: silk-shine 5s linear infinite;
        }

        @keyframes subtle-zoom {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        .bg-zoom { animation: subtle-zoom 20s infinite alternate; }
    </style>
</head>
<body class="bg-[#FBF9F7] text-[#1A1A1A]">
    <div id="root"></div>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";

        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD_F3OI5GexlAqgC8TZ1CN1JB5O3RacQqs",
            authDomain: "weddyvn.firebaseapp.com",
            projectId: "weddyvn",
            storageBucket: "weddyvn.firebasestorage.app",
            messagingSenderId: "504927899297",
            appId: "1:504927899297:web:1a3d3a1b6cfafe0716aae0",
            measurementId: "G-KK4B3RXVNV"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const analytics = getAnalytics(app);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            // Expose services to window for React
            window.firebaseServices = { 
                auth, 
                db, 
                createUserWithEmailAndPassword, 
                signInWithEmailAndPassword, 
                signOut, 
                onAuthStateChanged, 
                doc, 
                setDoc, 
                updateDoc, 
                onSnapshot, 
                getDoc,
                GoogleAuthProvider,
                signInWithPopup
            };
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase init error:", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- UTILS ---
        const formatCurrencyInput = (value) => {
            if(!value) return "";
            const raw = value.toString().replace(/\D/g, '');
            return raw.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        const parseCurrencyInput = (value) => {
            if(!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        };

        const formatMoneyDisplay = (amount) => {
            if (!amount || amount === 0) return "0 VNĐ";
            // Quy tắc: 1 tỷ trở lên hiển thị Tỷ, còn lại hiển thị Triệu VNĐ
            if (amount >= 1000000000) {
                return (amount / 1000000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 }) + " Tỷ VNĐ";
            }
            return (amount / 1000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 }) + " Triệu VNĐ";
        };
        
        const generateCode = () => {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // --- FIREBASE HELPER HOOK ---
        const useFirebase = () => {
            const [services, setServices] = useState(null);
            
            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.firebaseServices) {
                        setServices(window.firebaseServices);
                        clearInterval(interval);
                    }
                }, 100);
                return () => clearInterval(interval);
            }, []);
            
            return services;
        };

        // --- ICON SYSTEM ---
        const Icon = ({ children, size = 24, color = "currentColor", className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Heart: (p) => <Icon {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12" /></Icon>,
            Users: (p) => <Icon {...p}><g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></g></Icon>,
            Plus: (p) => <Icon {...p}><g><path d="M5 12h14" /><path d="M12 5v14" /></g></Icon>,
            Smartphone: (p) => <Icon {...p}><g><rect width="14" height="20" x="5" y="2" rx="2" ry="2" /><path d="M12 18h.01" /></g></Icon>,
            Layout: (p) => <Icon {...p}><g><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M3 9h18" /><path d="M9 21V9" /></g></Icon>,
            DollarSign: (p) => <Icon {...p}><g><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></g></Icon>,
            Menu: (p) => <Icon {...p}><g><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></g></Icon>,
            X: (p) => <Icon {...p}><g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g></Icon>,
            ArrowRight: (p) => <Icon {...p}><g><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></g></Icon>,
            Search: (p) => <Icon {...p}><g><circle cx="11" cy="11" r="8" /><path d="m21 21-4.3-4.3" /></g></Icon>,
            Star: (p) => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></Icon>,
            Calendar: (p) => <Icon {...p}><g><rect width="18" height="18" x="3" y="4" rx="2" ry="2" /><line x1="16" x2="16" y1="2" y2="6" /><line x1="8" x2="8" y1="2" y2="6" /><line x1="3" x2="21" y1="10" y2="10" /></g></Icon>,
            MapPin: (p) => <Icon {...p}><g><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z" /><circle cx="12" cy="10" r="3" /></g></Icon>,
            Clock: (p) => <Icon {...p}><g><circle cx="12" cy="12" r="10" /><polyline points="12 6 12 12 16 14" /></g></Icon>,
            PieChart: (p) => <Icon {...p}><g><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10Z" /></g></Icon>,
            ChevronRight: (p) => <Icon {...p}><path d="m9 18 6-6-6-6" /></Icon>,
            Filter: (p) => <Icon {...p}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3" /></Icon>,
            Circle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10" /></Icon>,
            Coffee: (p) => <Icon {...p}><g><path d="M17 8h1a4 4 0 1 1 0 8h-1" /><path d="M3 8h14v9a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4Z" /><line x1="6" x2="6" y1="1" y2="4" /><line x1="10" x2="10" y1="1" y2="4" /><line x1="14" x2="14" y1="1" y2="4" /></g></Icon>,
            Music: (p) => <Icon {...p}><g><path d="M9 18V5l12-2v13" /><circle cx="6" cy="18" r="3" /><circle cx="18" cy="16" r="3" /></g></Icon>,
            Camera: (p) => <Icon {...p}><g><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z" /><circle cx="12" cy="13" r="3" /></g></Icon>,
            Bell: (p) => <Icon {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /></Icon>,
            LogOut: (p) => <Icon {...p}><g><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="21" y1="12" y2="12" /></g></Icon>,
            Trash: (p) => <Icon {...p}><g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></g></Icon>,
            Link: (p) => <Icon {...p}><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></g></Icon>,
            Share: (p) => <Icon {...p}><g><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" x2="15.42" y1="13.51" y2="17.49" /><line x1="15.41" x2="8.59" y1="6.51" y2="10.49" /></g></Icon>,
            Lock: (p) => <Icon {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2" /><path d="M7 11V7a5 5 0 0 1 10 0v4" /></Icon>,
            ArrowUpRight: (p) => <Icon {...p}><g><path d="M7 7h10v10" /><path d="M7 17 17 7" /></g></Icon>,
            Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></Icon>,
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-stone-900/40 backdrop-blur-sm transition-opacity animate-in fade-in duration-300" onClick={onClose}></div>
                    <div className="relative bg-white rounded-[2rem] p-6 md:p-8 w-full max-w-md shadow-2xl border border-stone-100 animate-in zoom-in-95 duration-300 flex flex-col max-h-[90vh] overflow-y-auto hide-scrollbar">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-black uppercase tracking-widest">{title}</h3>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 text-stone-400 hover:bg-stone-100 hover:text-black transition-colors"><Icons.X size={16} /></button>
                        </div>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };

        // --- GETTING STARTED WIZARD ---
        const GettingStartedWizard = ({ onComplete, onSkip }) => {
            const [step, setStep] = useState(0);
            const [data, setData] = useState({ role: "", date: "", location: "", budget: "" });

            const handleNext = () => setStep(step + 1);
            const handleFinish = () => onComplete({...data, budget: parseCurrencyInput(data.budget)});

            const steps = [
                {
                    title: "Bạn là?",
                    content: (
                        <div className="grid grid-cols-2 gap-4 mt-4">
                            {["Cô dâu", "Chú rể"].map((role) => (
                                <button 
                                    key={role}
                                    onClick={() => setData({ ...data, role })}
                                    className={`p-6 rounded-2xl border-2 transition-all ${data.role === role ? 'border-black bg-black text-white' : 'border-stone-100 hover:border-black'}`}
                                >
                                    <span className="block text-xl font-bold">{role}</span>
                                </button>
                            ))}
                        </div>
                    )
                },
                {
                    title: "Ngày trọng đại?",
                    content: (
                        <div className="mt-4">
                            <input 
                                type="date" 
                                value={data.date} 
                                onChange={(e) => setData({ ...data, date: e.target.value })}
                                className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-5 py-4 text-lg font-bold focus:outline-none focus:border-black"
                            />
                        </div>
                    )
                },
                {
                    title: "Tổ chức ở đâu?",
                    content: (
                        <div className="mt-4">
                            <input 
                                type="text" 
                                value={data.location} 
                                onChange={(e) => setData({ ...data, location: e.target.value })}
                                placeholder="Nhà hàng, Tại gia, Ngoài trời..."
                                className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-5 py-4 text-lg font-bold focus:outline-none focus:border-black"
                            />
                        </div>
                    )
                },
                {
                    title: "Ngân sách dự trù?",
                    content: (
                        <div className="mt-4">
                            <div className="relative">
                                <input 
                                    type="text" 
                                    value={data.budget} 
                                    onChange={(e) => setData({ ...data, budget: formatCurrencyInput(e.target.value) })}
                                    placeholder="300.000.000"
                                    className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-5 py-4 pl-4 pr-16 text-lg font-bold focus:outline-none focus:border-black"
                                />
                                <div className="absolute right-4 top-1/2 -translate-y-1/2 text-stone-400 font-bold">VNĐ</div>
                            </div>
                            <p className="text-xs text-stone-400 mt-2 text-center">Đừng lo, bạn có thể thay đổi sau này.</p>
                        </div>
                    )
                }
            ];

            const currentStep = steps[step];

            return (
                <div className="fixed inset-0 z-[200] bg-white flex flex-col animate-in fade-in">
                    <div className="flex justify-end p-6">
                        <button onClick={onSkip} className="text-xs font-bold uppercase tracking-widest text-stone-400 hover:text-black">Bỏ qua</button>
                    </div>
                    <div className="flex-1 flex flex-col justify-center px-8 max-w-lg mx-auto w-full">
                        <div className="mb-8">
                            <div className="flex gap-2 mb-6 justify-center">
                                {steps.map((_, i) => (
                                    <div key={i} className={`h-1.5 rounded-full transition-all duration-500 ${i <= step ? 'bg-black w-8' : 'bg-stone-200 w-4'}`}></div>
                                ))}
                            </div>
                            <h2 className="text-3xl md:text-4xl font-black tracking-tighter text-center mb-2">{currentStep.title}</h2>
                        </div>
                        {currentStep.content}
                        <div className="mt-12">
                            {step < steps.length - 1 ? (
                                <button 
                                    onClick={handleNext}
                                    disabled={
                                        (step === 0 && !data.role) || 
                                        (step === 1 && !data.date) || 
                                        (step === 2 && !data.location)
                                    }
                                    className="w-full py-4 bg-black text-white rounded-full text-xs font-black uppercase tracking-widest shadow-xl disabled:opacity-50 disabled:cursor-not-allowed hover:bg-stone-800 transition-all"
                                >
                                    Tiếp tục
                                </button>
                            ) : (
                                <button 
                                    onClick={handleFinish}
                                    className="w-full py-4 bg-emerald-500 text-white rounded-full text-xs font-black uppercase tracking-widest shadow-xl hover:bg-emerald-600 transition-all"
                                >
                                    Hoàn tất & Tạo Planner
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- SUB-COMPONENTS ---
        
        const PlannerOverview = ({ spentAmount, completedTasks, totalTasks, guestCount, activities, budgetLimit, weddingDate, role, onInvite, onEditBudget }) => {
            const displayBudgetLimit = budgetLimit || 300000000;
            const remaining = (displayBudgetLimit - spentAmount);
            const percentage = Math.min((spentAmount / displayBudgetLimit) * 100, 100);
            const taskPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            
            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 animate-in">
                    <div className="lg:col-span-2 space-y-6 md:space-y-8">
                        {/* Invite Banner */}
                        <div className="bg-gradient-to-r from-rose-50 to-orange-50 p-6 rounded-[2rem] border border-rose-100 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-white rounded-full flex items-center justify-center text-rose-500 shadow-sm"><Icons.Heart size={20} fill="currentColor"/></div>
                                <div>
                                    <h4 className="font-bold text-stone-800">Ví chung đôi mình</h4>
                                    <p className="text-xs text-stone-500">Đồng bộ kế hoạch và ngân sách với người ấy.</p>
                                </div>
                            </div>
                            <button onClick={onInvite} className="w-full md:w-auto px-6 py-3 bg-white text-stone-800 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2">
                                <Icons.Share size={14}/> Mời bạn đời
                            </button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48 md:h-52">
                                <div className="flex justify-between items-start"><span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#B5A896]">Tiến độ</span><div className="w-10 h-10 bg-stone-50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Check size={18}/></div></div>
                                <div><div className="flex items-baseline gap-2 mb-4"><span className="text-4xl md:text-6xl font-black">{completedTasks}</span><span className="text-stone-400 font-bold uppercase text-[11px]">/ {totalTasks} hoàn thành</span></div><div className="w-full h-1.5 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-black transition-all duration-700" style={{width: `${taskPercentage}%`}}></div></div></div>
                            </div>
                            <div className="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48 md:h-52">
                                <div className="flex justify-between items-start"><span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#B5A896]">Khách mời</span><div className="w-10 h-10 bg-stone-50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Users size={18}/></div></div>
                                <div className="flex items-baseline gap-2"><span className="text-4xl md:text-6xl font-black">{guestCount}</span><span className="text-emerald-500 font-bold uppercase text-[11px]">Người</span></div>
                            </div>
                        </div>
                        <div className="bg-black p-8 md:p-12 rounded-[2rem] md:rounded-[3rem] text-white relative overflow-hidden shadow-2xl group cursor-pointer">
                            <div className="absolute top-0 right-0 w-80 h-80 bg-rose-500 rounded-full blur-[150px] opacity-20 -translate-y-1/2 translate-x-1/2 group-hover:opacity-30 transition-opacity duration-700"></div>
                            <div className="relative z-10"><h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-white/40 mb-8 md:mb-10">Tài chính tổng quát ({role || 'Bạn'})</h3>
                                <div className="flex flex-col md:flex-row justify-between gap-8 md:gap-12">
                                    <div className="flex-1">
                                        <div className="text-[10px] uppercase font-black text-white/30 mb-2">Đã chi tiêu</div>
                                        <div className="text-5xl md:text-7xl font-black tracking-tighter">{formatMoneyDisplay(spentAmount)}</div>
                                        <div className="w-full h-1.5 bg-white/10 rounded-full overflow-hidden mt-6 mb-4">
                                            <div className="h-full bg-white transition-all duration-700" style={{width: `${percentage}%`}}></div>
                                        </div>
                                        <div className="flex items-center gap-2 group/budget inline-flex cursor-pointer" onClick={onEditBudget}>
                                            <p className="text-[12px] font-black text-white/80 uppercase tracking-widest">Ngân sách: {formatMoneyDisplay(displayBudgetLimit)}</p>
                                            <Icons.Edit size={14} className="text-white/20 group-hover/budget:text-white transition-colors" />
                                        </div>
                                    </div>
                                    <div className="md:w-48 flex flex-col gap-4 justify-center">
                                        <div className="bg-white/5 p-6 rounded-3xl border border-white/5 backdrop-blur-sm">
                                            <p className="text-[9px] font-black text-white/30 uppercase mb-1">Còn lại</p>
                                            <p className="text-xl font-bold">{formatMoneyDisplay(remaining)}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 shadow-sm h-full">
                        <h3 className="text-[11px] font-black uppercase tracking-[0.2em] mb-8 md:mb-10 text-stone-900 border-b border-stone-50 pb-6">Hoạt động</h3>
                        <div className="space-y-6 md:space-y-8">{activities.map((act, i) => (<div key={i} className="flex gap-4 items-center group cursor-pointer animate-in slide-in-from-right-4" style={{animationDelay: `${i * 0.1}s`}}><div className="w-10 h-10 bg-stone-50 rounded-2xl flex items-center justify-center shrink-0 group-hover:bg-black group-hover:text-white transition-colors"><Icons.ArrowUpRight size={16} className="text-stone-300 group-hover:text-white" /></div><div><p className="text-[13px] font-bold text-stone-800 leading-snug">{act.text}</p><p className="text-[10px] font-black text-stone-400 uppercase tracking-widest mt-1">{act.time}</p></div></div>))}
                        {activities.length === 0 && <p className="text-sm text-stone-400 italic">Chưa có hoạt động mới.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const PlannerBudget = ({ tasks, onAddExpense }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [title, setTitle] = useState(""); const [cost, setCost] = useState(""); const [paid, setPaid] = useState(""); const [category, setCategory] = useState("Khác");
            const expenses = tasks.filter(t => t.cost > 0);
            
            // Calculate totals
            const totalBudget = expenses.reduce((acc, curr) => acc + curr.cost, 0);
            const totalPaid = expenses.reduce((acc, curr) => acc + (curr.paid || (curr.status === 'done' ? curr.cost : 0)), 0);
            const remaining = totalBudget - totalPaid;

            const handleSave = () => { 
                if (title.trim() && cost) { 
                    const numCost = parseCurrencyInput(cost);
                    const numPaid = parseCurrencyInput(paid);
                    
                    onAddExpense({ 
                        title: title, 
                        tag: category, 
                        status: numPaid >= numCost ? 'done' : 'pending', 
                        cost: numCost,
                        paid: numPaid
                    }); 
                    setTitle(""); setCost(""); setPaid(""); setCategory("Khác"); setIsModalOpen(false); 
                } 
            };

            return (
                <div className="max-w-4xl mx-auto space-y-6 md:space-y-8 animate-in">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                        <div className="bg-white p-6 md:p-8 rounded-[2rem] border border-stone-100 shadow-sm"><p className="text-[10px] font-black uppercase tracking-widest text-stone-400 mb-2">Tổng chi phí dự kiến</p><p className="text-2xl md:text-3xl font-black text-stone-800">{formatMoneyDisplay(totalBudget)}</p></div>
                        <div className="bg-black text-white p-6 md:p-8 rounded-[2rem] shadow-xl"><p className="text-[10px] font-black uppercase tracking-widest text-white/50 mb-2">Đã thanh toán / Cọc</p><p className="text-2xl md:text-3xl font-black">{formatMoneyDisplay(totalPaid)}</p></div>
                        <div className="bg-white p-6 md:p-8 rounded-[2rem] border border-stone-100 shadow-sm"><p className="text-[10px] font-black uppercase tracking-widest text-stone-400 mb-2">Cần thanh toán tiếp</p><p className="text-2xl md:text-3xl font-black text-rose-500">{formatMoneyDisplay(remaining)}</p></div>
                    </div>
                    <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 overflow-hidden shadow-sm">
                        <div className="p-6 md:p-8 border-b border-stone-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div><h3 className="text-xl font-black uppercase tracking-widest">Chi tiết khoản chi</h3><span className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Tự động từ công việc</span></div>
                            <button onClick={() => setIsModalOpen(true)} className="w-full md:w-auto px-5 py-3 bg-black text-white rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-stone-800 flex items-center justify-center gap-2 shadow-lg"><Icons.Plus size={12}/> Thêm Khoản Chi</button>
                        </div>
                        <div className="divide-y divide-stone-50">
                            {expenses.length === 0 ? <div className="p-20 text-center text-stone-400"><Icons.DollarSign size={48} className="mx-auto mb-4 opacity-20" /><p>Chưa có khoản chi nào.</p></div> : expenses.map((item, i) => {
                                const paidAmount = item.paid || (item.status === 'done' ? item.cost : 0);
                                const isPaidOff = paidAmount >= item.cost;
                                return (
                                    <div key={i} className="p-6 flex flex-col md:flex-row md:items-center justify-between hover:bg-[#FBF9F7] transition-colors gap-4">
                                        <div className="flex items-center gap-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${isPaidOff ? 'bg-black text-white' : 'bg-stone-100 text-stone-400'}`}><Icons.DollarSign size={16} /></div><div><h4 className="font-bold text-stone-800 text-sm md:text-base">{item.title}</h4><p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">{item.tag}</p></div></div>
                                        <div className="text-right">
                                            <p className="font-black text-sm md:text-lg">{formatMoneyDisplay(item.cost)}</p>
                                            <div className="flex flex-col md:flex-row items-end gap-1 md:gap-2">
                                                 <span className={`text-[9px] font-bold uppercase tracking-widest px-2 py-1 md:px-3 md:py-1.5 rounded-full inline-block ${isPaidOff ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-600'}`}>{isPaidOff ? 'Đã xong' : `Đã trả: ${formatMoneyDisplay(paidAmount)}`}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Thêm khoản chi mới">
                        <div className="space-y-6">
                            <div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Tên khoản chi</label><input type="text" value={title} onChange={(e) => setTitle(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" /></div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Loại chi phí</label><div className="relative"><select value={category} onChange={(e) => setCategory(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black appearance-none"><option value="Khác">Khác</option><option value="Địa điểm">Địa điểm</option><option value="Khách mời">Khách mời</option><option value="Trang phục">Trang phục</option><option value="Ẩm thực">Ẩm thực</option></select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={14} className="rotate-90" /></div></div></div>
                                <div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Tổng chi phí (VNĐ)</label><input type="text" value={cost} onChange={(e) => setCost(formatCurrencyInput(e.target.value))} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" placeholder="0 VNĐ" /></div>
                            </div>
                             <div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Đã thanh toán / Cọc (VNĐ)</label><input type="text" value={paid} onChange={(e) => setPaid(formatCurrencyInput(e.target.value))} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" placeholder="Nhập số tiền đã trả..." /></div>
                            <div className="flex justify-end gap-3 pt-2"><button onClick={() => setIsModalOpen(false)} className="px-6 py-3 rounded-full text-[11px] font-bold uppercase tracking-widest text-stone-500 hover:bg-stone-100">Hủy</button><button onClick={handleSave} className="px-8 py-3 bg-black text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-lg hover:bg-stone-800">Lưu khoản chi</button></div>
                        </div>
                    </Modal>
                </div>
            );
        };

        const PlannerTasks = ({ tasks, onAddTask, onToggleTask, onDeleteTask }) => {
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [taskToDeleteIndex, setTaskToDeleteIndex] = useState(null);
            const [newTaskTitle, setNewTaskTitle] = useState(""); const [newTaskCategory, setNewTaskCategory] = useState("Khác"); const [newTaskCost, setNewTaskCost] = useState("");

            const pendingTasks = tasks.map((task, index) => ({...task, originalIndex: index})).filter(t => t.status !== 'done');
            const completedTasks = tasks.map((task, index) => ({...task, originalIndex: index})).filter(t => t.status === 'done');

            const handleAddTask = () => { if (newTaskTitle && newTaskTitle.trim() !== "") { onAddTask({ title: newTaskTitle, tag: newTaskCategory, status: "pending", cost: newTaskCost ? parseCurrencyInput(newTaskCost) : 0 }); setNewTaskTitle(""); setNewTaskCategory("Khác"); setNewTaskCost(""); setIsAddModalOpen(false); } };
            const confirmDelete = (index) => { setTaskToDeleteIndex(index); setIsDeleteModalOpen(true); };
            const executeDelete = () => { if (taskToDeleteIndex !== null) { onDeleteTask(taskToDeleteIndex); setIsDeleteModalOpen(false); setTaskToDeleteIndex(null); } };

            const renderTaskItem = (task) => (
                <div key={task.originalIndex} onClick={() => onToggleTask(task.originalIndex)} className="group p-4 md:p-6 flex items-start md:items-center border-b border-stone-50 last:border-0 hover:bg-[#FBF9F7] transition-all cursor-pointer relative">
                    <div className={`w-6 h-6 rounded-full border-2 mr-4 md:mr-6 flex items-center justify-center shrink-0 transition-colors ${task.status === 'done' ? 'bg-black border-black' : 'border-stone-200 group-hover:border-black'}`}>{task.status === 'done' && <Icons.Check size={12} className="text-white" />}</div>
                    <div className="flex-1 pr-8"><h4 className={`text-sm md:text-base font-bold transition-colors ${task.status === 'done' ? 'text-stone-300 line-through' : 'text-stone-800'}`}>{task.title}</h4><div className="flex flex-wrap gap-2 mt-1"><span className="text-[9px] md:text-[10px] font-black uppercase tracking-widest text-stone-400">{task.tag}</span>{task.cost > 0 && <span className="text-[9px] md:text-[10px] font-bold text-stone-300">- {formatMoneyDisplay(task.cost)}</span>}</div></div>
                    {task.status === 'urgent' && <span className="text-[9px] font-black bg-rose-50 text-rose-500 px-2 py-1 rounded-full uppercase tracking-widest mr-2 md:mr-4 shrink-0">Gấp</span>}
                    <button onClick={(e) => { e.stopPropagation(); confirmDelete(task.originalIndex); }} className="absolute right-4 top-1/2 -translate-y-1/2 p-2 text-stone-300 hover:text-red-500 transition-colors md:opacity-0 group-hover:opacity-100" title="Xóa công việc"><Icons.Trash size={18} /></button>
                </div>
            );

            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-in">
                    <div className="flex justify-between items-center px-4"><h3 className="text-2xl font-black uppercase tracking-tighter">Công việc</h3><button onClick={() => setIsAddModalOpen(true)} className="px-6 md:px-8 py-3 bg-black text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-xl shadow-black/10 flex items-center gap-2 active:scale-95 transition-transform hover:bg-stone-800"><Icons.Plus size={16}/> <span className="hidden md:inline">Thêm việc</span><span className="md:hidden">Thêm</span></button></div>
                    <div><h4 className="px-4 mb-4 text-[10px] font-black uppercase tracking-widest text-stone-400">Cần làm ({pendingTasks.length})</h4><div className="bg-white rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 overflow-hidden shadow-sm">{pendingTasks.length > 0 ? pendingTasks.map(renderTaskItem) : <div className="p-8 text-center text-stone-400 text-sm">Tuyệt vời! Bạn đã hoàn thành hết các việc cần làm.</div>}</div></div>
                    {completedTasks.length > 0 && (<div><h4 className="px-4 mb-4 text-[10px] font-black uppercase tracking-widest text-stone-400 mt-8">Đã hoàn thành ({completedTasks.length})</h4><div className="bg-white rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 overflow-hidden shadow-sm opacity-60 hover:opacity-100 transition-opacity">{completedTasks.map(renderTaskItem)}</div></div>)}
                    <Modal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} title="Thêm công việc mới"><div className="space-y-6"><div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Tên công việc</label><input type="text" value={newTaskTitle} onChange={(e) => setNewTaskTitle(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" /></div><div className="grid grid-cols-2 gap-4"><div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Tính chất</label><div className="relative"><select value={newTaskCategory} onChange={(e) => setNewTaskCategory(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black appearance-none"><option value="Khác">Khác</option><option value="Địa điểm">Địa điểm</option><option value="Khách mời">Khách mời</option><option value="Thiệp mời">Thiệp mời</option><option value="Trang phục">Trang phục</option><option value="Ẩm thực">Ẩm thực</option><option value="Trang trí">Trang trí</option></select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={14} className="rotate-90" /></div></div></div><div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Chi phí dự kiến</label><input type="text" value={newTaskCost} onChange={(e) => setNewTaskCost(formatCurrencyInput(e.target.value))} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" placeholder="0 VNĐ" /></div></div><div className="flex justify-end gap-3 pt-2"><button onClick={() => setIsAddModalOpen(false)} className="px-6 py-3 rounded-full text-[11px] font-bold uppercase tracking-widest text-stone-500 hover:bg-stone-100">Hủy</button><button onClick={handleAddTask} className="px-8 py-3 bg-black text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-lg hover:bg-stone-800">Lưu công việc</button></div></div></Modal>
                    <Modal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} title="Xóa công việc?"><div className="space-y-6"><p className="text-sm text-stone-600 font-medium">Bạn có chắc chắn muốn xóa công việc này không?<br/><span className="text-xs text-stone-400 mt-2 block">Hành động này không thể hoàn tác.</span></p><div className="flex justify-end gap-3"><button onClick={() => setIsDeleteModalOpen(false)} className="px-6 py-3 rounded-full text-[11px] font-bold uppercase tracking-widest text-stone-500 hover:bg-stone-100">Hủy</button><button onClick={executeDelete} className="px-8 py-3 bg-red-500 text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-lg hover:bg-red-600">Xóa ngay</button></div></div></Modal>
                </div>
            );
        };

        const PlannerGuests = ({ guests, onAddGuest, onImportGuests, onDeleteGuest }) => {
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [guestToDeleteId, setGuestToDeleteId] = useState(null);
            const [name, setName] = useState(""); const [relationship, setRelationship] = useState("Bạn chú rể"); const [phone, setPhone] = useState("");
            const fileInputRef = useRef(null);

            const handleAdd = () => { if (name.trim()) { onAddGuest({ name, relationship, phone, id: Date.now() }); setName(""); setPhone(""); setIsAddModalOpen(false); } };
            const confirmDelete = (id) => { setGuestToDeleteId(id); setIsDeleteModalOpen(true); };
            const executeDelete = () => { if (guestToDeleteId !== null) { onDeleteGuest(guestToDeleteId); setIsDeleteModalOpen(false); setGuestToDeleteId(null); } };
            const handleFileChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (evt) => { try { const bstr = evt.target.result; const wb = XLSX.read(bstr, { type: 'binary' }); const wsname = wb.SheetNames[0]; const ws = wb.Sheets[wsname]; const data = XLSX.utils.sheet_to_json(ws, { header: 1 }); const importedGuests = data.slice(1).map((row, idx) => ({ id: Date.now() + idx, name: row[0] || "Khách mời", relationship: row[1] || "Khác", phone: row[2] || "" })).filter(g => g.name); onImportGuests(importedGuests); } catch (err) { alert("Lỗi đọc file Excel."); } }; reader.readAsBinaryString(file); } };

            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-in">
                    <div className="flex justify-between items-center px-4"><h3 className="text-2xl font-black uppercase tracking-tighter">Danh sách ({guests.length})</h3><div className="flex gap-2"><input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".xlsx, .xls, .csv" /><button onClick={() => fileInputRef.current.click()} className="px-5 py-3 bg-white border border-stone-200 text-stone-600 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm hover:bg-stone-50 flex items-center gap-2"><Icons.Layout size={14}/> <span className="hidden md:inline">Import Excel</span><span className="md:hidden">Excel</span></button><button onClick={() => setIsAddModalOpen(true)} className="px-6 py-3 bg-black text-white rounded-full text-[10px] font-black uppercase tracking-widest shadow-xl shadow-black/10 flex items-center gap-2 hover:bg-stone-800"><Icons.Plus size={14}/> <span className="hidden md:inline">Thêm thủ công</span><span className="md:hidden">Thêm</span></button></div></div>
                    <div className="bg-white rounded-[2rem] md:rounded-[2.5rem] border border-stone-100 overflow-hidden shadow-sm min-h-[300px]">
                        {guests.length === 0 ? <div className="text-center py-20 text-stone-400"><Icons.Users size={48} className="mx-auto mb-4 opacity-20" /><p>Chưa có khách mời nào.</p></div> : <div className="divide-y divide-stone-50">{guests.map((g) => (<div key={g.id} className="p-4 md:p-6 flex items-center justify-between hover:bg-[#FBF9F7] transition-colors group relative"><div className="flex items-center gap-4"><div className="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-500 font-bold text-xs shrink-0">{g.name.charAt(0).toUpperCase()}</div><div><h4 className="font-bold text-stone-800 text-sm md:text-base">{g.name}</h4><p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">{g.relationship}</p></div></div><div className="text-stone-400"><button onClick={() => confirmDelete(g.id)} className="p-2 text-stone-300 hover:text-red-500 transition-colors md:opacity-0 group-hover:opacity-100"><Icons.Trash size={18} /></button></div></div>))}</div>}
                    </div>
                    <Modal isOpen={isAddModalOpen} onClose={() => setIsAddModalOpen(false)} title="Thêm khách mời"><div className="space-y-4"><div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Họ và tên</label><input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" /></div><div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Mối quan hệ</label><div className="relative"><select value={relationship} onChange={(e) => setRelationship(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black appearance-none"><option value="Gia đình chú rể">Gia đình chú rể</option><option value="Gia đình cô dâu">Gia đình cô dâu</option><option value="Bạn chú rể">Bạn chú rể</option><option value="Bạn cô dâu">Bạn cô dâu</option><option value="Bạn chung">Bạn chung</option><option value="Đồng nghiệp">Đồng nghiệp</option><option value="Khác">Khác</option></select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={14} className="rotate-90" /></div></div></div><div><label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400 mb-2">Số điện thoại (Tuỳ chọn)</label><input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full bg-[#FBF9F7] border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" /></div><button onClick={handleAdd} className="w-full py-3 bg-black text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-lg hover:bg-stone-800 transition-colors mt-2">Lưu lại</button></div></Modal>
                    <Modal isOpen={isDeleteModalOpen} onClose={() => setIsDeleteModalOpen(false)} title="Xóa khách mời?"><div className="space-y-6"><p className="text-sm text-stone-600 font-medium">Bạn có chắc chắn muốn xóa khách mời này không? <br/><span className="text-xs text-stone-400 mt-2 block">Hành động này không thể hoàn tác.</span></p><div className="flex justify-end gap-3"><button onClick={() => setIsDeleteModalOpen(false)} className="px-6 py-3 rounded-full text-[11px] font-bold uppercase tracking-widest text-stone-500 hover:bg-stone-100">Hủy</button><button onClick={executeDelete} className="px-8 py-3 bg-red-500 text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-lg hover:bg-red-600">Xóa ngay</button></div></div></Modal>
                </div>
            );
        };

        const FullPlannerApp = ({ currentUser }) => {
            const [subTab, setSubTab] = useState('overview');
            const [userData, setUserData] = useState(null);
            const [isInviteModalOpen, setIsInviteModalOpen] = useState(false);
            const [isJoinModalOpen, setIsJoinModalOpen] = useState(false);
            const [isBudgetModalOpen, setIsBudgetModalOpen] = useState(false);
            const [inviteCode, setInviteCode] = useState("");
            const [joinCode, setJoinCode] = useState("");
            const [tempBudget, setTempBudget] = useState("");
            const firebase = useFirebase();

            // Load data based on weddingId
            useEffect(() => {
                if (!firebase || !currentUser) return;
                const { db, onSnapshot, doc, setDoc, getDoc, updateDoc } = firebase;
                
                // 1. Get user profile to find weddingId
                const userRef = doc(db, "users", currentUser.uid);
                
                // --- FIX: Logic to handle user data fetching securely without double setting state ---
                let unsubscribeUser = null;
                let unsubscribeWedding = null;

                const setupListeners = async () => {
                     unsubscribeUser = onSnapshot(userRef, async (userSnap) => {
                        if (userSnap.exists()) {
                            const userVal = userSnap.data();
                            let weddingId = userVal.weddingId;
                            const profile = userVal.profile;
                            const isSetupComplete = userVal.isSetupComplete;

                            // If new user (no weddingId), create a wedding doc for them
                            if (!weddingId) {
                                weddingId = currentUser.uid; // Default wedding ID is user ID
                                // Create wedding doc
                                const weddingRef = doc(db, "weddings", weddingId);
                                const weddingSnap = await getDoc(weddingRef);
                                
                                if (!weddingSnap.exists()) {
                                    await setDoc(weddingRef, {
                                        tasks: [{ title: "Lên danh sách khách mời", tag: "Khách mời", status: "pending", cost: 0 }],
                                        guests: [],
                                        activities: [{ text: "Chào mừng bạn đến với Weddy", time: new Date().toLocaleTimeString('vi-VN') }],
                                        budgetLimit: 300000000,
                                        owners: [currentUser.uid]
                                    });
                                }
                                
                                // Update user with weddingId (will trigger snapshot again)
                                await updateDoc(userRef, { weddingId: weddingId, isSetupComplete: isSetupComplete || false });
                                return; // Stop here, wait for next snapshot update
                            }

                            // 2. Listen to the wedding document
                            if (unsubscribeWedding) unsubscribeWedding(); // Clear previous listener if any

                            const weddingRef = doc(db, "weddings", weddingId);
                            unsubscribeWedding = onSnapshot(weddingRef, (weddingSnap) => {
                                if (weddingSnap.exists()) {
                                    setUserData({ 
                                        ...weddingSnap.data(), 
                                        weddingId: weddingId, 
                                        profile: profile,
                                        isSetupComplete: isSetupComplete 
                                    });
                                }
                            });
                        } else {
                            // Create user doc if totally missing
                            await setDoc(userRef, {
                                profile: { email: currentUser.email, name: currentUser.displayName },
                                weddingId: null, // Will trigger creation logic above
                                isSetupComplete: false
                            });
                        }
                    });
                };

                setupListeners();

                return () => {
                    if (unsubscribeUser) unsubscribeUser();
                    if (unsubscribeWedding) unsubscribeWedding();
                };
            }, [firebase, currentUser]);

            if (!userData) return <div className="h-screen flex items-center justify-center"><div className="w-8 h-8 border-4 border-black border-t-transparent rounded-full animate-spin"></div></div>;

            // ... Wizard Logic (No changes needed) ...
            if (!userData.isSetupComplete) {
                const handleWizardComplete = async (wizardData) => {
                    if (!firebase) return;
                    const { db, doc, updateDoc } = firebase;
                    // Update User Profile
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, {
                        'profile.role': wizardData.role,
                        'profile.weddingDate': wizardData.date,
                        'profile.location': wizardData.location,
                        'isSetupComplete': true
                    });

                    // Update Wedding Data (Budget)
                    if (userData.weddingId) {
                         const weddingRef = doc(db, "weddings", userData.weddingId);
                         await updateDoc(weddingRef, {
                            'budgetLimit': wizardData.budget ? parseInt(wizardData.budget) : 300000000
                         });
                    }
                };

                const handleWizardSkip = async () => {
                     if (!firebase) return;
                    const { db, doc, updateDoc } = firebase;
                    const userRef = doc(db, "users", currentUser.uid);
                    await updateDoc(userRef, { 'isSetupComplete': true });
                };

                return <GettingStartedWizard onComplete={handleWizardComplete} onSkip={handleWizardSkip} />;
            }

            // Data Mapping
            const guests = userData.guests || [];
            const tasks = userData.tasks || [];
            const activities = userData.activities || [];
            const budgetLimit = userData.budgetLimit;
            const weddingDate = userData.profile?.weddingDate || "Chưa đặt";
            const role = userData.profile?.role;

            const completedTasks = tasks.filter(t => t.status === 'done').length;
            const totalTasks = tasks.length;
            const guestCount = guests.length;
            
            // Calculate Total Paid (Sum of paid field)
            const spentAmount = tasks.reduce((acc, t) => acc + (t.paid || (t.status === 'done' ? t.cost : 0)), 0);

            // Generic Update Function
            const updateWeddingData = async (key, value) => {
                if (!firebase || !userData.weddingId) return;
                const { db, doc, updateDoc } = firebase;
                await updateDoc(doc(db, "weddings", userData.weddingId), { [key]: value });
            };

            const addActivity = async (text) => {
                const newActivity = { text, time: new Date().toLocaleTimeString('vi-VN') };
                const newActivities = [newActivity, ...activities].slice(0, 10);
                await updateWeddingData('activities', newActivities);
            };

            // ... Task/Guest Handlers (Updated to use updateWeddingData) ...
            const handleAddTask = (newTask) => {
                const newTasks = [newTask, ...tasks];
                updateWeddingData('tasks', newTasks);
                addActivity(`Thêm công việc: ${newTask.title}`);
            };

            const handleToggleTask = (index) => {
                const task = tasks[index];
                const newStatus = task.status === 'done' ? 'pending' : 'done';
                const newTasks = [...tasks];
                newTasks[index] = { ...task, status: newStatus };
                updateWeddingData('tasks', newTasks);
                if (newStatus === 'done') addActivity(`Hoàn thành: ${task.title}`);
            };

            const handleDeleteTask = (index) => {
                const taskToDelete = tasks[index];
                const newTasks = tasks.filter((_, i) => i !== index);
                updateWeddingData('tasks', newTasks);
                addActivity(`Đã xóa công việc: ${taskToDelete.title}`);
            };

            const handleAddGuest = (newGuest) => {
                const newGuests = [newGuest, ...guests];
                updateWeddingData('guests', newGuests);
                addActivity(`Thêm khách mời: ${newGuest.name}`);
            };

            const handleDeleteGuest = (id) => {
                const guest = guests.find(g => g.id === id);
                const newGuests = guests.filter(g => g.id !== id);
                updateWeddingData('guests', newGuests);
                if (guest) addActivity(`Đã xóa khách mời: ${guest.name}`);
            };

            const handleImportGuests = (importedGuests) => {
                const newGuests = [...importedGuests, ...guests];
                updateWeddingData('guests', newGuests);
                addActivity(`Import ${importedGuests.length} khách mời từ Excel`);
            };

            const handleSaveBudget = async () => {
                const numBudget = parseCurrencyInput(tempBudget);
                if (numBudget > 0) {
                    await updateWeddingData('budgetLimit', numBudget);
                    setIsBudgetModalOpen(false);
                    addActivity(`Cập nhật ngân sách dự trù`);
                }
            };

            // Invite Logic
            const generateInvite = async () => {
                const code = generateCode();
                if (!firebase) return;
                const { db, doc, setDoc } = firebase;
                // Store invite: code -> weddingId
                await setDoc(doc(db, "invites", code), {
                    weddingId: userData.weddingId,
                    createdBy: currentUser.uid,
                    createdAt: new Date().toISOString()
                });
                setInviteCode(code);
                setIsInviteModalOpen(true);
            };

            const joinWedding = async () => {
                if (!joinCode || !firebase) return;
                const { db, doc, getDoc, updateDoc } = firebase;
                
                const inviteRef = doc(db, "invites", joinCode);
                const inviteSnap = await getDoc(inviteRef);

                if (inviteSnap.exists()) {
                    const weddingId = inviteSnap.data().weddingId;
                    // Update current user to point to this wedding
                    await updateDoc(doc(db, "users", currentUser.uid), { weddingId: weddingId });
                    alert("Kết nối thành công! Đang đồng bộ dữ liệu...");
                    setIsJoinModalOpen(false);
                    // Reload happens automatically via onSnapshot
                } else {
                    alert("Mã kết nối không hợp lệ!");
                }
            };

            // Calculate days left
            const calculateDaysLeft = (dateString) => {
                if (!dateString || dateString === "Chưa đặt") return "---";
                const eventDate = new Date(dateString);
                const today = new Date();
                const diffTime = eventDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays > 0 ? `${diffDays} NGÀY NỮA` : "ĐÃ QUA";
            };

            // ... (Rest of UI similar to previous, add Invite Button in PlannerOverview)
            return (
                <div className="pt-24 pb-32 md:pt-32 md:pb-40 container mx-auto px-4 md:px-12 max-w-7xl animate-in">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 md:mb-16 gap-6">
                         <div className="flex-1 w-full"><span className="text-[10px] font-black uppercase tracking-[0.3em] text-[#B5A896] mb-3 block">Bảng điều khiển</span><h2 className="text-4xl md:text-5xl font-black tracking-tighter uppercase leading-tight">Weddy Planner</h2></div>
                        
                        {/* Info Card: Date + Status + Connect Button */}
                        <div className="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                            <div className="bg-white p-6 rounded-[2rem] border border-stone-100 shadow-sm flex items-center gap-6 flex-1 min-w-[280px]">
                                <div className="w-12 h-12 bg-rose-50 rounded-full flex items-center justify-center text-rose-500 shadow-inner"><Icons.Heart size={20} fill="currentColor"/></div>
                                <div className="flex-1">
                                    <p className="text-[9px] font-black uppercase tracking-widest text-stone-400 mb-1">Ngày trọng đại</p>
                                    <div className="flex items-baseline gap-3">
                                        <p className="text-xl font-bold text-stone-800">{weddingDate}</p>
                                        <p className="text-xs font-bold text-rose-500 whitespace-nowrap">{calculateDaysLeft(weddingDate)}</p>
                                    </div>
                                </div>
                            </div>
                            <button onClick={() => setIsJoinModalOpen(true)} className="bg-black text-white p-6 rounded-[2rem] shadow-xl hover:bg-stone-800 transition-all flex items-center justify-center gap-4 active:scale-95 group">
                                <Icons.Link size={20} className="group-hover:rotate-12 transition-transform"/>
                                <span className="text-xs font-black uppercase tracking-widest">Nhập mã kết nối</span>
                            </button>
                        </div>
                    </div>

                    {/* Navigation Tab Bar - Expanded Width & NOT Sticky */}
                     <div className="flex justify-center mb-10 md:mb-16 -mx-4 px-4 md:mx-0 md:px-0">
                        <div className="bg-[#EEECE8]/60 p-2 rounded-full flex w-full max-w-6xl border border-[#EAE8E4] backdrop-blur-sm overflow-x-auto hide-scrollbar">
                            {[{ id: 'overview', label: 'Tổng quan', icon: Icons.Layout }, { id: 'tasks', label: 'Công việc', icon: Icons.Check }, { id: 'budget', label: 'Ngân sách', icon: Icons.DollarSign }, { id: 'guests', label: 'Khách mời', icon: Icons.Users }].map((tab) => (
                                <button key={tab.id} onClick={() => setSubTab(tab.id)} className={`flex-1 flex items-center justify-center gap-3 px-6 md:px-10 py-5 rounded-full text-xs md:text-sm font-black uppercase tracking-widest transition-all whitespace-nowrap ${subTab === tab.id ? 'bg-black text-white shadow-xl scale-105' : 'text-stone-500 hover:text-black hover:bg-black/5'}`}><tab.icon size={18} strokeWidth={3} />{tab.label}</button>
                            ))}
                        </div>
                    </div>

                    <div>
                        {subTab === 'overview' && <PlannerOverview spentAmount={spentAmount} completedTasks={completedTasks} totalTasks={totalTasks} guestCount={guestCount} activities={activities} budgetLimit={budgetLimit} role={role} onInvite={generateInvite} onEditBudget={() => { setTempBudget(formatCurrencyInput(budgetLimit)); setIsBudgetModalOpen(true); }} />}
                        {subTab === 'tasks' && <PlannerTasks tasks={tasks} onAddTask={handleAddTask} onToggleTask={handleToggleTask} onDeleteTask={handleDeleteTask} />}
                        {subTab === 'budget' && <PlannerBudget tasks={tasks} onAddExpense={handleAddTask} />}
                        {subTab === 'guests' && <PlannerGuests guests={guests} onAddGuest={handleAddGuest} onImportGuests={handleImportGuests} onDeleteGuest={handleDeleteGuest} />}
                    </div>

                    {/* Invite Modal */}
                    <Modal isOpen={isInviteModalOpen} onClose={() => setIsInviteModalOpen(false)} title="Mời bạn đời">
                        <div className="text-center space-y-8 pt-4">
                            <div className="relative mx-auto w-20 h-20">
                                <div className="absolute inset-0 bg-rose-100 rounded-full animate-ping opacity-20"></div>
                                <div className="relative bg-white border-2 border-rose-100 w-20 h-20 rounded-full flex items-center justify-center text-rose-500 shadow-sm">
                                    <Icons.Heart size={32} fill="currentColor" />
                                </div>
                            </div>
                            <div className="space-y-2">
                                <h4 className="text-xl font-black text-stone-800">Chia sẻ mã kết nối</h4>
                                <p className="text-xs text-stone-500 max-w-[80%] mx-auto leading-relaxed">Gửi mã này cho người ấy để cùng nhau lên kế hoạch.</p>
                            </div>
                            <div className="relative group cursor-pointer" onClick={() => {navigator.clipboard.writeText(inviteCode); alert("Đã sao chép mã!");}}>
                                <div className="w-full text-center text-5xl font-black tracking-[0.3em] py-8 bg-stone-50 border-2 border-transparent rounded-3xl group-hover:bg-white group-hover:border-black transition-all text-stone-900">{inviteCode}</div>
                            </div>
                            <p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Mã có hiệu lực trong 24 giờ</p>
                        </div>
                    </Modal>

                    {/* Join Modal */}
                    <Modal isOpen={isJoinModalOpen} onClose={() => setIsJoinModalOpen(false)} title="Nhập mã kết nối">
                        <div className="text-center space-y-8 pt-4">
                            <div className="space-y-2">
                                <h4 className="text-xl font-black text-stone-800">Nhập mã liên kết</h4>
                                <p className="text-xs text-stone-500 max-w-[80%] mx-auto leading-relaxed">Nhập mã 6 số từ thiết bị của bạn đời để đồng bộ hóa kế hoạch.</p>
                            </div>
                            <div className="relative group">
                                <input 
                                    type="text" 
                                    value={joinCode} 
                                    onChange={(e) => setJoinCode(e.target.value.replace(/[^0-9]/g, '').slice(0, 6))} 
                                    placeholder="000000" 
                                    className="w-full text-center text-5xl font-black tracking-[0.3em] py-8 bg-stone-50 border-2 border-dashed border-stone-200 rounded-3xl focus:border-black focus:bg-white focus:outline-none transition-all placeholder:text-stone-200 text-stone-900" 
                                    maxLength="6"
                                />
                            </div>
                            <button onClick={joinWedding} disabled={joinCode.length !== 6} className="w-full py-5 bg-black text-white rounded-full text-xs font-black uppercase tracking-[0.2em] shadow-xl hover:bg-stone-800 active:scale-95 transition-all disabled:opacity-50">Xác nhận kết nối</button>
                        </div>
                    </Modal>

                    {/* Edit Budget Modal */}
                    <Modal isOpen={isBudgetModalOpen} onClose={() => setIsBudgetModalOpen(false)} title="Cập nhật ngân sách">
                        <div className="space-y-6 pt-4">
                            <div className="space-y-2">
                                <label className="block text-[10px] font-bold uppercase tracking-widest text-stone-400">Ngân sách dự kiến (VNĐ)</label>
                                <input 
                                    type="text" 
                                    value={tempBudget} 
                                    onChange={(e) => setTempBudget(formatCurrencyInput(e.target.value))} 
                                    className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-black font-bold text-lg" 
                                    placeholder="0"
                                />
                            </div>
                            <div className="p-4 bg-stone-50 rounded-2xl border border-stone-100">
                                <p className="text-xs text-stone-500 leading-relaxed italic">Hệ thống sẽ dựa vào con số này để tính toán phần trăm chi tiêu và tiến độ tài chính của bạn.</p>
                            </div>
                            <button onClick={handleSaveBudget} className="w-full py-4 bg-black text-white rounded-full font-black uppercase text-xs shadow-lg hover:bg-stone-800 active:scale-95 transition-all">Lưu ngân sách</button>
                        </div>
                    </Modal>
                </div>
            );
        };

        const HomeView = ({ onNavigate }) => (
            <section className="relative min-h-screen flex flex-col justify-center pt-32 pb-20 px-6 overflow-hidden">
                {/* Background Image Layer */}
                <div className="absolute inset-0 z-0">
                    <img 
                        src="https://iili.io/fgdzHjs.jpg" 
                        alt="Wedding Background" 
                        className="w-full h-full object-cover object-center bg-zoom"
                    />
                    {/* Overlay để làm mờ ảnh giúp chữ dễ đọc hơn */}
                    <div className="absolute inset-0 bg-white/20 backdrop-blur-[1px]"></div>
                    <div className="absolute inset-0 bg-gradient-to-b from-[#FBF9F7]/90 via-transparent to-[#FBF9F7]/90"></div>
                </div>

                <div className="relative z-10 container mx-auto text-center">
                    <h1 className="text-5xl md:text-[140px] font-black tracking-[-0.06em] leading-[0.9] md:leading-[0.82] mb-8 md:mb-12 uppercase animate-in text-[#1A1A1A] title-entrance">
                        WEDDING <br/>
                        <span className="text-silk">REDEFINED.</span>
                    </h1>
                    <p className="text-lg md:text-2xl text-[#1A1A1A] max-w-2xl mx-auto mb-12 md:mb-20 font-semibold leading-relaxed animate-in drop-shadow-md" style={{animationDelay: '0.1s'}}>
                        Nền tảng tối ưu để tổ chức một đám cưới hiện đại. Tinh tế, chuyên nghiệp và nằm trọn trong tay bạn.
                    </p>
                    <div className="flex flex-col sm:flex-row justify-center gap-4 md:gap-6 animate-in" style={{animationDelay: '0.2s'}}>
                        <button onClick={() => onNavigate('planner')} className="px-10 md:px-12 py-4 md:py-5 bg-black text-white font-bold text-[10px] md:text-[11px] uppercase tracking-[0.3em] rounded-full hover:bg-stone-800 transition-all hover:scale-105 active:scale-95 shadow-2xl shadow-black/20">Khám phá Planner</button>
                        <button className="px-10 md:px-12 py-4 md:py-5 bg-white/90 backdrop-blur-sm border border-[#DDD] text-black font-bold text-[10px] md:text-[11px] uppercase tracking-[0.3em] rounded-full hover:bg-white transition-all active:scale-95">Xem mẫu thiệp</button>
                    </div>
                </div>
            </section>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [scrolled, setScrolled] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showRegister, setShowRegister] = useState(false);
            const [user, setUser] = useState(null);
            const firebase = useFirebase();

            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => {
                if (firebase) {
                    const { auth, onAuthStateChanged } = firebase;
                    const unsub = onAuthStateChanged(auth, (u) => {
                        setUser(u);
                        if (u) { setShowLogin(false); setShowRegister(false); }
                    });
                    return () => unsub();
                }
            }, [firebase]);

            const navigateTo = (tab) => {
                if (tab !== 'home' && !user) { setShowLogin(true); return; }
                setActiveTab(tab); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleLogout = async () => {
                if (firebase) {
                    await firebase.signOut(firebase.auth);
                    setActiveTab('home');
                }
            };
            
            const handleGoogleLogin = async () => {
                try {
                    const { auth, db, GoogleAuthProvider, signInWithPopup, doc, getDoc, setDoc } = firebase;
                    const provider = new GoogleAuthProvider();
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;

                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);

                    if (!docSnap.exists()) {
                         await setDoc(userDocRef, {
                            profile: { email: user.email, name: user.displayName },
                            weddingId: null,
                            isSetupComplete: false
                        });
                    }
                    setActiveTab('planner');
                } catch (e) {
                    alert("Đăng nhập thất bại: " + e.message);
                }
            };

            const LoginForm = () => {
                const [email, setEmail] = useState(""); const [password, setPassword] = useState(""); const [error, setError] = useState("");
                const handleLogin = async () => {
                    try {
                        if (!firebase) throw new Error("Đang kết nối...");
                        await firebase.signInWithEmailAndPassword(firebase.auth, email, password);
                        setActiveTab('planner');
                    } catch (e) { setError("Đăng nhập thất bại. Kiểm tra lại thông tin."); }
                };
                return (
                    <div className="space-y-4 pt-4">
                        <div className="space-y-2">
                            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-black" />
                            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Mật khẩu" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-black" />
                        </div>
                        {error && <p className="text-red-500 text-xs text-center font-bold">{error}</p>}
                        <button onClick={handleLogin} className="w-full py-4 bg-black text-white rounded-full font-black uppercase text-xs shadow-lg hover:bg-stone-800">Đăng nhập ngay</button>
                        <div className="relative flex py-2 items-center"><div className="flex-grow border-t border-stone-100"></div><span className="flex-shrink-0 mx-4 text-stone-400 text-[10px] font-bold uppercase tracking-widest">Hoặc</span><div className="flex-grow border-t border-stone-100"></div></div>
                        <button onClick={handleGoogleLogin} className="w-full py-4 bg-white border border-stone-200 text-stone-700 rounded-full text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-3 hover:bg-stone-50 transition-colors shadow-sm">
                            <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Google Login
                        </button>
                        <button onClick={() => {setShowLogin(false); setShowRegister(true);}} className="w-full text-center text-xs font-bold text-stone-400 mt-2 hover:text-black">Chưa có tài khoản? Đăng ký</button>
                    </div>
                );
            };

            const RegisterForm = () => {
                const [email, setEmail] = useState(""); const [password, setPassword] = useState(""); const [error, setError] = useState("");
                const handleRegister = async () => {
                    try {
                        const { user } = await firebase.createUserWithEmailAndPassword(firebase.auth, email, password);
                        await firebase.setDoc(firebase.doc(firebase.db, "users", user.uid), { profile: { email }, weddingId: null, isSetupComplete: false });
                        setActiveTab('planner');
                    } catch (e) { setError("Đăng ký không thành công. Thử lại sau."); }
                };
                return (
                    <div className="space-y-4 pt-4">
                        <div className="space-y-2">
                            <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" />
                            <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Mật khẩu" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl px-4 py-3 text-sm font-medium focus:outline-none focus:border-black" />
                        </div>
                        {error && <p className="text-red-500 text-xs text-center font-bold">{error}</p>}
                        <button onClick={handleRegister} className="w-full py-4 bg-black text-white rounded-full font-black uppercase text-xs shadow-lg">Đăng ký tài khoản</button>
                        <button onClick={() => {setShowRegister(false); setShowLogin(true);}} className="w-full text-center text-xs font-bold text-stone-400 mt-2 hover:text-black">Đã có tài khoản? Đăng nhập</button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    <div className="fixed top-6 left-0 w-full z-50 flex justify-center px-4 transition-all">
                        <nav className={`flex items-center justify-between px-6 py-2 rounded-full transition-all duration-500 ${scrolled ? 'w-full max-w-5xl bg-white/75 backdrop-blur-2xl border border-white/20 shadow-lg' : 'w-full max-w-6xl bg-white/40 backdrop-blur-md border border-white/10'}`}>
                            <div className="flex items-center gap-2 cursor-pointer group" onClick={() => navigateTo('home')}><div className="w-8 h-8 bg-black text-white rounded-full flex items-center justify-center"><Icons.Heart size={16} fill="currentColor" /></div><span className="text-lg font-black tracking-tighter uppercase">Weddy</span></div>
                            <div className="hidden md:flex items-center gap-1">{[{ id: 'home', label: 'Trang chủ' }, { id: 'planner', label: 'Lập kế hoạch' }, { id: 'invitation', label: 'Thiệp mời' }, { id: 'vendors', label: 'Dịch vụ' }].map((item) => (<button key={item.id} onClick={() => navigateTo(item.id)} className={`text-[10px] font-black uppercase tracking-[0.2em] px-5 py-2.5 rounded-full transition-all ${activeTab === item.id ? 'bg-black text-white shadow-lg' : 'text-stone-500 hover:text-black hover:bg-black/5'}`}>{item.label}</button>))}</div>
                            <div className="flex items-center gap-3">
                                {user ? <button onClick={handleLogout} className="px-6 py-2.5 bg-white border border-stone-200 text-stone-800 rounded-full text-[10px] font-black uppercase tracking-[0.25em] shadow-sm active:scale-95">Đăng xuất</button> : <button onClick={() => setShowLogin(true)} className="px-6 py-2.5 bg-black text-white rounded-full text-[10px] font-black uppercase tracking-[0.25em] shadow-xl active:scale-95">Đăng nhập</button>}
                            </div>
                        </nav>
                    </div>
                    <main>
                        {activeTab === 'home' && <HomeView onNavigate={navigateTo} />}
                        {activeTab === 'planner' && (user ? <FullPlannerApp currentUser={user} /> : <div className="h-screen flex flex-col gap-4 items-center justify-center text-stone-400 p-6 text-center"><Icons.Users size={48} className="opacity-20" /><p>Vui lòng đăng nhập để sử dụng tính năng Planner.</p><button onClick={() => setShowLogin(true)} className="px-8 py-3 bg-black text-white rounded-full text-xs font-bold uppercase shadow-lg">Đăng nhập ngay</button></div>)}
                        {activeTab === 'invitation' && <div className="py-60 text-center px-6"><p className="text-2xl font-black uppercase tracking-widest text-stone-300">Thiệp mời điện tử</p><p className="text-stone-400 mt-2">Tính năng đang được phát triển</p></div>}
                        {activeTab === 'vendors' && <div className="py-60 text-center px-6"><p className="text-2xl font-black uppercase tracking-widest text-stone-300">Mạng lưới dịch vụ</p><p className="text-stone-400 mt-2">Tính năng đang được phát triển</p></div>}
                    </main>
                    {activeTab !== 'planner' && <footer className="bg-white border-t border-stone-100 py-24 text-center"><div className="container mx-auto px-6"><span className="text-xl font-black tracking-tighter uppercase mb-6 block">Weddy Platform.</span><div className="flex flex-wrap justify-center gap-6 md:gap-10 text-[10px] font-black uppercase tracking-[0.3em] text-stone-400"><span className="hover:text-black cursor-pointer transition-colors">Instagram</span><span className="hover:text-black cursor-pointer transition-colors">Tiktok</span><span className="hover:text-black cursor-pointer transition-colors">Điều khoản</span></div><p className="mt-12 text-[9px] font-bold text-stone-300 uppercase tracking-widest">© 2024 Weddy Tech Collective. All rights reserved.</p></div></footer>}
                    <Modal isOpen={showLogin} onClose={() => setShowLogin(false)} title="Đăng nhập"><LoginForm /></Modal>
                    <Modal isOpen={showRegister} onClose={() => setShowRegister(false)} title="Đăng ký tài khoản"><RegisterForm /></Modal>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
