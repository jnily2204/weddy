<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weddy - Nền tảng quản lý đám cưới tinh tế</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.8s ease-out forwards; }
        
        /* Mobile Menu Animation */
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .mobile-menu-in { animation: slideDown 0.3s ease-out forwards; }

        /* Wedding Title Animations - REFINED & UNIQUE */
        @keyframes reveal-up-blur {
            0% { opacity: 0; transform: translateY(100%) scale(1.1); filter: blur(20px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }
        
        @keyframes silk-shine {
            0% { background-position: 0% 50%; }
            100% { background-position: 200% 50%; }
        }

        .title-entrance {
            animation: reveal-up-blur 1.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .text-silk {
            background: linear-gradient(
                90deg, 
                #806233 0%,   /* Vàng đồng đậm */
                #CC9C53 25%,  /* Vàng kim loại */
                #FFECB3 50%,  /* Ánh sáng vàng nhạt */
                #CC9C53 75%,  /* Vàng kim loại */
                #806233 100%  /* Vàng đồng đậm */
            );
            background-size: 200% auto;
            color: #000;
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: silk-shine 5s linear infinite;
        }

        @keyframes subtle-zoom {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }
        .bg-zoom { animation: subtle-zoom 20s infinite alternate; }
    </style>
</head>
<body class="bg-[#F0EBE5] text-stone-800 transition-colors duration-500">
    <div id="root"></div>

    <!-- FIREBASE SETUP -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js";

        // Cấu hình Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD_F3OI5GexlAqgC8TZ1CN1JB5O3RacQqs",
            authDomain: "weddyvn.firebaseapp.com",
            projectId: "weddyvn",
            storageBucket: "weddyvn.firebasestorage.app",
            messagingSenderId: "504927899297",
            appId: "1:504927899297:web:1a3d3a1b6cfafe0716aae0",
            measurementId: "G-KK4B3RXVNV"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            
            window.firebaseServices = { 
                auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
                signOut, onAuthStateChanged, doc, setDoc, updateDoc, onSnapshot, 
                getDoc, GoogleAuthProvider, signInWithPopup 
            };
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase init error:", e);
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- GLOBAL UTILS ---
        const formatCurrencyInput = (value) => {
            if(!value) return "";
            const raw = value.toString().replace(/\D/g, '');
            return raw.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        };

        const parseCurrencyInput = (value) => {
            if(!value) return 0;
            return parseInt(value.toString().replace(/\./g, '')) || 0;
        };

        const formatMoneyDisplay = (amount) => {
            if (!amount || amount === 0) return "0 VNĐ";
            if (amount >= 1000000000) {
                return (amount / 1000000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 }) + " Tỷ VNĐ";
            }
            return (amount / 1000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 }) + " Triệu VNĐ";
        };
        
        const generateCode = () => Math.floor(100000 + Math.random() * 900000).toString();

        const calculateDaysLeft = (dateString) => {
            if (!dateString || dateString === "Chưa đặt") return "---";
            const eventDate = new Date(dateString);
            const today = new Date();
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return diffDays > 0 ? `${diffDays} NGÀY NỮA` : (diffDays === 0 ? "HÔM NAY" : "ĐÃ QUA");
        };

        const useFirebase = () => {
            const [services, setServices] = useState(null);
            useEffect(() => {
                const interval = setInterval(() => {
                    if (window.firebaseServices) {
                        setServices(window.firebaseServices);
                        clearInterval(interval);
                    }
                }, 100);
                return () => clearInterval(interval);
            }, []);
            return services;
        };

        // --- ICON SYSTEM ---
        const Icon = ({ children, size = 24, color = "currentColor", className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Icons = {
            Heart: (p) => <Icon {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12" /></Icon>,
            Users: (p) => <Icon {...p}><g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></g></Icon>,
            Plus: (p) => <Icon {...p}><g><path d="M5 12h14" /><path d="M12 5v14" /></g></Icon>,
            Layout: (p) => <Icon {...p}><g><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M3 9h18" /><path d="M9 21V9" /></g></Icon>,
            DollarSign: (p) => <Icon {...p}><g><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></g></Icon>,
            X: (p) => <Icon {...p}><g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g></Icon>,
            ChevronRight: (p) => <Icon {...p}><path d="m9 18 6-6-6-6" /></Icon>,
            Link: (p) => <Icon {...p}><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></g></Icon>,
            Share: (p) => <Icon {...p}><g><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" x2="15.42" y1="13.51" y2="17.49" /><line x1="15.41" x2="8.59" y1="6.51" y2="10.49" /></g></Icon>,
            Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></Icon>,
            Trash: (p) => <Icon {...p}><g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></g></Icon>,
            ArrowUpRight: (p) => <Icon {...p}><g><path d="M7 7h10v10" /><path d="M7 17 17 7" /></g></Icon>,
            Bell: (p) => <Icon {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /></Icon>,
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-stone-900/60 backdrop-blur-md transition-opacity animate-in fade-in" onClick={onClose}></div>
                    <div className="relative bg-white/95 backdrop-blur-xl rounded-[2rem] p-6 md:p-8 w-full max-w-md shadow-2xl border border-stone-100 animate-in zoom-in-95 duration-300 flex flex-col max-h-[90vh] overflow-y-auto hide-scrollbar text-stone-700">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-lg font-black uppercase tracking-widest text-stone-800">{title}</h3>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 text-stone-400 hover:bg-stone-100 hover:text-stone-800 transition-colors"><Icons.X size={16} /></button>
                        </div>
                        <div>{children}</div>
                    </div>
                </div>
            );
        };

        const GettingStartedWizard = ({ onComplete, onSkip }) => {
            const [step, setStep] = useState(0);
            const [data, setData] = useState({ role: "", date: "", location: "", budget: "" });
            const handleNext = () => setStep(step + 1);
            const handleFinish = () => onComplete({...data, budget: parseCurrencyInput(data.budget)});

            const steps = [
                { title: "Bạn là?", content: (<div className="grid grid-cols-2 gap-4 mt-4">{["Cô dâu", "Chú rể"].map((role) => (<button key={role} onClick={() => setData({ ...data, role })} className={`p-6 rounded-2xl border-2 transition-all ${data.role === role ? 'border-stone-500 bg-stone-500 text-white' : 'border-stone-200 hover:border-stone-500 bg-white/50'}`}><span className="block text-xl font-bold">{role}</span></button>))}</div>) },
                { title: "Ngày trọng đại?", content: (<div className="mt-4"><input type="date" value={data.date} onChange={(e) => setData({ ...data, date: e.target.value })} className="w-full bg-white/70 border border-stone-200 rounded-xl px-5 py-4 text-lg font-bold focus:outline-none focus:border-stone-500"/></div>) },
                { title: "Tổ chức ở đâu?", content: (<div className="mt-4"><input type="text" value={data.location} onChange={(e) => setData({ ...data, location: e.target.value })} placeholder="Nhà hàng, Tại gia, Ngoài trời..." className="w-full bg-white/70 border border-stone-200 rounded-xl px-5 py-4 text-lg font-bold focus:outline-none focus:border-stone-500"/></div>) },
                { title: "Ngân sách dự trù?", content: (<div className="mt-4"><div className="relative"><input type="text" value={data.budget} onChange={(e) => setData({ ...data, budget: formatCurrencyInput(e.target.value) })} placeholder="300.000.000" className="w-full bg-white/70 border border-stone-200 rounded-xl px-5 py-4 pl-4 pr-16 text-lg font-bold focus:outline-none focus:border-stone-500"/><div className="absolute right-4 top-1/2 -translate-y-1/2 text-stone-400 font-bold">VNĐ</div></div></div>) }
            ];
            const currentStep = steps[step];
            return (
                <div className="fixed inset-0 z-[200] bg-[#F0EBE5] flex flex-col animate-in fade-in">
                    <div className="flex justify-end p-6"><button onClick={onSkip} className="text-xs font-bold uppercase tracking-widest text-stone-400 hover:text-stone-700">Bỏ qua</button></div>
                    <div className="flex-1 flex flex-col justify-center px-8 max-w-lg mx-auto w-full">
                        <div className="mb-8"><div className="flex gap-2 mb-6 justify-center">{steps.map((_, i) => (
                            <div key={i} className={`h-1.5 rounded-full transition-all duration-500 ${i <= step ? 'bg-stone-500 w-8' : 'bg-stone-200 w-4'}`}></div>
                        ))}</div><h2 className="text-3xl md:text-4xl font-black tracking-tighter text-center mb-2 text-stone-700">{currentStep.title}</h2></div>
                        {currentStep.content}
                        <div className="mt-12">{step < steps.length - 1 ? (<button onClick={handleNext} disabled={(step === 0 && !data.role) || (step === 1 && !data.date) || (step === 2 && !data.location)} className="w-full py-4 bg-stone-500 text-white rounded-full text-xs font-black uppercase tracking-widest shadow-xl disabled:opacity-50 hover:bg-stone-400 transition-colors">Tiếp tục</button>) : (<button onClick={handleFinish} className="w-full py-4 bg-emerald-500 text-white rounded-full text-xs font-black uppercase tracking-widest shadow-xl hover:bg-emerald-500 transition-all">Hoàn tất & Tạo Planner</button>)}</div>
                    </div>
                </div>
            );
        };

        const PlannerOverview = ({ spentAmount, completedTasks, totalTasks, guestCount, budgetLimit, weddingDate, role, activities, onInvite, onEditBudget, onOpenGuests }) => {
            const displayBudgetLimit = budgetLimit || 300000000;
            const percentage = Math.min((spentAmount / displayBudgetLimit) * 100, 100);
            const taskPercentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0;
            const remaining = (displayBudgetLimit - spentAmount);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 animate-in text-stone-700">
                    <div className="lg:col-span-2 space-y-6 md:space-y-8">
                        {/* Banner Mời bạn đời */}
                        <div className="bg-white/40 backdrop-blur-md p-6 rounded-[2rem] border border-stone-200/50 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-rose-100/50 rounded-full flex items-center justify-center text-rose-500"><Icons.Heart size={20} fill="currentColor"/></div>
                                <div><h4 className="font-bold text-stone-800">Ví chung đôi mình</h4><p className="text-xs text-stone-500">Đồng bộ kế hoạch và ngân sách với người ấy.</p></div>
                            </div>
                            <button onClick={onInvite} className="w-full md:w-auto px-6 py-3 bg-white border border-stone-200 text-stone-700 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2"><Icons.Share size={14}/> Mời bạn đời</button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 text-stone-700">
                            <div className="bg-white/80 p-6 md:p-10 rounded-[2rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48 md:h-52">
                                <div className="flex justify-between items-start"><span className="text-[10px] font-black uppercase tracking-[0.2em] text-stone-400">Tiến độ</span><div className="w-10 h-10 bg-stone-50/50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Check size={18}/></div></div>
                                <div><div className="flex items-baseline gap-2 mb-4"><span className="text-4xl md:text-6xl font-black text-stone-600">{completedTasks}</span><span className="text-stone-400 font-bold uppercase text-[11px]">/ {totalTasks} hoàn thành</span></div><div className="w-full h-1.5 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-stone-400 transition-all duration-700" style={{width: `${taskPercentage}%`}}></div></div></div>
                            </div>
                            <div 
                                onClick={onOpenGuests} 
                                className="bg-white/80 p-6 md:p-10 rounded-[2rem] border border-stone-100 shadow-sm flex flex-col justify-between h-48 md:h-52 cursor-pointer hover:border-stone-300 transition-all active:scale-[0.98]"
                            >
                                <div className="flex justify-between items-start"><span className="text-[10px] font-black uppercase tracking-[0.2em] text-stone-400">Khách mời</span><div className="w-10 h-10 bg-stone-50/50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Users size={18}/></div></div>
                                <div className="flex items-baseline gap-2"><span className="text-4xl md:text-6xl font-black text-stone-600">{guestCount}</span><span className="text-stone-400 font-bold uppercase text-[11px]">Người</span></div>
                            </div>
                        </div>

                        {/* Tài chính tổng quát - Muted colors to reduce glare */}
                        <div className="bg-stone-500 p-8 md:p-12 rounded-[2rem] text-white relative overflow-hidden shadow-xl group">
                            <div className="absolute top-0 right-0 w-80 h-80 bg-stone-400 rounded-full blur-[150px] opacity-20 -translate-y-1/2 translate-x-1/2 group-hover:opacity-30 transition-opacity duration-700"></div>
                            <div className="relative z-10"><h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-white/70 mb-8">Tài chính tổng quát ({role || 'Bạn'})</h3>
                                <div className="flex flex-col md:flex-row justify-between gap-8">
                                    <div className="flex-1">
                                        <div className="text-[10px] uppercase font-black text-white/30 mb-2">Đã chi tiêu</div>
                                        <div className="text-5xl md:text-7xl font-black tracking-tighter">{formatMoneyDisplay(spentAmount)}</div>
                                        <div className="w-full h-1.5 bg-white/10 rounded-full overflow-hidden mt-6 mb-4">
                                            <div className="h-full bg-white transition-all duration-700" style={{width: `${percentage}%`}}></div>
                                        </div>
                                        <div className="flex items-center gap-2 group/budget inline-flex cursor-pointer" onClick={onEditBudget}>
                                            <p className="text-[12px] font-black text-white/80 uppercase tracking-widest">Ngân sách: {formatMoneyDisplay(displayBudgetLimit)}</p>
                                            <Icons.Edit size={14} className="text-white/20 group-hover/budget:text-white transition-colors" />
                                        </div>
                                    </div>
                                    <div className="md:w-48 flex flex-col gap-4 justify-center">
                                        <div className="bg-white/10 backdrop-blur-sm p-6 rounded-3xl border border-white/5 text-center md:text-left shadow-sm">
                                            <p className="text-[9px] font-black text-white/40 uppercase mb-1">Còn lại</p>
                                            <p className="text-xl font-bold">{formatMoneyDisplay(remaining)}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Sidebar Hoạt động */}
                    <div className="bg-white/60 backdrop-blur-md p-6 md:p-10 rounded-[2rem] border border-stone-100 shadow-sm h-full flex flex-col">
                        <h3 className="text-[11px] font-black uppercase tracking-[0.2em] mb-8 text-stone-700 border-b border-stone-100 pb-6">Hoạt động</h3>
                        <div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar max-h-[500px]">
                            {activities && activities.length > 0 ? activities.map((act, i) => (
                                <div key={i} className="flex gap-4 items-start group animate-in slide-in-from-right-4" style={{animationDelay: `${i * 0.1}s`}}>
                                    <div className="w-10 h-10 bg-stone-50 rounded-2xl flex items-center justify-center shrink-0 group-hover:bg-stone-500 group-hover:text-white transition-colors">
                                        <Icons.ArrowUpRight size={16} className="text-stone-300 group-hover:text-white" />
                                    </div>
                                    <div>
                                        <p className="text-[13px] font-bold text-stone-800 leading-snug">{act.text}</p>
                                        <p className="text-[10px] font-black text-stone-400 uppercase tracking-widest mt-1">{act.time}</p>
                                    </div>
                                </div>
                            )) : (
                                <p className="text-sm text-stone-400 italic font-medium">Chưa có hoạt động mới.</p>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const PlannerBudget = ({ tasks, onAddExpense }) => {
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [title, setTitle] = useState(""); const [cost, setCost] = useState(""); const [paid, setPaid] = useState(""); const [category, setCategory] = useState("Đặt tiệc cưới"); const [customCategory, setCustomCategory] = useState("");
            const expenses = tasks.filter(t => t.cost > 0);
            const totalBudget = expenses.reduce((acc, curr) => acc + curr.cost, 0);
            const totalPaid = expenses.reduce((acc, curr) => acc + (curr.paid || (curr.status === 'done' ? curr.cost : 0)), 0);
            const remaining = totalBudget - totalPaid;
            const handleSave = () => { if (title.trim() && cost) { const numCost = parseCurrencyInput(cost); const numPaid = parseCurrencyInput(paid); const finalCategory = category === "Khác" ? (customCategory || "Khác") : category; onAddExpense({ title, tag: finalCategory, status: numPaid >= numCost ? 'done' : 'pending', cost: numCost, paid: numPaid }); setTitle(""); setCost(""); setPaid(""); setCategory("Đặt tiệc cưới"); setCustomCategory(""); setIsModalOpen(false); } };
            return (
                <div className="max-w-4xl mx-auto space-y-6 md:space-y-8 animate-in text-stone-700">
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                        <div className="bg-white p-6 md:p-8 rounded-[2rem] border border-stone-100 shadow-sm"><p className="text-[10px] font-black uppercase tracking-widest text-stone-400 mb-2">Tổng chi phí dự kiến</p><p className="text-2xl font-black text-stone-800">{formatMoneyDisplay(totalBudget)}</p></div>
                        <div className="bg-stone-500 text-white p-6 md:p-8 rounded-[2rem] shadow-xl"><p className="text-[10px] font-black uppercase tracking-widest text-white/50 mb-2">Đã thanh toán / Cọc</p><p className="text-2xl font-black">{formatMoneyDisplay(totalPaid)}</p></div>
                        <div className="bg-white p-6 md:p-8 rounded-[2rem] border border-stone-100 shadow-sm"><p className="text-[10px] font-black uppercase tracking-widest text-stone-400 mb-2">Cần thanh toán tiếp</p><p className="text-2xl font-black text-rose-500">{formatMoneyDisplay(remaining)}</p></div>
                    </div>
                    <div className="bg-white rounded-[2rem] border border-stone-100 overflow-hidden shadow-sm">
                        <div className="p-6 md:p-8 border-b border-stone-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div><h3 className="text-xl font-black uppercase tracking-widest text-stone-800">Chi tiết khoản chi</h3><span className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Tự động từ công việc</span></div>
                            <button onClick={() => setIsModalOpen(true)} className="w-full md:w-auto px-5 py-3 bg-stone-500 text-white rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-stone-400 transition-all active:scale-95 shadow-lg"><Icons.Plus size={12}/> Thêm Khoản Chi</button>
                        </div>
                        <div className="divide-y divide-stone-50">
                            {expenses.length === 0 ? <div className="p-20 text-center text-stone-400 font-medium italic">Chưa có khoản chi nào.</div> : expenses.map((item, i) => {
                                const isPaidOff = (item.paid || 0) >= item.cost || item.status === 'done';
                                return (
                                    <div key={i} className="p-6 flex flex-col md:flex-row md:items-center justify-between hover:bg-[#FBF9F7] transition-colors gap-4 text-stone-700">
                                        <div className="flex items-center gap-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${isPaidOff ? 'bg-stone-500 text-white' : 'bg-stone-100 text-stone-400'}`}><Icons.DollarSign size={16} /></div><div><h4 className="font-bold text-sm md:text-base text-stone-800">{item.title}</h4><p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest">{item.tag}</p></div></div>
                                        <div className="text-right">
                                            <p className="font-black text-sm md:text-lg text-stone-800">{formatMoneyDisplay(item.cost)}</p>
                                            <div className="flex flex-col md:flex-row items-end gap-1 md:gap-2">
                                                 <span className={`text-[9px] font-bold uppercase tracking-widest px-2 py-1 md:px-3 md:py-1.5 rounded-full inline-block ${isPaidOff ? 'bg-emerald-100 text-emerald-700' : 'bg-orange-100 text-orange-600'}`}>{isPaidOff ? 'Đã xong' : `Đã trả: ${formatMoneyDisplay(item.paid || 0)}`}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        const PlannerTasks = ({ tasks, onAddTask, onToggleTask, onDeleteTask }) => {
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [newTaskTitle, setNewTaskTitle] = useState(""); const [newTaskCategory, setNewTaskCategory] = useState("Đặt tiệc cưới"); const [customTaskCategory, setCustomTaskCategory] = useState(""); const [newTaskCost, setNewTaskCost] = useState("");
            const handleAddTask = () => { if (newTaskTitle && newTaskTitle.trim() !== "") { const finalTag = newTaskCategory === "Khác" ? (customTaskCategory || "Khác") : newTaskCategory; onAddTask({ title: newTaskTitle, tag: finalTag, status: "pending", cost: newTaskCost ? parseCurrencyInput(newTaskCost) : 0 }); setNewTaskTitle(""); setNewTaskCategory("Đặt tiệc cưới"); setCustomTaskCategory(""); setNewTaskCost(""); setIsAddModalOpen(false); } };
            const pendingTasks = tasks.filter(t => t.status !== 'done');
            const completedTasks = tasks.filter(t => t.status === 'done');
            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-in text-stone-700">
                    <div className="flex justify-between items-center px-4"><h3 className="text-2xl font-black uppercase tracking-tighter text-stone-800">Công việc</h3><button onClick={() => setIsAddModalOpen(true)} className="px-6 md:px-8 py-3 bg-stone-500 text-white rounded-full text-[11px] font-black uppercase tracking-widest shadow-xl hover:bg-stone-400 transition-all active:scale-95"><Icons.Plus size={16}/> Thêm việc</button></div>
                    <div className="bg-white rounded-[2rem] border border-stone-100 overflow-hidden shadow-sm">
                        {pendingTasks.length > 0 ? pendingTasks.map((t, idx) => (
                            <div key={idx} onClick={() => onToggleTask(tasks.indexOf(t))} className="group p-6 flex items-center border-b border-stone-50 last:border-0 hover:bg-[#FBF9F7] transition-all cursor-pointer text-stone-800">
                                <div className={`w-6 h-6 rounded-full border-2 mr-6 flex items-center justify-center shrink-0 ${t.status === 'done' ? 'bg-stone-500 border-stone-500' : 'border-stone-200 group-hover:border-stone-500'}`}>{t.status === 'done' && <Icons.Check size={12} className="text-white" />}</div>
                                <div className="flex-1"><h4 className="text-base font-bold">{t.title}</h4><span className="text-[9px] font-black uppercase text-stone-400 tracking-widest">{t.tag}</span></div>
                                <button onClick={(e) => { e.stopPropagation(); onDeleteTask(tasks.indexOf(t)); }} className="p-2 text-stone-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"><Icons.Trash size={18} /></button>
                            </div>
                        )) : <div className="p-12 text-center text-stone-300 italic font-medium">Tất cả công việc đã hoàn thành.</div>}
                    </div>
                </div>
            );
        };

        const PlannerGuests = ({ guests, onAddGuest, onDeleteGuest, onImportGuests }) => {
            const [isAddModalOpen, setIsAddModalOpen] = useState(false);
            const [name, setName] = useState(""); const [rel, setRel] = useState("Bạn bè"); const [phone, setPhone] = useState("");
            const fileInputRef = useRef(null);
            const handleAdd = () => { if (name.trim()) { onAddGuest({ name, relationship: rel, phone, id: Date.now() }); setName(""); setPhone(""); setIsAddModalOpen(false); } };
            const handleFileChange = (e) => { const file = e.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (evt) => { try { const bstr = evt.target.result; const wb = XLSX.read(bstr, { type: 'binary' }); const ws = wb.Sheets[wb.SheetNames[0]]; const data = XLSX.utils.sheet_to_json(ws, { header: 1 }); const imported = data.slice(1).map((row, idx) => ({ id: Date.now() + idx, name: row[0] || "Khách mời", relationship: row[1] || "Khác", phone: row[2] || "" })).filter(g => g.name); onImportGuests(imported); } catch (err) { alert("Lỗi đọc file Excel."); } }; reader.readAsBinaryString(file); } };
            return (
                <div className="space-y-6 pt-2 text-stone-700">
                    <div className="flex justify-between items-center mb-4">
                        <p className="text-xs font-bold text-stone-400 uppercase tracking-widest">Danh sách ({guests.length})</p>
                        <div className="flex gap-2">
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".xlsx, .xls, .csv" />
                            <button onClick={() => fileInputRef.current.click()} className="p-2 bg-stone-50 text-stone-500 rounded-xl hover:bg-stone-100 transition-all" title="Nhập Excel"><Icons.Layout size={16}/></button>
                            <button onClick={() => setIsAddModalOpen(true)} className="px-4 py-2 bg-stone-500 text-white rounded-full text-[10px] font-black uppercase tracking-widest shadow-md hover:bg-stone-400 transition-all">Thêm mới</button>
                        </div>
                    </div>
                    <div className="bg-stone-50/50 rounded-2xl border border-stone-100 overflow-hidden divide-y divide-stone-50">
                        {guests.length === 0 ? <div className="p-12 text-center text-stone-300 italic font-medium">Chưa có khách mời nào.</div> : guests.map((g) => (
                            <div key={g.id} className="p-4 flex items-center justify-between hover:bg-white transition-colors group text-stone-800">
                                <div className="flex items-center gap-3">
                                    <div className="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-500 font-bold text-[10px]">{g.name.charAt(0).toUpperCase()}</div>
                                    <div><h4 className="font-bold text-sm">{g.name}</h4><p className="text-[9px] font-bold text-stone-400 uppercase tracking-widest">{g.relationship}</p></div>
                                </div>
                                <button onClick={() => onDeleteGuest(g.id)} className="p-2 text-stone-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all"><Icons.Trash size={16} /></button>
                            </div>
                        ))}
                    </div>
                    {isAddModalOpen && (
                        <div className="fixed inset-0 z-[110] flex items-center justify-center p-4">
                            <div className="absolute inset-0 bg-stone-900/40 backdrop-blur-sm" onClick={() => setIsAddModalOpen(false)}></div>
                            <div className="relative bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl border border-stone-100 animate-in zoom-in-95">
                                <div className="flex justify-between items-center mb-6">
                                    <h4 className="text-sm font-black uppercase tracking-widest text-stone-800">Thêm khách mời</h4>
                                    <button onClick={() => setIsAddModalOpen(false)} className="text-stone-400 hover:text-stone-800"><Icons.X size={16} /></button>
                                </div>
                                <div className="space-y-4">
                                    <input type="text" value={name} onChange={(e) => setName(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm font-medium" placeholder="Tên khách mời" />
                                    <div className="grid grid-cols-2 gap-3">
                                        <select value={rel} onChange={(e) => setRel(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm appearance-none"><option value="Gia đình">Gia đình</option><option value="Bạn bè">Bạn bè</option><option value="Đồng nghiệp">Đồng nghiệp</option><option value="Khác">Khác</option></select>
                                        <input type="tel" value={phone} onChange={(e) => setPhone(e.target.value)} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm font-medium" placeholder="SĐT" />
                                    </div>
                                    <button onClick={handleAdd} className="w-full py-4 bg-stone-500 text-white rounded-full font-black uppercase text-[10px] shadow-lg hover:bg-stone-400 transition-all">Lưu lại</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const FullPlannerApp = ({ currentUser }) => {
            const [subTab, setSubTab] = useState('overview');
            const [userData, setUserData] = useState(null);
            const [isJoinModalOpen, setIsJoinModalOpen] = useState(false);
            const [isBudgetModalOpen, setIsBudgetModalOpen] = useState(false);
            const [isGuestModalOpen, setIsGuestModalOpen] = useState(false);
            const [joinCode, setJoinCode] = useState("");
            const [tempBudget, setTempBudget] = useState("");
            const firebase = useFirebase();

            useEffect(() => {
                if (!firebase || !currentUser) return;
                const { db, onSnapshot, doc, setDoc, getDoc, updateDoc } = firebase;
                const userRef = doc(db, "users", currentUser.uid);
                let unsubscribeWedding = null;
                const unsubUser = onSnapshot(userRef, async (userSnap) => {
                    if (userSnap.exists()) {
                        const userVal = userSnap.data();
                        let weddingId = userVal.weddingId;
                        if (!weddingId) {
                            weddingId = currentUser.uid;
                            await updateDoc(userRef, { weddingId, isSetupComplete: userVal.isSetupComplete || false });
                            const weddingRef = doc(db, "weddings", weddingId);
                            const wSnap = await getDoc(weddingRef);
                            if (!wSnap.exists()) await setDoc(weddingRef, { tasks: [], guests: [], activities: [], budgetLimit: 300000000, owners: [currentUser.uid] });
                        }
                        if (unsubscribeWedding) unsubscribeWedding();
                        unsubscribeWedding = onSnapshot(doc(db, "weddings", weddingId), (wSnap) => {
                            if (wSnap.exists()) setUserData({ ...wSnap.data(), weddingId, profile: userVal.profile, isSetupComplete: userVal.isSetupComplete });
                        });
                    } else {
                        await setDoc(userRef, { profile: { email: currentUser.email, name: currentUser.displayName }, weddingId: null, isSetupComplete: false });
                    }
                });
                return () => { unsubUser(); if (unsubscribeWedding) unsubscribeWedding(); };
            }, [firebase, currentUser]);

            if (!userData) return <div className="h-screen flex items-center justify-center"><div className="w-8 h-8 border-4 border-stone-400 border-t-transparent rounded-full animate-spin"></div></div>;

            const tasks = userData.tasks || [];
            const guests = userData.guests || [];
            const activities = userData.activities || [];
            const spentAmount = tasks.reduce((acc, t) => acc + (t.paid || (t.status === 'done' ? t.cost : 0)), 0);
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(t => t.status === 'done').length;
            const guestCount = guests.length;
            const weddingDate = userData.profile?.weddingDate || "Chưa đặt";
            const role = userData.profile?.role;

            const updateWedding = async (key, val) => await firebase.updateDoc(firebase.doc(firebase.db, "weddings", userData.weddingId), { [key]: val });
            const addActivity = async (text) => { const newActivity = { text, time: new Date().toLocaleTimeString('vi-VN') }; const newActivities = [newActivity, ...(userData.activities || [])].slice(0, 15); await updateWedding('activities', newActivities); };
            
            const onAddTask = async (t) => { await updateWedding('tasks', [t, ...tasks]); addActivity(`Thêm công việc: ${t.title}`); };
            const onToggleTask = async (idx) => { const nt = [...tasks]; const status = nt[idx].status === 'done' ? 'pending' : 'done'; nt[idx].status = status; await updateWedding('tasks', nt); if (status === 'done') addActivity(`Hoàn thành: ${nt[idx].title}`); };
            const onDeleteTask = async (idx) => { const task = tasks[idx]; await updateWedding('tasks', tasks.filter((_,i) => i !== idx)); addActivity(`Xóa công việc: ${task.title}`); };
            const onAddGuest = async (g) => { await updateWedding('guests', [g, ...guests]); addActivity(`Thêm khách mời: ${g.name}`); };
            const onDeleteGuest = async (id) => { const g = guests.find(x => x.id === id); await updateWedding('guests', guests.filter(x => x.id !== id)); addActivity(`Xóa khách mời: ${g.name}`); };
            const onImportGuests = async (imp) => { await updateWedding('guests', [...imp, ...guests]); addActivity(`Import ${imp.length} khách mời từ Excel`); };

            return (
                <div className="pt-24 pb-32 md:pt-32 container mx-auto px-4 md:px-12 max-w-7xl animate-in text-stone-700">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-10 md:mb-16 gap-6">
                         <div className="flex-1 w-full"><span className="text-[10px] font-black uppercase tracking-[0.3em] text-[#B5A896] mb-3 block">Kế hoạch của {userData.profile?.name || 'bạn'}</span><h2 className="text-4xl md:text-5xl font-black tracking-tighter uppercase leading-tight text-stone-800">Weddy Planner</h2></div>
                        <div className="flex flex-col sm:flex-row gap-4 w-full md:w-auto">
                            <div className="bg-white/80 backdrop-blur-md p-6 rounded-[2rem] border border-stone-100 shadow-sm flex items-center gap-6 flex-1 min-w-[280px]">
                                <div className="w-12 h-12 bg-rose-100/50 rounded-full flex items-center justify-center text-rose-500 shadow-inner"><Icons.Heart size={20} fill="currentColor"/></div>
                                <div className="flex-1">
                                    <p className="text-[9px] font-black uppercase tracking-widest text-stone-400 mb-1">Ngày trọng đại</p>
                                    <div className="flex items-baseline gap-3"><p className="text-xl font-bold text-stone-700">{weddingDate}</p><p className="text-xs font-bold text-rose-500 whitespace-nowrap">{calculateDaysLeft(weddingDate)}</p></div>
                                </div>
                            </div>
                            <button onClick={() => setIsJoinModalOpen(true)} className="bg-stone-500 text-white p-6 rounded-[2rem] shadow-xl hover:bg-stone-400 transition-all flex items-center justify-center gap-4 active:scale-95 group">
                                <Icons.Link size={20} className="group-hover:rotate-12 transition-transform"/><span className="text-xs font-black uppercase tracking-widest">Nhập mã kết nối</span>
                            </button>
                        </div>
                    </div>

                    <div className="flex justify-center mb-10 md:mb-16 -mx-4 px-4 md:mx-0 md:px-0">
                        <div className="bg-white/40 p-2 rounded-full flex w-full max-w-6xl border border-white/60 backdrop-blur-sm overflow-x-auto hide-scrollbar">
                            {[{ id: 'overview', label: 'Tổng quan', icon: Icons.Layout }, { id: 'tasks', label: 'Công việc', icon: Icons.Check }, { id: 'budget', label: 'Ngân sách', icon: Icons.DollarSign }, { id: 'guests', label: 'Khách mời', icon: Icons.Users }].map((tab) => (
                                <button key={tab.id} onClick={() => setSubTab(tab.id)} className={`flex-1 flex items-center justify-center gap-3 px-6 md:px-10 py-5 rounded-full text-xs md:text-sm font-black uppercase tracking-widest transition-all whitespace-nowrap ${subTab === tab.id ? 'bg-stone-500 text-white shadow-xl scale-105' : 'text-stone-400 hover:text-stone-700 hover:bg-white/50'}`}><tab.icon size={18} strokeWidth={3} />{tab.label}</button>
                            ))}
                        </div>
                    </div>

                    <div>
                        {subTab === 'overview' && <PlannerOverview spentAmount={spentAmount} completedTasks={completedTasks} totalTasks={totalTasks} guestCount={guestCount} budgetLimit={userData.budgetLimit} role={role} weddingDate={weddingDate} activities={activities} onInvite={() => alert("Mã kết nối: " + generateCode())} onEditBudget={() => { setTempBudget(formatCurrencyInput(userData.budgetLimit)); setIsBudgetModalOpen(true); }} onOpenGuests={() => setIsGuestModalOpen(true)} />}
                        {subTab === 'tasks' && <PlannerTasks tasks={tasks} onAddTask={onAddTask} onToggleTask={onToggleTask} onDeleteTask={onDeleteTask} />}
                        {subTab === 'budget' && <PlannerBudget tasks={tasks} onAddExpense={onAddTask} />}
                        {subTab === 'guests' && <PlannerGuests guests={guests} onAddGuest={onAddGuest} onDeleteGuest={onDeleteGuest} onImportGuests={onImportGuests} />}
                    </div>

                    <Modal isOpen={isJoinModalOpen} onClose={() => setIsJoinModalOpen(false)} title="Kết nối cặp đôi">
                        <div className="text-center space-y-8 pt-4">
                            <input type="text" value={joinCode} onChange={(e) => setJoinCode(e.target.value.replace(/[^0-9]/g, '').slice(0, 6))} placeholder="000000" className="w-full text-center text-5xl font-black tracking-[0.3em] py-8 bg-stone-50 border-2 border-dashed border-stone-200 rounded-3xl focus:border-stone-500 focus:bg-white focus:outline-none transition-all text-stone-700" maxLength="6" />
                            <button onClick={async () => { const inviteSnap = await firebase.getDoc(firebase.doc(firebase.db, "invites", joinCode)); if (inviteSnap.exists()) { await firebase.updateDoc(firebase.doc(firebase.db, "users", currentUser.uid), { weddingId: inviteSnap.data().weddingId }); setIsJoinModalOpen(false); } else alert("Mã không hợp lệ!"); }} disabled={joinCode.length !== 6} className="w-full py-5 bg-stone-500 text-white rounded-full text-xs font-black uppercase tracking-[0.2em] shadow-xl hover:bg-stone-400 transition-all disabled:opacity-50">Xác nhận kết nối</button>
                        </div>
                    </Modal>

                    <Modal isOpen={isBudgetModalOpen} onClose={() => setIsBudgetModalOpen(false)} title="Cập nhật ngân sách">
                        <div className="space-y-6 pt-4 text-stone-700">
                            <input type="text" value={tempBudget} onChange={(e) => setTempBudget(formatCurrencyInput(e.target.value))} className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 font-bold text-lg" placeholder="0" />
                            <button onClick={async () => { const nb = parseCurrencyInput(tempBudget); if (nb > 0) { await updateWedding('budgetLimit', nb); setIsBudgetModalOpen(false); } }} className="w-full py-4 bg-stone-500 text-white rounded-full font-black uppercase text-xs shadow-lg hover:bg-stone-400 transition-all">Lưu ngân sách</button>
                        </div>
                    </Modal>

                    <Modal isOpen={isGuestModalOpen} onClose={() => setIsGuestModalOpen(false)} title="Danh sách khách mời">
                        <PlannerGuests guests={guests} onAddGuest={onAddGuest} onDeleteGuest={onDeleteGuest} onImportGuests={onImportGuests} />
                    </Modal>
                </div>
            );
        };

        const HomeView = ({ onNavigate }) => (
            <section className="relative min-h-screen flex flex-col justify-center pt-32 pb-20 px-6 overflow-hidden">
                <div className="absolute inset-0 z-0"><img src="https://iili.io/fgdzHjs.jpg" alt="Wedding" className="w-full h-full object-cover object-center bg-zoom" /><div className="absolute inset-0 bg-white/10 backdrop-blur-[2px]"></div><div className="absolute inset-0 bg-gradient-to-b from-[#F0EBE5]/90 via-transparent to-[#F0EBE5]/90"></div></div>
                <div className="relative z-10 container mx-auto text-center">
                    <h1 className="text-5xl md:text-[140px] font-black tracking-[-0.06em] text-stone-800 uppercase animate-in title-entrance">WEDDING <br/><span className="text-silk">REDEFINED.</span></h1>
                    <p className="text-lg md:text-2xl text-stone-800 max-w-2xl mx-auto mb-12 md:mb-20 font-semibold leading-relaxed animate-in drop-shadow-md" style={{animationDelay: '0.1s'}}>Nền tảng tối ưu để tổ chức một đám cưới hiện đại. Tinh tế, chuyên nghiệp và nằm trọn trong tay bạn.</p>
                    <div className="flex flex-col sm:flex-row justify-center gap-4 md:gap-6 animate-in" style={{animationDelay: '0.2s'}}>
                        <button onClick={() => onNavigate('planner')} className="px-10 md:px-12 py-4 md:py-5 bg-stone-500 text-white font-bold text-[10px] md:text-[11px] uppercase tracking-[0.3em] rounded-full hover:bg-stone-400 transition-all hover:scale-105 active:scale-95 shadow-2xl">Khám phá Planner</button>
                        <button className="px-10 md:px-12 py-4 md:py-5 bg-white/70 border border-stone-200 text-stone-700 font-bold text-[10px] md:text-[11px] uppercase tracking-[0.3em] rounded-full hover:bg-white transition-all active:scale-95">Xem mẫu thiệp</button>
                    </div>
                </div>
            </section>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [scrolled, setScrolled] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showRegister, setShowRegister] = useState(false);
            const [user, setUser] = useState(null);
            const firebase = useFirebase();

            // Notification states
            const [showNotifications, setShowNotifications] = useState(false);
            const [notifications, setNotifications] = useState([]);
            const notificationRef = useRef(null);

            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => {
                if (firebase) {
                    return firebase.onAuthStateChanged(firebase.auth, (u) => {
                        setUser(u);
                        if (u) { setShowLogin(false); setShowRegister(false); }
                    });
                }
            }, [firebase]);

            // Handle Click Outside for Notifications
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (notificationRef.current && !notificationRef.current.contains(event.target)) {
                        setShowNotifications(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // Global Notification Listener
            useEffect(() => {
                if (firebase && user) {
                    const { db, doc, onSnapshot } = firebase;
                    const unsubUser = onSnapshot(doc(db, "users", user.uid), (userSnap) => {
                        if (userSnap.exists()) {
                            const weddingId = userSnap.data().weddingId;
                            if (weddingId) {
                                onSnapshot(doc(db, "weddings", weddingId), (wSnap) => {
                                    if (wSnap.exists()) {
                                        setNotifications(wSnap.data().activities || []);
                                    }
                                });
                            }
                        }
                    });
                    return () => unsubUser();
                }
            }, [firebase, user]);

            const navigateTo = (tab) => {
                if (tab !== 'home' && !user) { setShowLogin(true); return; }
                setActiveTab(tab); 
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

            const handleGoogleLogin = async () => {
                try {
                    const { auth, db, GoogleAuthProvider, signInWithPopup, doc, getDoc, setDoc } = firebase;
                    const result = await signInWithPopup(auth, new GoogleAuthProvider());
                    const u = result.user;
                    const snap = await getDoc(doc(db, "users", u.uid));
                    if (!snap.exists()) await setDoc(doc(db, "users", u.uid), { profile: { email: u.email, name: u.displayName }, weddingId: null, isSetupComplete: false });
                    setActiveTab('planner');
                } catch (e) { alert("Đăng nhập Google thất bại."); }
            };

            const LoginForm = () => {
                const [email, setEmail] = useState(""); const [password, setPassword] = useState(""); const [error, setError] = useState("");
                const handleLogin = async () => {
                    try {
                        await firebase.signInWithEmailAndPassword(firebase.auth, email, password);
                        setActiveTab('planner');
                    } catch (e) { setError("Đăng nhập thất bại."); }
                };
                return (
                    <div className="space-y-4 pt-4 text-stone-700">
                        <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm" />
                        <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Mật khẩu" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm" />
                        {error && <p className="text-red-500 text-xs text-center font-bold">{error}</p>}
                        <button className="w-full py-4 bg-stone-500 text-white rounded-full font-black uppercase text-xs shadow-lg hover:bg-stone-600 transition-all" onClick={handleLogin}>Vào hệ thống</button>
                        <div className="relative flex py-2 items-center"><div className="flex-grow border-t border-stone-100"></div><span className="flex-shrink-0 mx-4 text-stone-400 text-[10px] font-bold uppercase tracking-widest">Hoặc</span><div className="flex-grow border-t border-stone-100"></div></div>
                        <button onClick={handleGoogleLogin} className="w-full py-4 bg-white border border-stone-200 text-stone-700 rounded-full text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-3 active:scale-95 transition-all shadow-sm">
                            <svg className="w-4 h-4" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                            Google Login
                        </button>
                        <button onClick={() => {setShowLogin(false); setShowRegister(true);}} className="w-full text-center text-xs font-bold text-stone-400 mt-2 hover:text-stone-700 transition-colors">Chưa có tài khoản? Đăng ký</button>
                    </div>
                );
            };

            const RegisterForm = () => {
                const [email, setEmail] = useState(""); const [password, setPassword] = useState(""); const [error, setError] = useState("");
                const handleRegister = async () => {
                    try {
                        const { user } = await firebase.createUserWithEmailAndPassword(firebase.auth, email, password);
                        await firebase.setDoc(firebase.doc(firebase.db, "users", user.uid), { profile: { email }, weddingId: null, isSetupComplete: false });
                        setActiveTab('planner');
                    } catch (e) { setError("Đăng ký không thành công."); }
                };
                return (
                    <div className="space-y-4 pt-4 text-stone-700">
                        <input type="email" value={email} onChange={e=>setEmail(e.target.value)} placeholder="Email" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm" />
                        <input type="password" value={password} onChange={e=>setPassword(e.target.value)} placeholder="Mật khẩu" className="w-full p-4 bg-stone-50 border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-500 text-sm" />
                        {error && <p className="text-red-500 text-xs text-center">{error}</p>}
                        <button className="w-full py-4 bg-stone-500 text-white rounded-full font-black uppercase text-xs shadow-lg hover:bg-stone-400 transition-all" onClick={handleRegister}>Đăng ký tài khoản</button>
                        <button onClick={() => {setShowRegister(false); setShowLogin(true);}} className="w-full text-center text-xs font-bold text-stone-400 mt-2 hover:text-stone-700 transition-colors">Đã có tài khoản? Đăng nhập</button>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    <div className="fixed top-6 left-0 w-full z-50 flex justify-center px-4 transition-all duration-500">
                        <nav className={`flex items-center justify-between px-6 py-2 rounded-full transition-all duration-500 ${scrolled ? 'w-full max-w-5xl bg-white/75 backdrop-blur-2xl border border-white/20 shadow-lg' : 'w-full max-w-6xl bg-white/40 backdrop-blur-md border border-white/10'}`}>
                            <div className="flex items-center gap-2 cursor-pointer group" onClick={() => navigateTo('home')}><div className="w-8 h-8 bg-stone-500 text-white rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><Icons.Heart size={16} fill="currentColor" /></div><span className="text-lg font-black tracking-tighter uppercase text-stone-700">Weddy</span></div>
                            <div className="hidden md:flex items-center gap-1">{[{ id: 'home', label: 'Trang chủ' }, { id: 'planner', label: 'Lập kế hoạch' }, { id: 'invitation', label: 'Thiệp mời' }, { id: 'vendors', label: 'Dịch vụ' }].map((item) => (<button key={item.id} onClick={() => navigateTo(item.id)} className={`text-[10px] font-black uppercase tracking-[0.2em] px-5 py-2.5 rounded-full transition-all ${activeTab === item.id ? 'bg-stone-500 text-white shadow-lg' : 'text-stone-400 hover:text-stone-700 hover:bg-stone-100/30'}`}>{item.label}</button>))}</div>
                            <div className="flex items-center gap-3">
                                {user && <span className="hidden sm:block text-[9px] font-black uppercase tracking-[0.2em] text-stone-400 mr-2">{user.displayName || user.email}</span>}
                                
                                {/* NOTIFICATION BUTTON & DROPDOWN (FACEBOOK STYLE) */}
                                {user && (
                                    <div className="relative" ref={notificationRef}>
                                        <button 
                                            onClick={() => setShowNotifications(!showNotifications)}
                                            className="w-10 h-10 bg-white/80 backdrop-blur-sm rounded-full flex items-center justify-center text-stone-400 hover:text-stone-700 border border-stone-100 shadow-sm transition-colors relative"
                                        >
                                            <Icons.Bell size={18} />
                                            {notifications.length > 0 && (
                                                <span className="absolute top-2 right-2 w-2 h-2 bg-rose-500 rounded-full border border-white"></span>
                                            )}
                                        </button>
                                        
                                        {showNotifications && (
                                            <div className="absolute right-0 mt-3 w-80 bg-white/95 backdrop-blur-xl rounded-[2rem] shadow-2xl border border-stone-100 py-6 animate-in zoom-in-95 origin-top-right overflow-hidden z-[60]">
                                                <div className="px-6 mb-4 flex justify-between items-center">
                                                    <h4 className="text-xs font-black uppercase tracking-widest text-stone-800">Thông báo</h4>
                                                    <span className="text-[9px] font-bold text-stone-400 uppercase tracking-widest">{notifications.length} mới</span>
                                                </div>
                                                <div className="max-h-96 overflow-y-auto hide-scrollbar px-2">
                                                    {notifications.length > 0 ? notifications.map((n, i) => (
                                                        <div key={i} className="p-4 rounded-2xl hover:bg-stone-50 transition-colors flex gap-4 items-start cursor-pointer group">
                                                            <div className="w-8 h-8 bg-stone-100 rounded-xl flex items-center justify-center shrink-0 group-hover:bg-stone-200 transition-colors">
                                                                <Icons.Heart size={14} className="text-stone-400" />
                                                            </div>
                                                            <div className="flex-1">
                                                                <p className="text-xs font-bold text-stone-700 leading-snug">{n.text}</p>
                                                                <p className="text-[9px] font-bold text-stone-400 uppercase mt-1">{n.time}</p>
                                                            </div>
                                                        </div>
                                                    )) : (
                                                        <div className="py-10 text-center text-stone-400 text-xs italic">Không có thông báo mới</div>
                                                    )}
                                                </div>
                                                <div className="px-6 pt-4 border-t border-stone-50 mt-2">
                                                    <button onClick={() => setShowNotifications(false)} className="w-full text-center text-[9px] font-black uppercase tracking-widest text-stone-400 hover:text-stone-800 transition-colors">Đóng thông báo</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}

                                {user ? <button onClick={() => firebase.signOut(firebase.auth)} className="px-6 py-2.5 bg-white border border-stone-200 text-stone-700 rounded-full text-[10px] font-black uppercase tracking-[0.25em] shadow-sm active:scale-95 transition-all">Đăng xuất</button> : <button onClick={() => setShowLogin(true)} className="px-6 py-2.5 bg-stone-500 text-white rounded-full text-[10px] font-black uppercase tracking-[0.25em] shadow-xl active:scale-95 transition-all">Đăng nhập</button>}
                            </div>
                        </nav>
                    </div>
                    <main>
                        {activeTab === 'home' && <HomeView onNavigate={navigateTo} />}
                        {activeTab === 'planner' && (user ? <FullPlannerApp currentUser={user} /> : <div className="h-screen flex flex-col gap-4 items-center justify-center text-stone-400 p-6 text-center"><Icons.Users size={48} className="opacity-20" /><p>Vui lòng đăng nhập để sử dụng tính năng Planner.</p><button onClick={() => setShowLogin(true)} className="px-8 py-3 bg-stone-500 text-white rounded-full text-xs font-bold uppercase shadow-lg">Đăng nhập ngay</button></div>)}
                        {activeTab === 'invitation' && <div className="py-60 text-center px-6 animate-in text-stone-700"><p className="text-2xl font-black uppercase tracking-widest text-stone-300">Thiệp mời điện tử</p><p className="text-stone-400 mt-2 font-medium">Tính năng đang được phát triển</p></div>}
                        {activeTab === 'vendors' && <div className="py-60 text-center px-6 animate-in text-stone-700"><p className="text-2xl font-black uppercase tracking-widest text-stone-300">Mạng lưới dịch vụ</p><p className="text-stone-400 mt-2 font-medium">Tính năng đang được phát triển</p></div>}
                    </main>
                    {activeTab !== 'planner' && <footer className="bg-white/30 border-t border-stone-200 py-24 text-center"><div className="container mx-auto px-6"><span className="text-xl font-black tracking-tighter uppercase mb-6 block text-stone-700">Weddy Platform.</span><div className="flex flex-wrap justify-center gap-6 md:gap-10 text-[10px] font-black uppercase tracking-[0.3em] text-stone-400"><span className="hover:text-stone-800 cursor-pointer transition-colors font-bold">Instagram</span><span className="hover:text-stone-800 cursor-pointer transition-colors font-bold">Tiktok</span><span className="hover:text-stone-800 cursor-pointer transition-colors font-bold">Điều khoản</span></div><p className="mt-12 text-[9px] font-bold text-stone-300 uppercase tracking-widest">© 2024 Weddy Tech Collective. All rights reserved.</p></div></footer>}
                    <Modal isOpen={showLogin} onClose={() => setShowLogin(false)} title="Đăng nhập"><LoginForm /></Modal>
                    <Modal isOpen={showRegister} onClose={() => setShowRegister(false)} title="Đăng ký tài khoản"><RegisterForm /></Modal>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
