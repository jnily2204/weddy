<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weddy - Nền tảng quản lý đám cưới tinh tế</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.8s ease-out forwards; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes reveal-up-blur {
            0% { opacity: 0; transform: translateY(100%) scale(1.1); filter: blur(20px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }
        @keyframes silk-shine { 0% { background-position: 0% 50%; } 100% { background-position: 200% 50%; } }
        .title-entrance { animation: reveal-up-blur 1.8s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .text-silk {
            background: linear-gradient(90deg, #806233 0%, #CC9C53 25%, #FFECB3 50%, #CC9C53 75%, #806233 100%);
            background-size: 200% auto; color: #000; background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            animation: silk-shine 5s linear infinite;
        }
        @keyframes subtle-zoom { 0% { transform: scale(1); } 100% { transform: scale(1.05); } }
        .bg-zoom { animation: subtle-zoom 20s infinite alternate; }
    </style>
</head>
<body class="bg-[#F0EBE5] text-stone-700 transition-colors duration-500 overflow-x-hidden">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, getDoc, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD_F3OI5GexlAqgC8TZ1CN1JB5O3RacQqs",
            authDomain: "weddyvn.firebaseapp.com",
            projectId: "weddyvn",
            storageBucket: "weddyvn.firebasestorage.app",
            messagingSenderId: "504927899297",
            appId: "1:504927899297:web:1a3d3a1b6cfafe0716aae0",
            measurementId: "G-KK4B3RXVNV"
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            window.firebaseServices = { 
                auth, db, createUserWithEmailAndPassword, signInWithEmailAndPassword, 
                signOut, onAuthStateChanged, doc, setDoc, updateDoc, onSnapshot, 
                getDoc, collection, query, GoogleAuthProvider, 
                signInWithPopup, signInAnonymously, signInWithCustomToken
            };
        } catch (e) { console.error("Firebase init failed:", e); }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. GLOBAL CONSTANTS & CORE UTILS ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'weddy-stable-v2';

        const formatCurrencyInput = (v) => v ? v.toString().replace(/\D/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ".") : "";
        const parseCurrencyInput = (v) => v ? parseInt(v.toString().replace(/\./g, '')) || 0 : 0;
        const formatMoneyDisplay = (a) => {
            if (!a || a === 0) return "0 VNĐ";
            return a >= 1000000000 
                ? (a / 1000000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 }) + " Tỷ VNĐ" 
                : (a / 1000000).toLocaleString('vi-VN', { maximumFractionDigits: 2 }) + " Triệu VNĐ";
        };
        const calculateDaysLeft = (d) => {
            if (!d || d === "Chưa đặt") return "---";
            const diff = Math.ceil((new Date(d).getTime() - new Date().getTime()) / (1000 * 60 * 60 * 24));
            return diff > 0 ? `${diff} NGÀY NỮA` : (diff === 0 ? "HÔM NAY" : "ĐÃ QUA");
        };

        const Icon = ({ children, size = 24, color = "currentColor", className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );

        const Icons = {
            Heart: (p) => <Icon {...p}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" /></Icon>,
            Check: (p) => <Icon {...p}><polyline points="20 6 9 17 4 12" /></Icon>,
            Users: (p) => <Icon {...p}><g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" /><circle cx="9" cy="7" r="4" /><path d="M22 21v-2a4 4 0 0 0-3-3.87" /><path d="M16 3.13a4 4 0 0 1 0 7.75" /></g></Icon>,
            Plus: (p) => <Icon {...p}><g><path d="M5 12h14" /><path d="M12 5v14" /></g></Icon>,
            Layout: (p) => <Icon {...p}><g><rect width="18" height="18" x="3" y="3" rx="2" ry="2" /><path d="M3 9h18" /><path d="M9 21V9" /></g></Icon>,
            DollarSign: (p) => <Icon {...p}><g><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></g></Icon>,
            X: (p) => <Icon {...p}><g><path d="M18 6 6 18" /><path d="m6 6 12 12" /></g></Icon>,
            ChevronRight: (p) => <Icon {...p}><path d="m9 18 6-6-6-6" /></Icon>,
            Link: (p) => <Icon {...p}><g><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" /><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" /></g></Icon>,
            Share: (p) => <Icon {...p}><g><circle cx="18" cy="5" r="3" /><circle cx="6" cy="12" r="3" /><circle cx="18" cy="19" r="3" /><line x1="8.59" x2="15.42" y1="13.51" y2="17.49" /><line x1="15.41" x2="8.59" y1="6.51" y2="10.49" /></g></Icon>,
            Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></Icon>,
            Trash: (p) => <Icon {...p}><g><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></g></Icon>,
            ArrowUpRight: (p) => <Icon {...p}><g><path d="M7 7h10v10" /><path d="M7 17 17 7" /></g></Icon>,
            Bell: (p) => <Icon {...p}><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9" /></Icon>,
            Menu: (p) => <Icon {...p}><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></Icon>,
        };

        const useFirebase = () => {
            const [services, setServices] = useState(null);
            useEffect(() => {
                const interval = setInterval(() => { 
                    if (window.firebaseServices) { setServices(window.firebaseServices); clearInterval(interval); } 
                }, 100);
                return () => clearInterval(interval);
            }, []);
            return services;
        };

        // --- 2. BASE UI COMPONENTS ---
        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-stone-900/40 backdrop-blur-md transition-opacity animate-in fade-in" onClick={onClose}></div>
                    <div className="relative bg-white/95 backdrop-blur-xl rounded-[2.5rem] p-5 md:p-8 w-full max-w-md shadow-2xl border border-stone-100 animate-in zoom-in-95 duration-300 flex flex-col max-h-[90vh] overflow-y-auto hide-scrollbar text-stone-700">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-base md:text-lg font-black uppercase tracking-widest text-stone-600">{title}</h3>
                            <button onClick={onClose} className="w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 text-stone-300 hover:bg-stone-100 hover:text-stone-800 transition-colors"><Icons.X size={16} /></button>
                        </div>
                        <div className="flex-1">{children}</div>
                    </div>
                </div>
            );
        };

        const HomeView = ({ onNavigate }) => (
            <section className="relative min-h-screen flex flex-col justify-center pt-24 pb-12 px-4 md:px-6 overflow-hidden text-stone-800">
                <div className="absolute inset-0 z-0"><img src="https://iili.io/fgdzHjs.jpg" alt="Wedding" className="w-full h-full object-cover object-center bg-zoom opacity-80" /><div className="absolute inset-0 bg-white/10 backdrop-blur-[2px]"></div><div className="absolute inset-0 bg-gradient-to-b from-[#F0EBE5]/90 via-transparent to-[#F0EBE5]/90"></div></div>
                <div className="relative z-10 container mx-auto text-center">
                    <h1 className="text-4xl sm:text-5xl md:text-[140px] font-black tracking-[-0.06em] uppercase animate-in title-entrance leading-[0.9] break-words">WEDDING <br/><span className="text-silk">REDEFINED.</span></h1>
                    <p className="text-base md:text-2xl max-w-2xl mx-auto my-8 md:my-12 font-semibold leading-relaxed animate-in drop-shadow-md px-4">Nền tảng tối ưu để tổ chức một đám cưới hiện đại. Tinh tế, chuyên nghiệp và nằm trọn trong tay bạn.</p>
                    <div className="flex flex-col sm:flex-row justify-center items-center gap-4 md:gap-6 animate-in" style={{animationDelay: '0.2s'}}>
                        <button onClick={() => onNavigate('planner')} className="w-full sm:w-auto px-10 md:px-12 py-4 md:py-5 bg-stone-500 text-white font-bold text-[10px] md:text-[11px] uppercase tracking-[0.3em] rounded-full hover:bg-stone-600 transition-all hover:scale-105 active:scale-95 shadow-2xl">Khám phá Planner</button>
                        <button className="px-10 md:px-12 py-4 md:py-5 bg-white/70 border border-stone-200 text-stone-700 font-bold text-[10px] md:text-[11px] uppercase tracking-[0.3em] rounded-full hover:bg-white transition-all active:scale-95 w-full sm:w-auto">Xem mẫu thiệp</button>
                    </div>
                </div>
            </section>
        );

        const PlannerOverview = ({ spentAmount, completedTasks, totalTasks, guestCount, budgetLimit, role, activities, onInvite, onEditBudget, onOpenGuests }) => {
            const displayBudgetLimit = budgetLimit || 300000000;
            return (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 md:gap-8 animate-in text-stone-700 text-left">
                    <div className="lg:col-span-2 space-y-6 md:space-y-8">
                        <div className="bg-white/40 backdrop-blur-md p-6 rounded-[2.5rem] border border-stone-200/50 flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm text-stone-800 text-sm">
                            <div className="flex items-center gap-4">
                                <div className="w-12 h-12 bg-rose-100/50 rounded-full flex items-center justify-center text-rose-500 shrink-0"><Icons.Heart size={20} fill="currentColor"/></div>
                                <div><h4 className="font-bold">Ví chung đôi mình</h4><p className="text-xs text-stone-400">Đồng bộ kế hoạch với người ấy.</p></div>
                            </div>
                            <button onClick={onInvite} className="w-full md:w-auto px-6 py-3 bg-white border border-stone-200 text-stone-700 rounded-full text-[10px] font-black uppercase tracking-widest shadow-sm hover:shadow-md transition-all flex items-center justify-center gap-2"><Icons.Share size={14}/> Mời bạn đời</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div className="bg-white/80 p-6 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-44 md:h-48">
                                <div className="flex justify-between items-start"><span className="text-[10px] font-black uppercase tracking-[0.2em] text-stone-400">Tiến độ</span><div className="w-10 h-10 bg-stone-50/50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Check size={18}/></div></div>
                                <div><div className="flex items-baseline gap-2 mb-3"><span className="text-3xl md:text-5xl font-black text-stone-600">{completedTasks}</span><span className="text-stone-300 font-bold uppercase text-[11px]">/ {totalTasks} việc</span></div><div className="w-full h-1.5 bg-stone-100 rounded-full overflow-hidden"><div className="h-full bg-stone-400 transition-all duration-700" style={{width: `${totalTasks > 0 ? (completedTasks / totalTasks) * 100 : 0}%`}}></div></div></div>
                            </div>
                            <div onClick={onOpenGuests} className="bg-white/80 p-6 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-sm flex flex-col justify-between h-44 md:h-48 cursor-pointer hover:border-stone-300 transition-all active:scale-[0.98]">
                                <div className="flex justify-between items-start"><span className="text-[10px] font-black uppercase tracking-[0.2em] text-stone-400">Khách mời</span><div className="w-10 h-10 bg-stone-50/50 rounded-2xl flex items-center justify-center text-stone-400"><Icons.Users size={18}/></div></div>
                                <div className="flex items-baseline gap-2 text-stone-700"><span className="text-4xl md:text-6xl font-black">{guestCount}</span><span className="text-stone-300 font-bold uppercase text-[11px]">Người</span></div>
                            </div>
                        </div>
                        <div className="bg-stone-500 p-6 md:p-12 rounded-[2rem] text-white relative overflow-hidden shadow-xl group">
                            <div className="absolute top-0 right-0 w-80 h-80 bg-stone-400 rounded-full blur-[150px] opacity-20 -translate-y-1/2 translate-x-1/2 group-hover:opacity-30 transition-opacity duration-700"></div>
                            <div className="relative z-10"><h3 className="text-[10px] font-black uppercase tracking-[0.3em] text-white/70 mb-6 md:mb-8">Tài chính tổng quát ({role || 'Bạn'})</h3>
                                <div className="flex flex-col md:flex-row justify-between gap-6 md:gap-8">
                                    <div className="flex-1 text-white">
                                        <div className="text-[10px] uppercase font-black text-white/30 mb-2">Đã chi tiêu</div>
                                        <div className="text-4xl md:text-7xl font-black tracking-tighter">{formatMoneyDisplay(spentAmount)}</div>
                                        <div className="w-full h-1.5 bg-white/10 rounded-full overflow-hidden mt-6 mb-4"><div className="h-full bg-white transition-all duration-700" style={{width: `${Math.min((spentAmount/displayBudgetLimit)*100, 100)}%`}}></div></div>
                                        <div className="flex items-center gap-2 group/budget inline-flex cursor-pointer text-white/80" onClick={onEditBudget}><p className="text-[12px] font-black uppercase tracking-widest">Ngân sách: {formatMoneyDisplay(displayBudgetLimit)}</p><Icons.Edit size={14} className="text-white/20 group-hover/budget:text-white transition-colors" /></div>
                                    </div>
                                    <div className="md:w-48 flex flex-col gap-4 justify-center text-white"><div className="bg-white/10 backdrop-blur-sm p-5 md:p-6 rounded-3xl border border-white/5 text-center md:text-left shadow-sm"><p className="text-[9px] font-black text-white/40 uppercase mb-1">Còn lại</p><p className="text-xl font-bold">{formatMoneyDisplay(displayBudgetLimit - spentAmount)}</p></div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div className="bg-white/60 backdrop-blur-md p-6 md:p-10 rounded-[2.5rem] border border-stone-100 shadow-sm h-full flex flex-col">
                        <h3 className="text-[11px] font-black uppercase tracking-[0.2em] mb-8 text-stone-700 border-b border-stone-100 pb-6 font-bold">Hoạt động</h3>
                        <div className="space-y-6 flex-1 overflow-y-auto hide-scrollbar max-h-[400px] md:max-h-[500px]">
                            {activities?.length > 0 ? activities.map((act, i) => (
                                <div key={i} className="flex gap-4 items-start group animate-in" style={{animationDelay: `${i * 0.1}s`}}>
                                    <div className="w-9 h-9 md:w-10 md:h-10 bg-stone-50 rounded-2xl flex items-center justify-center shrink-0 group-hover:bg-stone-500 group-hover:text-white transition-colors shadow-sm"><Icons.ArrowUpRight size={16} className="text-stone-300 group-hover:text-white" /></div>
                                    <div className="text-left"><p className="text-[12px] md:text-[13px] font-bold text-stone-800 leading-snug">{act.text}</p><p className="text-[10px] font-black text-stone-300 uppercase tracking-widest mt-1">{act.time}</p></div>
                                </div>
                            )) : <p className="text-sm text-stone-300 italic font-medium text-center">Chưa có hoạt động mới.</p>}
                        </div>
                    </div>
                </div>
            );
        };

        const PlannerBudget = ({ tasks, onAddExpense }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [title, setTitle] = useState(""); const [cost, setCost] = useState(""); const [paid, setPaid] = useState(""); const [category, setCategory] = useState("Đặt tiệc cưới");
            const budgetTasks = (tasks || []).filter(t => t.cost > 0);
            const totalBudget = budgetTasks.reduce((acc, curr) => acc + curr.cost, 0);
            const totalPaid = budgetTasks.reduce((acc, curr) => acc + (curr.paid || (curr.status === 'done' ? curr.cost : 0)), 0);
            const handleSave = () => { if (title.trim() && cost) { onAddExpense({ title: title.trim(), tag: category, status: parseCurrencyInput(paid) >= parseCurrencyInput(cost) ? 'done' : 'pending', cost: parseCurrencyInput(cost), paid: parseCurrencyInput(paid) }); setTitle(""); setCost(""); setPaid(""); setIsOpen(false); } };
            return (
                <div className="max-w-4xl mx-auto space-y-6 md:space-y-8 animate-in text-stone-700">
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 text-left font-bold">
                        <div className="bg-white p-5 md:p-8 rounded-[2rem] border border-stone-100 shadow-sm"><p className="text-[10px] font-black uppercase tracking-widest text-stone-400 mb-2">Dự kiến</p><p className="text-xl md:text-2xl font-black text-stone-800">{formatMoneyDisplay(totalBudget)}</p></div>
                        <div className="bg-stone-500 text-white p-5 md:p-8 rounded-[2rem] shadow-xl"><p className="text-[10px] font-black uppercase tracking-widest text-white/50 mb-2">Đã trả</p><p className="text-xl md:text-2xl font-black">{formatMoneyDisplay(totalPaid)}</p></div>
                        <div className="bg-white p-5 md:p-8 rounded-[2rem] border border-stone-100 shadow-sm sm:col-span-2 md:col-span-1"><p className="text-[10px] font-black uppercase tracking-widest text-stone-400 mb-2 text-rose-400">Còn lại</p><p className="text-xl md:text-2xl font-black text-rose-500">{formatMoneyDisplay(totalBudget - totalPaid)}</p></div>
                    </div>
                    <div className="bg-white rounded-[2rem] border border-stone-100 overflow-hidden shadow-sm">
                        <div className="p-6 md:p-8 border-b border-stone-50 flex flex-col md:flex-row justify-between items-start md:items-center gap-4 text-stone-800">
                            <div className="text-left font-bold uppercase tracking-widest"><h3 className="text-lg md:text-xl">Khoản chi</h3><span className="text-[10px] text-stone-300">Đồng bộ tự động</span></div>
                            <button onClick={() => setIsOpen(true)} className="w-full md:w-auto px-6 py-3 bg-stone-400 text-white rounded-full text-[10px] font-black uppercase tracking-widest hover:bg-stone-500 shadow-md active:scale-95 font-bold transition-all"><Icons.Plus size={12}/> Thêm chi phí</button>
                        </div>
                        <div className="divide-y divide-stone-50">{budgetTasks.length === 0 ? <div className="p-16 text-center text-stone-300 italic font-medium font-bold">Chưa có dữ liệu.</div> : budgetTasks.map((item, i) => {
                            const isPaidOff = (item.paid || 0) >= item.cost || item.status === 'done';
                            return (
                                <div key={i} className="p-5 md:p-6 flex flex-col md:flex-row md:items-center justify-between hover:bg-[#FBF9F7] transition-colors gap-4 text-left">
                                    <div className="flex items-center gap-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center shrink-0 ${isPaidOff ? 'bg-stone-500 text-white' : 'bg-stone-100 text-stone-300'}`}><Icons.DollarSign size={16} /></div><div className="text-left"><h4 className="font-bold text-sm md:text-base text-stone-800 leading-tight">{item.title}</h4><p className="text-[10px] font-bold text-stone-400 uppercase tracking-widest mt-0.5">{item.tag}</p></div></div>
                                    <div className="flex md:block flex-row justify-between items-center text-right"><p className="font-black text-sm md:text-lg text-stone-800">{formatMoneyDisplay(item.cost)}</p><span className={`text-[9px] font-bold uppercase tracking-widest px-2 py-1 md:px-3 md:py-1.5 rounded-full inline-block ${isPaidOff ? 'bg-emerald-50 text-emerald-700' : 'bg-orange-50 text-orange-600'}`}>{isPaidOff ? 'Xong' : `Trả: ${formatMoneyDisplay(item.paid || 0)}`}</span></div>
                                </div>
                            );
                        })}</div>
                    </div>
                </div>
            );
        };

        const PlannerTasks = ({ tasks, onAddTask, onToggleTask, onDeleteTask }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [title, setTitle] = useState(""); const [cat, setCat] = useState("Đặt tiệc cưới"); const [cost, setCost] = useState("");
            const handleAdd = () => { if (title.trim()) { onAddTask({ title: title.trim(), tag: cat, status: "pending", cost: parseCurrencyInput(cost), paid: 0 }); setTitle(""); setCost(""); setIsOpen(false); } };
            const pending = (tasks || []).filter(t => t.status !== 'done');
            return (
                <div className="max-w-4xl mx-auto space-y-8 animate-in text-stone-700 text-left">
                    <div className="flex justify-between items-center px-4 text-stone-800"><h3 className="text-xl md:text-2xl font-black uppercase tracking-tighter font-bold">Việc cần làm</h3><button onClick={() => setIsOpen(true)} className="px-5 py-3 bg-stone-400 text-white rounded-full text-[10px] font-black uppercase tracking-widest shadow-xl hover:bg-stone-500 active:scale-95 transition-all font-bold"><Icons.Plus size={14}/> Thêm việc</button></div>
                    <div className="bg-white rounded-[2.5rem] border border-stone-100 shadow-sm overflow-hidden divide-y divide-stone-50 text-stone-800">
                        {pending.length > 0 ? pending.map((t, idx) => (
                            <div key={idx} onClick={() => onToggleTask(tasks.indexOf(t))} className="group p-5 md:p-6 flex items-center hover:bg-[#FBF9F7] transition-all cursor-pointer">
                                <div className="w-6 h-6 rounded-full border-2 border-stone-200 mr-5 md:mr-6 group-hover:border-stone-400 transition-colors shrink-0"></div>
                                <div className="flex-1 text-left"><h4 className="text-sm md:text-base font-bold leading-tight">{t.title}</h4><span className="text-[9px] font-black uppercase text-stone-300 tracking-widest">{t.tag}</span></div>
                                <button onClick={(e) => { e.stopPropagation(); onDeleteTask(tasks.indexOf(t)); }} className="p-2 text-stone-200 hover:text-red-400 transition-colors"><Icons.Trash size={18} /></button>
                            </div>
                        )) : <div className="p-16 text-center text-stone-300 italic font-medium font-bold">Bạn đã xong tất cả! ✨</div>}
                    </div>
                    <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="Công việc mới">
                        <div className="space-y-6 pt-4"><input type="text" value={title} onChange={e=>setTitle(e.target.value)} className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm shadow-sm font-medium" placeholder="Tên công việc" /><div className="grid grid-cols-2 gap-3"><div className="relative"><select value={cat} onChange={e=>setCat(e.target.value)} className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm appearance-none font-medium"><option value="Đặt tiệc cưới">Tiệc cưới</option><option value="Khác">Khác</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-stone-400"><Icons.ChevronRight size={14} className="rotate-90" /></div></div><input type="text" value={cost} onChange={e=>setCost(formatCurrencyInput(e.target.value))} className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm font-medium" placeholder="Dự chi VNĐ" /></div><button onClick={handleAdd} className="w-full py-4 bg-stone-400 text-white rounded-full font-black uppercase text-xs shadow-lg font-bold transition-all active:scale-95">Lưu lại</button></div>
                    </Modal>
                </div>
            );
        };

        const PlannerGuests = ({ guests, onAddGuest, onDeleteGuest }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [name, setName] = useState(""); const [rel, setRel] = useState("Bạn bè"); const [phone, setPhone] = useState("");
            const handleAdd = () => { if (name.trim()) { onAddGuest({ name: name.trim(), relationship: rel, phone, id: Date.now() }); setName(""); setPhone(""); setIsOpen(false); } };
            return (
                <div className="max-w-4xl mx-auto space-y-6 pt-2 text-stone-700 animate-in px-2 md:px-0 text-left font-bold">
                    <div className="flex justify-between items-center mb-4 text-stone-400 text-left"><p className="text-[10px] font-bold uppercase tracking-widest font-bold text-left">Danh sách ({guests?.length || 0})</p><button onClick={() => setIsOpen(true)} className="px-5 py-2.5 bg-stone-400 text-white rounded-full text-[10px] font-black uppercase tracking-widest shadow-md hover:bg-stone-500 transition-all active:scale-95 font-bold"><Icons.Plus size={14} className="inline mr-1" /> Thêm khách</button></div>
                    <div className="bg-stone-50/50 rounded-2xl border border-stone-100 overflow-hidden divide-y divide-stone-50 shadow-sm">
                        {guests?.length === 0 ? <div className="p-16 text-center text-stone-300 italic font-medium font-bold">Chưa có khách mời.</div> : guests?.map((g) => (<div key={g.id} className="p-4 md:p-5 flex items-center justify-between hover:bg-white transition-colors group"><div className="flex items-center gap-3 md:gap-4 text-left"><div className="w-9 h-9 md:w-10 md:h-10 rounded-full bg-stone-100 flex items-center justify-center text-stone-400 font-bold text-xs shrink-0">{g.name.charAt(0).toUpperCase()}</div><div className="text-left"><h4 className="font-bold text-sm md:text-base text-left">{g.name}</h4><p className="text-[9px] md:text-[10px] font-bold text-stone-300 uppercase tracking-widest text-left">{g.relationship}</p></div></div><button onClick={() => onDeleteGuest(g.id)} className="p-2 text-stone-200 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-all"><Icons.Trash size={16} /></button></div>))}
                    </div>
                    <Modal isOpen={isOpen} onClose={() => setIsOpen(false)} title="Thêm khách mời"><div className="space-y-6 pt-4 text-stone-800 text-left"><input type="text" value={name} onChange={e=>setName(e.target.value)} className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm shadow-sm font-medium" placeholder="Họ và tên" /><div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-xs text-stone-500 font-bold text-left"><div><label className="block mb-2 uppercase tracking-widest ml-1 font-bold text-left">Quan hệ</label><div className="relative text-left"><select value={rel} onChange={e=>setRel(e.target.value)} className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm appearance-none font-medium"><option value="Gia đình">Gia đình</option><option value="Bạn bè">Bạn bè</option><option value="Khác">Khác</option></select><div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-stone-300"><Icons.ChevronRight size={14} className="rotate-90" /></div></div></div><div><label className="block mb-2 uppercase tracking-widest ml-1 font-bold text-left">SĐT</label><input type="tel" value={phone} onChange={e=>setPhone(e.target.value)} className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm shadow-sm font-medium" /></div></div><button onClick={handleAdd} className="w-full py-4 bg-stone-400 text-white rounded-full font-black uppercase text-[10px] shadow-lg font-bold transition-all active:scale-95">Lưu lại</button></div></Modal>
                </div>
            );
        };

        // --- 4. MAIN PLANNER APP (SOURCE OF TRUTH) ---
        const FullPlannerApp = ({ currentUser }) => {
            const [subTab, setSubTab] = useState('overview');
            const [userData, setUserData] = useState(null);
            const [isBudgetModalOpen, setIsBudgetModalOpen] = useState(false);
            const [isGuestModalOpen, setIsGuestModalOpen] = useState(false);
            const [tempBudget, setTempBudget] = useState("");
            const firebase = useFirebase();

            useEffect(() => {
                if (!firebase || !currentUser) return;
                const { db, onSnapshot, doc, setDoc, getDoc, updateDoc } = firebase;
                const profileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'profile', 'main');
                let unsubWedding = null;
                const unsubProfile = onSnapshot(profileRef, async (snap) => {
                    if (snap.exists()) {
                        const pv = snap.data();
                        let wid = pv.weddingId;
                        if (!wid) {
                            wid = currentUser.uid;
                            await updateDoc(profileRef, { weddingId: wid, isSetupComplete: pv.isSetupComplete || false });
                            const wref = doc(db, 'artifacts', appId, 'public', 'data', 'weddings', wid);
                            if (!(await getDoc(wref)).exists()) await setDoc(wref, { tasks: [], guests: [], activities: [], budgetLimit: 300000000, owners: [currentUser.uid] });
                        }
                        if (unsubWedding) unsubWedding();
                        unsubWedding = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'weddings', wid), (wSnap) => {
                            if (wSnap.exists()) setUserData({ ...wSnap.data(), weddingId: wid, profile: pv });
                        }, (err) => console.error("Wedding Sync Error:", err));
                    } else {
                        await setDoc(profileRef, { email: currentUser.email, name: currentUser.displayName, weddingId: null, isSetupComplete: false });
                    }
                }, (err) => console.error("Profile listen error:", err));
                return () => { unsubProfile(); if (unsubWedding) unsubWedding(); };
            }, [firebase, currentUser]);

            if (!userData) return <div className="h-screen flex items-center justify-center text-stone-400"><div className="w-8 h-8 border-4 border-stone-300 border-t-transparent rounded-full animate-spin"></div></div>;

            const updateWedding = async (key, val) => {
                const { db, doc, updateDoc } = firebase;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'weddings', userData.weddingId), { [key]: val });
            };
            const addAct = async (text) => { const n = { text, time: new Date().toLocaleTimeString('vi-VN') }; await updateWedding('activities', [n, ...(userData.activities || [])].slice(0, 15)); };
            
            // --- ATOMIC HANDLERS ---
            const onAddTask = async (t) => { const nt = [t, ...(userData.tasks || [])]; await updateWedding('tasks', nt); await addAct(`Thêm việc: ${t.title}`); };
            const onToggleTask = async (idx) => { const nt = [...(userData.tasks || [])]; nt[idx].status = nt[idx].status === 'done' ? 'pending' : 'done'; await updateWedding('tasks', nt); await addAct(`Cập nhật: ${nt[idx].title}`); };
            const onDeleteTask = async (idx) => { const delT = userData.tasks[idx]; await updateWedding('tasks', userData.tasks.filter((_, i) => i !== idx)); await addAct(`Xóa: ${delT.title}`); };
            const onAddGuest = async (g) => { const ng = [g, ...(userData.guests || [])]; await updateWedding('guests', ng); await addAct(`Khách mới: ${g.name}`); };
            const onDeleteGuest = async (id) => { const ng = userData.guests.filter(x => x.id !== id); await updateWedding('guests', ng); await addAct(`Xóa khách mời`); };

            const spentAmount = (userData.tasks || []).reduce((acc, t) => acc + (t.paid ?? (t.status === 'done' ? t.cost : 0)), 0);

            return (
                <div className="pt-24 pb-32 md:pt-32 container mx-auto px-4 md:px-12 max-w-7xl animate-in text-stone-700">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 md:mb-16 gap-6 px-2 md:px-0 text-left font-bold uppercase">
                         <div className="flex-1 w-full text-stone-600"><span className="text-[10px] tracking-[0.3em] text-[#B5A896] mb-2 block">Planner của {userData.profile?.name || 'bạn'}</span><h2 className="text-3xl md:text-5xl tracking-tighter">Weddy Planner</h2></div>
                        <div className="flex flex-col sm:flex-row gap-4 w-full md:w-auto text-left">
                            <div className="bg-white/70 p-5 md:p-6 rounded-[2.5rem] border border-stone-100 shadow-sm flex items-center gap-6 flex-1 min-w-0 sm:min-w-[280px]">
                                <div className="w-10 h-10 md:w-12 md:h-12 bg-rose-100/40 rounded-full flex items-center justify-center text-rose-300 shrink-0"><Icons.Heart size={20} fill="currentColor"/></div>
                                <div className="flex-1 text-sm overflow-hidden text-left"><p className="text-[9px] font-black tracking-widest text-stone-300 mb-1 text-left">Ngày trọng đại</p><div className="flex items-baseline gap-2 md:gap-3 font-bold text-left"><p className="text-base md:text-xl font-bold text-stone-600 truncate text-left">{userData.profile?.weddingDate || 'Chưa đặt'}</p><p className="text-[10px] font-bold text-rose-400 whitespace-nowrap uppercase text-left">{calculateDaysLeft(userData.profile?.weddingDate)}</p></div></div>
                            </div>
                            <button onClick={async () => { const c = generateCode(); await firebase.setDoc(firebase.doc(firebase.db, 'artifacts', appId, 'public', 'data', 'invites', c), { weddingId: userData.weddingId, by: currentUser.uid }); alert("Mã kết nối: " + c); }} className="bg-stone-400 text-white p-5 md:p-6 rounded-[2.5rem] shadow-xl hover:bg-stone-500 active:scale-95 flex items-center justify-center gap-4 group transition-all shrink-0 font-bold">
                                <Icons.Link size={20} className="group-hover:rotate-12 transition-transform"/><span className="text-xs tracking-widest font-bold">Mời bạn đời</span>
                            </button>
                        </div>
                    </div>

                    <div className="flex justify-center mb-10 md:mb-16 -mx-4 px-4 md:mx-0 md:px-0 font-bold uppercase">
                        <div className="bg-white/40 p-1.5 rounded-full flex w-full max-w-6xl border border-white/60 backdrop-blur-sm overflow-x-auto hide-scrollbar">
                            {[{ id: 'overview', label: 'Tổng quan', icon: Icons.Layout }, { id: 'tasks', label: 'Công việc', icon: Icons.Check }, { id: 'budget', label: 'Ngân sách', icon: Icons.DollarSign }, { id: 'guests', label: 'Khách mời', icon: Icons.Users }].map((tab) => (
                                <button key={tab.id} onClick={() => setSubTab(tab.id)} className={`flex-1 flex items-center justify-center gap-2 px-6 md:px-10 py-4 md:py-5 rounded-full text-[10px] md:text-sm tracking-widest transition-all whitespace-nowrap ${subTab === tab.id ? 'bg-stone-500 text-white shadow-xl scale-105' : 'text-stone-400 hover:text-stone-700 hover:bg-white/50'}`}><tab.icon size={16} strokeWidth={3} className="md:w-[18px] md:h-[18px]" />{tab.label}</button>
                            ))}
                        </div>
                    </div>

                    <div className="px-1 md:px-0">
                        {subTab === 'overview' && <PlannerOverview spentAmount={spentAmount} completedTasks={tasks.filter(t=>t.status==='done').length} totalTasks={tasks.length} guestCount={guests.length} budgetLimit={userData.budgetLimit} role={userData.profile?.role} weddingDate={userData.profile?.weddingDate} activities={activities} onInvite={() => {}} onEditBudget={() => { setTempBudget(formatCurrencyInput(userData.budgetLimit)); setIsBudgetModalOpen(true); }} onOpenGuests={() => setIsGuestModalOpen(true)} />}
                        {subTab === 'tasks' && <PlannerTasks tasks={tasks} onAddTask={onAddTask} onToggleTask={onToggleTask} onDeleteTask={onDeleteTask} />}
                        {subTab === 'budget' && <PlannerBudget tasks={tasks} onAddExpense={onAddTask} />}
                        {subTab === 'guests' && <PlannerGuests guests={guests} onAddGuest={onAddGuest} onDeleteGuest={onDeleteGuest} />}
                    </div>

                    <Modal isOpen={isBudgetModalOpen} onClose={() => setIsBudgetModalOpen(false)} title="Ngân sách dự kiến"><div className="space-y-6 pt-4 text-stone-700 text-left"><input type="text" value={tempBudget} onChange={(e) => setTempBudget(formatCurrencyInput(e.target.value))} className="w-full p-4 bg-white border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-400 font-bold text-lg text-stone-800 shadow-sm" placeholder="0" /><button onClick={async () => { const nb = parseCurrencyInput(tempBudget); if (nb > 0) { await updateWedding('budgetLimit', nb); setIsBudgetModalOpen(false); } }} className="w-full py-4 bg-stone-500 text-white rounded-full font-black uppercase text-xs shadow-lg hover:bg-stone-600 transition-all font-bold active:scale-95">Cập nhật</button></div></Modal>
                    <Modal isOpen={isGuestModalOpen} onClose={() => setIsGuestModalOpen(false)} title="Khách mời"><PlannerGuests guests={guests} onAddGuest={onAddGuest} onDeleteGuest={onDeleteGuest} /></Modal>
                </div>
            );
        };

        // --- 5. TOP LEVEL CONTAINER ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('home');
            const [scrolled, setScrolled] = useState(false);
            const [showLogin, setShowLogin] = useState(false);
            const [showRegister, setShowRegister] = useState(false);
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [user, setUser] = useState(null);
            const [notifications, setNotifications] = useState([]);
            const [showNotifications, setShowNotifications] = useState(false);
            const firebase = useFirebase();
            const notificationRef = useRef(null);

            useEffect(() => {
                const handleScroll = () => setScrolled(window.scrollY > 20);
                window.addEventListener('scroll', handleScroll);
                return () => window.removeEventListener('scroll', handleScroll);
            }, []);

            useEffect(() => {
                if (firebase) return firebase.onAuthStateChanged(firebase.auth, (u) => { setUser(u); if (u) { setShowLogin(false); setShowRegister(false); } });
            }, [firebase]);

            useEffect(() => {
                const handleClickOutside = (e) => { if (notificationRef.current && !notificationRef.current.contains(e.target)) setShowNotifications(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            useEffect(() => {
                if (firebase && user) {
                    const { db, doc, onSnapshot } = firebase;
                    onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'main'), (pSnap) => {
                        if (pSnap.exists() && pSnap.data().weddingId) {
                            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'weddings', pSnap.data().weddingId), (wSnap) => {
                                if (wSnap.exists()) setNotifications(wSnap.data().activities || []);
                            });
                        }
                    });
                }
            }, [firebase, user]);

            const navigateTo = (tab) => { 
                if (tab !== 'home' && !user) { setShowLogin(true); return; } 
                setActiveTab(tab); 
                setIsMobileMenuOpen(false);
                window.scrollTo({ top: 0, behavior: 'smooth' }); 
            };
            
            const handleGoogleLogin = async () => {
                const { auth, db, GoogleAuthProvider, signInWithPopup, doc, getDoc, setDoc } = firebase;
                try {
                    const result = await signInWithPopup(auth, new GoogleAuthProvider());
                    const profileRef = doc(db, 'artifacts', appId, 'users', result.user.uid, 'profile', 'main');
                    if (!(await getDoc(profileRef)).exists()) await setDoc(profileRef, { email: result.user.email, name: result.user.displayName, weddingId: null, isSetupComplete: false });
                    setActiveTab('planner');
                } catch (e) { alert("Lỗi đăng nhập Google"); }
            };

            return (
                <div className="min-h-screen">
                    <div className="fixed top-4 md:top-6 left-0 w-full z-50 flex justify-center px-4 transition-all duration-500">
                        <nav className={`flex items-center justify-between px-5 py-2 md:px-6 md:py-2.5 rounded-full transition-all duration-500 ${scrolled ? 'w-full max-w-5xl bg-white/75 backdrop-blur-2xl border border-white/20 shadow-lg' : 'w-full max-w-6xl bg-white/40 backdrop-blur-md border border-white/10'}`}>
                            <div className="flex items-center gap-2 cursor-pointer group" onClick={() => navigateTo('home')}><div className="w-8 h-8 bg-stone-500 text-white rounded-full flex items-center justify-center group-hover:scale-110 transition-transform shadow-sm"><Icons.Heart size={16} fill="currentColor" /></div><span className="text-base md:text-lg font-black tracking-tighter uppercase text-stone-600 font-bold">Weddy</span></div>
                            <div className="hidden md:flex items-center gap-1 font-bold uppercase">{[{ id: 'home', label: 'Trang chủ' }, { id: 'planner', label: 'Planner' }, { id: 'invitation', label: 'Thiệp mời' }, { id: 'vendors', label: 'Dịch vụ' }].map((item) => (<button key={item.id} onClick={() => navigateTo(item.id)} className={`text-[10px] px-5 py-2.5 rounded-full transition-all ${activeTab === item.id ? 'bg-stone-500 text-white shadow-lg' : 'text-stone-400 hover:text-stone-700 hover:bg-white/50'}`}>{item.label}</button>))}</div>
                            <div className="flex items-center gap-2 md:gap-3">
                                {user && <span className="hidden lg:block text-[9px] font-black uppercase tracking-[0.2em] text-stone-400 mr-2 truncate max-w-[120px] font-bold">{user.displayName || user.email}</span>}
                                {user && (
                                    <div className="relative" ref={notificationRef}>
                                        <button onClick={() => setShowNotifications(!showNotifications)} className="w-9 h-9 md:w-10 md:h-10 bg-white/80 backdrop-blur-sm rounded-full flex items-center justify-center text-stone-300 hover:text-stone-600 border border-stone-100 shadow-sm transition-colors relative"><Icons.Bell size={18} />{notifications.length > 0 && (<span className="absolute top-2.5 right-2.5 w-1.5 h-1.5 bg-rose-400 rounded-full border border-white"></span>)}</button>
                                        {showNotifications && (
                                            <div className="absolute right-0 mt-3 w-[280px] md:w-80 bg-white/95 backdrop-blur-xl rounded-[2.5rem] shadow-2xl border border-stone-100 py-6 animate-in zoom-in-95 origin-top-right overflow-hidden z-[60]">
                                                <div className="px-6 mb-4 flex justify-between items-center text-stone-700 font-bold uppercase"><h4 className="text-[10px] md:text-xs">Thông báo</h4><span className="text-[9px] text-stone-300">{notifications.length} mới</span></div>
                                                <div className="max-h-96 overflow-y-auto hide-scrollbar px-2 text-stone-600">
                                                    {notifications.length > 0 ? notifications.map((n, i) => (
                                                        <div key={i} className="p-4 rounded-2xl hover:bg-stone-50 transition-colors flex gap-4 items-start cursor-pointer group text-left"><div className="w-8 h-8 bg-stone-100 rounded-xl flex items-center justify-center shrink-0 shadow-sm"><Icons.Heart size={14} className="text-stone-300" /></div><div className="flex-1"><p className="text-xs font-bold leading-snug">{n.text}</p><p className="text-[9px] font-bold text-stone-400 uppercase mt-1">{n.time}</p></div></div>
                                                    )) : <div className="py-10 text-center text-stone-300 text-xs italic font-bold">Không có thông báo mới</div>}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                )}
                                {user ? <button onClick={() => firebase.signOut(firebase.auth)} className="hidden sm:block px-5 py-2 md:px-6 md:py-2.5 bg-white border border-stone-200 text-stone-500 rounded-full text-[10px] font-black uppercase shadow-sm active:scale-95 font-bold">Đăng xuất</button> : <button onClick={() => setShowLogin(true)} className="px-5 py-2 md:px-6 md:py-2.5 bg-stone-500 text-white rounded-full text-[10px] font-black uppercase shadow-xl active:scale-95 font-bold">Đăng nhập</button>}
                                <button onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)} className="md:hidden w-9 h-9 flex items-center justify-center text-stone-500 bg-white/80 rounded-full border border-stone-100 shadow-sm"><Icons.Menu size={20} /></button>
                            </div>
                        </nav>
                        {isMobileMenuOpen && (
                            <div className="absolute top-16 left-4 right-4 bg-white/95 backdrop-blur-xl rounded-[2.5rem] border border-stone-100 shadow-2xl p-6 md:hidden animate-in slide-in-from-top-4 flex flex-col gap-2 uppercase font-bold">
                                {[{ id: 'home', label: 'Trang chủ' }, { id: 'planner', label: 'Planner' }, { id: 'invitation', label: 'Thiệp mời' }, { id: 'vendors', label: 'Dịch vụ' }].map((item) => (
                                    <button key={item.id} onClick={() => navigateTo(item.id)} className={`w-full py-4 text-[10px] tracking-[0.25em] rounded-2xl transition-all ${activeTab === item.id ? 'bg-stone-500 text-white shadow-lg' : 'text-stone-400 hover:bg-stone-50'}`}>{item.label}</button>
                                ))}
                            </div>
                        )}
                    </div>

                    <main>
                        {activeTab === 'home' && <HomeView onNavigate={navigateTo} />}
                        {activeTab === 'planner' && (user ? <FullPlannerApp currentUser={user} /> : <div className="h-screen flex flex-col gap-4 items-center justify-center text-stone-400 p-6 text-center animate-in"><Icons.Users size={48} className="opacity-10" /><p className="font-medium text-sm text-stone-300 font-bold">Đăng nhập để xem Planner của bạn.</p><button onClick={() => setShowLogin(true)} className="px-8 py-3 bg-stone-500 text-white rounded-full text-xs font-bold uppercase shadow-lg">Đăng nhập ngay</button></div>)}
                    </main>

                    <Modal isOpen={showLogin} onClose={() => setShowLogin(false)} title="Đăng nhập">
                        <div className="space-y-6 pt-2">
                            <div className="space-y-4">
                                <input type="email" placeholder="Email" className="w-full p-4 bg-white border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-400 text-sm shadow-sm font-medium" />
                                <input type="password" placeholder="Mật khẩu" className="w-full p-4 bg-white border border-stone-200 rounded-2xl focus:outline-none focus:border-stone-400 text-sm shadow-sm font-medium" />
                                <button className="w-full py-4 bg-stone-600 text-white rounded-full font-black uppercase text-xs shadow-lg font-bold active:scale-95 transition-all">Vào hệ thống</button>
                            </div>
                            <div className="relative flex py-2 items-center"><div className="flex-grow border-t border-stone-100"></div><span className="flex-shrink-0 mx-4 text-stone-300 text-[10px] font-bold uppercase">Hoặc</span><div className="flex-grow border-t border-stone-100"></div></div>
                            <button onClick={handleGoogleLogin} className="w-full py-4 bg-white border border-stone-200 text-stone-600 rounded-full text-[10px] font-black uppercase flex items-center justify-center gap-3 shadow-md hover:bg-stone-50 active:scale-95 transition-all font-bold">
                                <svg className="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                                ĐĂNG NHẬP BẰNG GOOGLE
                            </button>
                            <div className="text-center"><button onClick={()=>{setShowLogin(false); setShowRegister(true);}} className="text-xs font-bold text-stone-400 hover:text-stone-700 transition-colors uppercase font-bold">Chưa có tài khoản? Đăng ký</button></div>
                        </div>
                    </Modal>

                    <Modal isOpen={showRegister} onClose={() => setShowRegister(false)} title="Đăng ký">
                        <div className="space-y-4 pt-2"><input type="email" placeholder="Email" className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm font-medium shadow-sm" /><input type="password" placeholder="Mật khẩu" className="w-full p-4 bg-white border border-stone-200 rounded-2xl text-sm font-medium shadow-sm" /><button className="w-full py-4 bg-stone-500 text-white rounded-full font-black uppercase text-xs shadow-lg font-bold">Đăng ký ngay</button></div>
                    </Modal>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
